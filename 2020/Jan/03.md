Jan 3rd 2020

Before I start off the day, I'm going to note down the different
possibilities that I have created for myself based on my learnings
yesterday. I noted this down yesterday night, in my diary. Gonna
just put it here

So, I worked on webhooks yesterday, learned quite some stuff. Now what
can I do with this knowledge?

- Write a blog post talking about how to write a webhook to add a
sidecar proxy. How to run the webhook in local with minikube and test
it and debug it too

- Contribute to Open Source projects that use webhooks, like Linkerd
https://linkerd.io/2/features/proxy-injection/ , Istio 
https://istio.io/docs/reference/commands/sidecar-injector/ and more
similar projects, and projects that have a use case for webhooks and
use them

I also worked a bit on Kong yesterday. I'm still learning things. Once
I make things work - golang plugins with Kong, I can do the following

- Write a blog post on how to run demo golang plugins with Kong v2

- Write a blog post on some intricate details if I can - after learning
more about how go-pluginserver github.com/kong/go-pluginserver works.
For example I remember reading some lua code - "ffi" and all. From
my previous knowledge, I know ffi means Foreign Function Invocation.
I could read more on it, check the code, understand stuff and write
a blog post too based on those learnings

- Contribute to Kong project. There are different ways I can try
contributing. One is - I know I have seen multiple error messages,
I just wish some of them were more explicit - like the socket file
not found. If only it said where it was looking for the socket file,
it would have been really easy. Since no docs are there, I had to look
at code. Also, even if docs are there, if the error message is a bit
explicit, it's easier to understand where it's expecting the file to be
at. May be I can raise a proposal asking if we can show better error
messages and if it makes sense. 

Next thing could be, I can learn about how Kong plugins work, and how
to write one in golang and how to build it, how to run it in local, how
to debug it and more. Debugging can be a new a thing to learn as I see
that the output of these golang plugins are `.so` files, not binaries
and they are called by another program, I think the `go-pluginserver`.
And for running in local, if we run kong in Docker, and have the
golang plugin locally in IDE or something, then we need to see how
to mount the golang plugin as a directory inside Docker. And may be
simply hack and see if `go-pluginserver` can also be run locally,
may be by mounting the plugin socket file in Docker, so Kong can
access, then just Kong and DB will be in docker. May be that will be
more helpful when contributing to `go-pluginserver` :D Kong can also
be easily run locally I think. I'm just trying out Docker. Also, I
don't know how easy it will be kill a local postgres db completely and
get another very easily, not very tough, but surely not as easy as
docker ;) So, for now I think I'll stick to Kong and DB in docker

So, let's start some hacking now.

Open Source Stuff 1:

Copy pasting my yesterday's goal which is not complete yet :P - today
too I'm going to continue on making Kong work with the golang plugins
that I have

I stopped with an error yesterday. I'm going to look into it. The error
was this -

```
2020/01/02 03:43:28 [error] 476#0: [kong] go.lua:456 calling GetPluginInfo: failed to open plugin go-hello: plugin.Open("/root/golang-plugins/go-hello"): plugin was built with a different version of package github.com/Kong/go-pdk/bridge
nginx: [error] [kong] go.lua:456 calling GetPluginInfo: failed to open plugin go-hello: plugin.Open("/root/golang-plugins/go-hello"): plugin was built with a different version of package github.com/Kong/go-pdk/bridge
2020/01/02 03:43:29 [notice] 476#0: [kong] iam-ecs-credentials.lua:31 No ECS environment variables found for IAM
2020/01/02 03:43:29 [error] 476#0: init_by_lua error: /usr/local/share/lua/5.1/kong/init.lua:430: error loading plugin schemas: on plugin 'go-hello': go-hello plugin is enabled but not installed;
not yet
stack traceback:
        [C]: in function 'assert'
        /usr/local/share/lua/5.1/kong/init.lua:430: in function 'init'
        init_by_lua:3: in main chunk
nginx: [error] init_by_lua error: /usr/local/share/lua/5.1/kong/init.lua:430: error loading plugin schemas: on plugin 'go-hello': go-hello plugin is enabled but not installed;
not yet
stack traceback:
        [C]: in function 'assert'
        /usr/local/share/lua/5.1/kong/init.lua:430: in function 'init'
        init_by_lua:3: in main chunk
```

I need to understand who throws this error, that is, the origin. I can
see that this is the line where the error occurs -

https://github.com/Kong/go-pluginserver/blob/21590e99d66a24accdfa3a228d264124a2795da3/pluginserver.go#L113

I want to understand what happened here. So, that's exactly what I'm
going to do

Okay, so I digged into the code, I can see multiple usages of
`github.com/Kong/go-pdk` packages in the import statements and they are
being used in the code. I just get my head around where and how the
error exactly occurred. I can also see some functions that have no
usages in the golang code, I need to understand more on how the plugin
server works, to understand what's going on. But one thing is clear,
I need to use the same version of the package `github.com/Kong/go-pdk`
that's present in the Docker image's `go-pluginserver`, while building
my golang plugin. Unfortunately, in the `go-pluginserver`, I don't see
any package management system like go modules or dep. So, I can't
really say what version of `github.com/Kong/go-pdk` was used at any
point in time. At least, that's my guess. Now to check anything, I
first have to see how the docker image v2 rc1 was built - and check
if I can get any version. I think that's a struggle, or I can just
build `go-pluginserver` locally - I put go modules and know which
version is being used, and I can use the same version in my plugin
and then run `go-pluginserver` in my local, which is far more easier,
I guess. I'll take a break and do that next ;)

---

Okay, so my break turned out to be a big one :P Breakfast, talking
to folks, then my day job started with standup and I'm gonna start
working on my company project

Blog learnings 1:

https://snyk.io/blog/why-npm-lockfiles-can-be-a-security-blindspot-for-injecting-malicious-modules/

The above blog is really cool. It talks about how a malicious
package can be inserted in your JS package lock file in a PR
and you won't even know it! It's because GitHub folds all the
big diffs. Also, it's not easy to manually check all the diffs
and see if something fishy is there. The author recommends using
automated lint checks on the lock files

I wonder if something similar is needed for other languages. It's a
good idea to work on for open source. First we need to check if there
are existing tools that help with this for particular languages, then
work on something new if it's not present, or else, if it's already
present, then we could contribute to it too :)

Open Source Stuff 2:

I'm going to continue on the Kong golang plugin. I'm going to try to
run `go-pluginserver` in my local, and have the socket file be mounted
so that both the plugin server and kong can use it. I have to see if it
will work

Another thing to do is, build `go-pluginserver` and then move it inside
docker container. But I'll go with running in local now. Sounds easy
peasy ;)

I stopped the kong container and removed it. I started it again with
the following commands

```
$ mkdir ~/kong-docker
$ mkdir ~/golang-plugins
```

```
$ cd go-pluginserver
$ # build plugin server
$ make
$ # move binary to PATH environment variable
$ mv go-pluginserver ~/go/bin
$ # run it
$ go-pluginserver -socket ~/kong-docker/go_pluginserver.sock
```

```
$ docker run -it --name kong \
    --link kong-database:kong-database \
    -v /Users/karuppiahn/golang-plugins:/root/golang-plugins \
    -v /Users/karuppiahn/kong-docker/go_pluginserver.sock:/usr/local/kong/go_pluginserver.sock \
    -e "KONG_DATABASE=postgres" \
    -e "KONG_PG_HOST=kong-database" \
    -e "KONG_CASSANDRA_CONTACT_POINTS=kong-database" \
    -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \
    -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \
    -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \
    -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \
    -e "KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl" \
    -p 8000:8000 \
    -p 8443:8443 \
    -p 8001:8001 \
    -p 8444:8444 \
    kong:2.0.0rc1-ubuntu bash
```

```
$ cd go-plugins
$ make
$ mv *.so ~/go-plugins
```

```
$ apt update
$ apt install vim
$ mv /etc/kong/kong.conf.default /etc/kong/kong.conf
$ vi /etc/kong.conf
$ # change plugins to use bundled and go-hello
$ # change plugin directory to my host home direcory
$ # as that's where my plugin server is running.
```

Now I'm getting this error while starting it

```
$ /docker-entrypoint.sh kong docker-start
2020/01/03 16:53:20 [error] 430#0: [kong] init.lua:421 failure connecting to go plugin server socket: connect failure: Connection refused
nginx: [error] [kong] init.lua:421 failure connecting to go plugin server socket: connect failure: Connection refused
2020/01/03 16:53:20 [error] 430#0: init_by_lua error: /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: connect failure: Connection refused
stack traceback:
        [C]: in function 'assert'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: in function 'rpc_call'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:231: in function 'set_plugin_dir'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:453: in function 'get_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:492: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:150: in function 'load_plugin_handler'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:223: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:270: in function 'load_plugin_schemas'
        /usr/local/share/lua/5.1/kong/init.lua:430: in function 'init'
        init_by_lua:3: in main chunk
nginx: [error] init_by_lua error: /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: connect failure: Connection refused
stack traceback:
        [C]: in function 'assert'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: in function 'rpc_call'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:231: in function 'set_plugin_dir'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:453: in function 'get_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:492: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:150: in function 'load_plugin_handler'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:223: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:270: in function 'load_plugin_schemas'
        /usr/local/share/lua/5.1/kong/init.lua:430: in function 'init'
        init_by_lua:3: in main chunk
```

I'm guessing that running pluginserver inside the docker container
might be the way to go. Not sure why the connection got refused. May be
because of the way the socket is handled in Linux, vs what's being
used in MacOs. We didn't get this error message before. I think it will
go away once we run it inside :D , this time with proper
`github.com/Kong/pdk` package version. ðŸ˜Ž


```
$ cd go-plugins
$ docker run --rm -it -v $(pwd):/go-plugins golang bash
$ cd /go-plugins
$ make
$ exit
```

```
$ cd go-pluginserver
$ docker run --rm -it -v $(pwd):/go-pluginserver golang bash
$ cd /go-plugins
$ make
$ exit
```

```
docker run -it --name kong \
    --link kong-database:kong-database \
    -e "KONG_DATABASE=postgres" \
    -e "KONG_PG_HOST=kong-database" \
    -e "KONG_CASSANDRA_CONTACT_POINTS=kong-database" \
    -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \
    -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \
    -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \
    -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \
    -e "KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl" \
    -p 8000:8000 \
    -p 8443:8443 \
    -p 8001:8001 \
    -p 8444:8444 \
    kong:2.0.0rc1-ubuntu bash
$ mkdir /root/golang-plugins
```

```
$ cd go-pluginserver
$ docker cp go-pluginserver kong:/usr/local/bin/go-pluginserver
```

```
$ cd go-plugins
$ docker cp go-hello.so kong:/root/golang-plugins
```

```
$ docker exec -it kong bash
$ mv /etc/kong/kong.conf.default /etc/kong/kong.conf
$ apt update
$ apt install vim -y
$ vi /etc/kong/kong.conf
...
...
plugins = bundled,go-hello
go_plugins_dir = /root/golang-plugins
...
...
$ cd /usr/local/kong
$ go-pluginserver -socket go_pluginserver.sock
```

```
$ docker exec -it kong bash
$ /docker-entrypoint.sh kong docker-start
2020/01/03 17:27:03 [notice] 467#0: [kong] iam-ecs-credentials.lua:31 No ECS environment variables found for IAM
2020/01/03 17:27:03 [notice] 467#0: using the "epoll" event method
2020/01/03 17:27:03 [notice] 467#0: openresty/1.15.8.2
2020/01/03 17:27:03 [notice] 467#0: built by gcc 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.12)
2020/01/03 17:27:03 [notice] 467#0: OS: Linux 4.9.184-linuxkit
2020/01/03 17:27:03 [notice] 467#0: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2020/01/03 17:27:03 [notice] 467#0: start worker processes
2020/01/03 17:27:03 [notice] 467#0: start worker process 488
2020/01/03 17:27:03 [notice] 467#0: start worker process 489
2020/01/03 17:27:03 [notice] 467#0: start worker process 490
2020/01/03 17:27:03 [notice] 467#0: start worker process 491
2020/01/03 17:27:03 [warn] 491#0: *2 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.001 seconds), context: init_worker_by_lua*
2020/01/03 17:27:03 [warn] 491#0: *2 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.002 seconds), context: init_worker_by_lua*
2020/01/03 17:27:03 [warn] 491#0: *2 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.004 seconds), context: init_worker_by_lua*
2020/01/03 17:27:03 [notice] 488#0: *3 [lua] cache_warmup.lua:45: cache_warmup_single_entity(): Preloading 'services' into the cache ..., context: init_worker_by_lua*
2020/01/03 17:27:03 [notice] 488#0: *3 [lua] cache_warmup.lua:84: cache_warmup_single_entity(): finished preloading 'services' into the cache (in 0ms), context: init_worker_by_lua*
2020/01/03 17:27:03 [notice] 488#0: *3 [lua] cache_warmup.lua:45: cache_warmup_single_entity(): Preloading 'plugins' into the cache ..., context: init_worker_by_lua*
2020/01/03 17:27:03 [notice] 488#0: *3 [lua] cache_warmup.lua:84: cache_warmup_single_entity(): finished preloading 'plugins' into the cache (in 0ms), context: init_worker_by_lua*

```

Wow. Something's running!!! Let me try to hit it with some requests!

Also, I was using tmux, and I resized the pane in which the above kong
command was running and I saw these messages

```
2020/01/03 17:27:47 [notice] 491#0: signal 28 (SIGWINCH) received
2020/01/03 17:27:47 [notice] 489#0: signal 28 (SIGWINCH) received
2020/01/03 17:27:47 [notice] 490#0: signal 28 (SIGWINCH) received
2020/01/03 17:27:47 [notice] 488#0: signal 28 (SIGWINCH) received
2020/01/03 17:27:47 [notice] 467#0: signal 28 (SIGWINCH) received

2020/01/03 17:28:34 [notice] 489#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:34 [notice] 490#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:34 [notice] 491#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:34 [notice] 488#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:34 [notice] 467#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:36 [notice] 491#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:36 [notice] 489#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:36 [notice] 490#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:36 [notice] 488#0: signal 28 (SIGWINCH) received
2020/01/03 17:28:36 [notice] 467#0: signal 28 (SIGWINCH) received
```

Apparently, SIGWINCH means SIG - signal, WIN - window, CH - change.
That was new :P https://en.wikipedia.org/wiki/Signal_(IPC)#POSIX_signals

Now, back to Kong. Let me see if that `go-hello` plugin works

```
$ curl -i localhost:8000
HTTP/1.1 404 Not Found
Date: Fri, 03 Jan 2020 17:32:17 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Content-Length: 48
X-Kong-Response-Latency: 1
Server: kong/2.0.0rc1

{"message":"no Route matched with those values"}
```

So, the response does not have any new headers. I think I kinda
expected this. I have the plugin yes, I have installed it, enabled
it, but I didn't enable it on any route in the Kong routes. Let me
see if I can add a global plugin, and make it work even for 404s, or
I could add a dummy route, to google.com may be and add the plugin to
it using the admin API

But I can see the plugin enabled here

```
$ curl -i localhost:8001

HTTP/1.1 200 OK
Date: Fri, 03 Jan 2020 17:34:39 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Access-Control-Allow-Origin: *
Server: kong/2.0.0rc1
Content-Length: 7526
X-Kong-Admin-Latency: 1

{"plugins":{"enabled_in_cluster":[],"available_on_server":{"go-hello":true,"correlation-id":true,"pre-function":true,"cors":true,"ldap-auth":true,"loggly":true,"hmac-auth":true,"zipkin":true,"request-size-limiting":true,"azure-functions":true,"request-transformer":true,"oauth2":true,"response-transformer":true,"ip-restriction":true,"statsd":true,"jwt":true,"proxy-cache":true,"basic-auth":true,"key-auth":true,"http-log":true,"datadog":true,"tcp-log":true,"post-function":true,"prometheus":true,"acl":true,"syslog":true,"file-log":true,"session":true,"udp-log":true,"response-ratelimiting":true,"aws-lambda":true,"bot-detection":true,"rate-limiting":true,"request-termination":true}},"tagline":"Welcome to kong","configuration":{"plugins":["bundled","go-hello"],"role":"traditional","admin_ssl_enabled":true,"proxy_access_log":"\/dev\/stdout","trusted_ips":{},"prefix":"\/usr\/local\/kong","loaded_plugins":{"go-hello":true,"correlation-id":true,"pre-function":true,"cors":true,"ldap-auth":true,"loggly":true,"hmac-auth":true,"zipkin":true,"bot-detection":true,"azure-functions":true,"request-transformer":true,"oauth2":true,"response-transformer":true,"syslog":true,"statsd":true,"jwt":true,"proxy-cache":true,"basic-auth":true,"key-auth":true,"http-log":true,"datadog":true,"tcp-log":true,"post-function":true,"session":true,"acl":true,"rate-limiting":true,"ip-restriction":true,"file-log":true,"udp-log":true,"response-ratelimiting":true,"aws-lambda":true,"prometheus":true,"request-size-limiting":true,"request-termination":true},"cassandra_username":"kong","ssl_cert_key":"\/usr\/local\/kong\/ssl\/kong-default.key","admin_ssl_cert_key":"\/usr\/local\/kong\/ssl\/admin-kong-default.key","dns_resolver":{},"pg_user":"kong","mem_cache_size":"128m","ssl_ciphers":"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384","nginx_admin_directives":{},"nginx_http_upstream_directives":[{"value":"60s","name":"keepalive_timeout"},{"value":"100","name":"keepalive_requests"},{"value":"60","name":"keepalive"}],"nginx_http_directives":[{"value":"off","name":"ssl_prefer_server_ciphers"},{"value":"TLSv1.2 TLSv1.3","name":"ssl_protocols"},{"value":"on","name":"ssl_session_tickets"},{"value":"1d","name":"ssl_session_timeout"},{"value":"prometheus_metrics 5m","name":"lua_shared_dict"}],"pg_host":"kong-database","nginx_acc_logs":"\/usr\/local\/kong\/logs\/access.log","pg_semaphore_timeout":60000,"proxy_listen":["0.0.0.0:8000 reuseport backlog=16384","0.0.0.0:8443 http2 ssl reuseport backlog=16384"],"client_max_body_size":"0","router_update_frequency":1,"client_ssl_cert_default":"\/usr\/local\/kong\/ssl\/kong-default.crt","cassandra_ssl":false,"go_plugins_dir":"\/root\/golang-plugins","dns_no_sync":false,"db_update_propagation":0,"db_update_frequency":5,"stream_listen":["off"],"nginx_err_logs":"\/usr\/local\/kong\/logs\/error.log","ssl_cert_key_default":"\/usr\/local\/kong\/ssl\/kong-default.key","cassandra_port":9042,"dns_order":["LAST","SRV","A","CNAME"],"dns_error_ttl":1,"headers":["server_tokens","latency_tokens"],"lua_ssl_verify_depth":1,"nginx_optimizations":true,"status_listen":["off"],"dns_stale_ttl":4,"cluster_control_plane":"127.0.0.1:8005","nginx_http_upstream_keepalive_timeout":"60s","ssl_cert_csr_default":"\/usr\/local\/kong\/ssl\/kong-default.csr","pg_timeout":5000,"admin_ssl_cert_default":"\/usr\/local\/kong\/ssl\/admin-kong-default.crt","nginx_http_upstream_keepalive_requests":"100","database":"postgres","nginx_http_ssl_prefer_server_ciphers":"off","client_ssl":false,"stream_listeners":{},"pg_database":"kong","nginx_worker_processes":"auto","anonymous_reports":true,"lua_package_cpath":"","cassandra_repl_factor":1,"admin_acc_logs":"\/usr\/local\/kong\/logs\/admin_access.log","nginx_proxy_directives":{},"cassandra_refresh_frequency":60,"lua_package_path":".\/?.lua;.\/?\/init.lua;","nginx_pid":"\/usr\/local\/kong\/pids\/nginx.pid","upstream_keepalive":60,"nginx_daemon":"off","ssl_cipher_suite":"intermediate","pg_ssl_verify":false,"nginx_http_status_directives":{},"admin_access_log":"\/dev\/stdout","pg_max_concurrent_queries":0,"nginx_stream_directives":{},"proxy_listeners":[{"listener":"0.0.0.0:8000 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":false,"ip":"0.0.0.0","backlog=16384":true,"http2":false,"port":8000,"bind":false},{"listener":"0.0.0.0:8443 ssl http2 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":true,"ip":"0.0.0.0","backlog=16384":true,"http2":true,"port":8443,"bind":false}],"proxy_ssl_enabled":true,"nginx_http_upstream_keepalive":"60","db_cache_warmup_entities":["services","plugins"],"enabled_headers":{"latency_tokens":true,"X-Kong-Response-Latency":true,"Server":true,"X-Kong-Admin-Latency":true,"X-Kong-Upstream-Status":false,"Via":true,"X-Kong-Proxy-Latency":true,"server_tokens":true,"X-Kong-Upstream-Latency":true},"nginx_http_ssl_protocols":"TLSv1.2 TLSv1.3","cassandra_lb_policy":"RequestRoundRobin","db_resurrect_ttl":30,"cassandra_timeout":5000,"cassandra_consistency":"ONE","db_cache_ttl":0,"admin_error_log":"\/dev\/stderr","status_listeners":{},"dns_not_found_ttl":30,"nginx_http_ssl_session_tickets":"on","cassandra_data_centers":["dc1:2","dc2:3"],"status_access_log":"off","cluster_listeners":[{"listener":"0.0.0.0:8005","proxy_protocol":false,"reuseport":false,"backlog=%d+":false,"deferred":false,"ssl":false,"ip":"0.0.0.0","port":8005,"http2":false,"bind":false}],"status_error_log":"logs\/status_error.log","kong_env":"\/usr\/local\/kong\/.kong_env","error_default_type":"text\/plain","log_level":"notice","nginx_kong_conf":"\/usr\/local\/kong\/nginx-kong.conf","cassandra_schema_consensus_timeout":10000,"dns_hostsfile":"\/etc\/hosts","admin_listeners":[{"listener":"0.0.0.0:8001","proxy_protocol":false,"reuseport":false,"backlog=%d+":false,"deferred":false,"ssl":false,"ip":"0.0.0.0","port":8001,"http2":false,"bind":false},{"listener":"0.0.0.0:8444 ssl","proxy_protocol":false,"reuseport":false,"backlog=%d+":false,"deferred":false,"ssl":true,"ip":"0.0.0.0","port":8444,"http2":false,"bind":false}],"real_ip_header":"X-Real-IP","ssl_cert":"\/usr\/local\/kong\/ssl\/kong-default.crt","pg_ssl":false,"admin_ssl_cert_key_default":"\/usr\/local\/kong\/ssl\/admin-kong-default.key","cassandra_ssl_verify":false,"cluster_listen":["0.0.0.0:8005"],"cassandra_repl_strategy":"SimpleStrategy","real_ip_recursive":"off","proxy_error_log":"\/dev\/stderr","client_ssl_cert_key_default":"\/usr\/local\/kong\/ssl\/kong-default.key","admin_ssl_cert":"\/usr\/local\/kong\/ssl\/admin-kong-default.crt","router_consistency":"strict","lua_socket_pool_size":30,"nginx_sproxy_directives":{},"pg_port":5432,"cassandra_contact_points":["kong-database"],"client_body_buffer_size":"8k","ssl_preread_enabled":true,"nginx_conf":"\/usr\/local\/kong\/nginx.conf","nginx_kong_stream_conf":"\/usr\/local\/kong\/nginx-kong-stream.conf","cassandra_keyspace":"kong","ssl_cert_default":"\/usr\/local\/kong\/ssl\/kong-default.crt","nginx_http_ssl_session_timeout":"1d","admin_listen":["0.0.0.0:8001","0.0.0.0:8444 ssl"]},"version":"2.0.0rc1","node_id":"54e48841-2fc4-4279-b66b-c5e09fe8dda2","lua_version":"LuaJIT 2.1.0-beta3","prng_seeds":{"pid: 488":124871101703,"pid: 491":135168144243,"pid: 490":115161518910,"pid: 489":140944720660,"pid: 467":129190250717},"timers":{"pending":6,"running":0},"hostname":"80d85237534e"}
```

Now, the unforuntate part is, the docs.konghq.com has info only about
kong v1, I'm not sure how kong v2 has changed. Let me see if any of the
admin APIs of kong v1 works!

I'm checking this - http://docs.konghq.com/1.4.x/admin-api/

Okay, I'm able to list the services using 

```
$ curl localhost:8001/services
{"next":null,"data":[]}
```

Let's create one service. I think except the host, everything is
optional. I'm going to give name and host! :)

```
$ curl -X POST localhost:8001/services -d '{ "name": "google", "host": "www.google.com" }'
{"message":"2 schema violations (host: required field missing; { \"name\": \"google\", \"host\": \"www: unknown field)","name":"schema violation","fields":{"host":"required field missing","{ \"name\": \"google\", \"host\": \"www":"unknown field"},"code":2}
```

Okay, that didn't work! Weird part is, I sent the host. For a second,
I was confused, but later I realized I could check sending headers
for json data type and it worked! I think by default it was thinking
about some other data type? form? I don't know

```
$ curl -X POST -H 'Content-Type: application/json' localhost:8001/services -d '{ "name": "google", "h
ost": "www.google.com" }'
{"host":"www.google.com","created_at":1578073208,"connect_timeout":60000,"id":"ec680ec6-ef4e-4bdc-bcfc-fe978253943f","protocol":"http","name":"google","read_timeout":60000,"port":80,"path":null,"updated_at":1578073208,"retries":5,"write_timeout":60000,"tags":null,"client_certificate":null}
```

Now, I can list it too! :D

```
$ curl localhost:8001/services
{"next":null,"data":[{"host":"www.google.com","created_at":1578073208,"connect_timeout":60000,"id":"ec680ec6-ef4e-4bdc-bcfc-fe978253943f","protocol":"http","name":"google","read_timeout":60000,"port":80,"path":null,"updated_at":1578073208,"retries":5,"write_timeout":60000,"tags":null,"client_certificate":null}]}
```

Next, let's create a route! Let me list em first

```
$ curl localhost:8001/routes
{"next":null,"data":[]}
```

Let's create one now

```
$ curl -X POST -H 'Content-Type: application/json' localhost:8001/routes -d '{ "name": "google", "service": {"name": "google"}, "protocols": ["http"], "paths": ["/"] }'
{"id":"cb0da6f3-ff2f-4dfe-a2bc-bffaa598f929","path_handling":"v0","paths":["\/"],"destinations":null,"headers":null,"protocols":["http"],"methods":null,"snis":null,"service":{"id":"ec680ec6-ef4e-4bdc-bcfc-fe978253943f"},"name":"google","strip_path":true,"preserve_host":false,"regex_priority":0,"updated_at":1578073787,"sources":null,"hosts":null,"https_redirect_status_code":426,"tags":null,"created_at":1578073787}
```

It's created now, let's list routes

```
$ curl localhost:8001/routes
{"next":null,"data":[{"id":"cb0da6f3-ff2f-4dfe-a2bc-bffaa598f929","path_handling":"v0","paths":["\/"],"destinations":null,"headers":null,"protocols":["http"],"methods":null,"snis":null,"service":{"id":"ec680ec6-ef4e-4bdc-bcfc-fe978253943f"},"name":"google","strip_path":true,"preserve_host":false,"regex_priority":0,"updated_at":1578073787,"sources":null,"hosts":null,"https_redirect_status_code":426,"tags":null,"created_at":1578073787}]}
```

Now, I'm able to proxy to google by hitting the kong proxy url

```
$ curl -i localhost:8000/
```

Now, let's list the plugins

```
$ curl localhost:8001/plugins
{"next":null,"data":[]}
```

I'm going to add a global plugin now!

```
$ curl -X POST -H 'Content-Type: application/json' localhost:8001/plugins -d '{ "name": "go-hello"}'
{"created_at":1578074015,"config":{"message":null},"id":"8cb061ed-98f8-4c65-926d-4c610481c41d","service":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"go-hello","consumer":null,"route":null,"tags":null}
```

It has been created! Let's check it!

```
$ curl localhost:8001/plugins
{"next":null,"data":[{"created_at":1578074015,"config":{"message":null},"id":"8cb061ed-98f8-4c65-926d-4c610481c41d","service":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"go-hello","consumer":null,"route":null,"tags":null}]}
```

Let's proxy to google again!

```
$ curl -i localhost:8000
HTTP/1.1 500 Internal Server Error
Date: Fri, 03 Jan 2020 17:55:53 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Content-Length: 42
X-Kong-Response-Latency: 1
Server: kong/2.0.0rc1

{"message":"An unexpected error occurred"}
```

Ouch, internal server error

Got these logs in Kong for it

```
"GET /routes HTTP/1.1" 200 439 "-" "curl/7.64.1"
2020/01/03 17:55:35 [crit] 490#0: *28773 connect() to unix:/usr/local/kong/go_pluginserver.sock failed (13: Permission denied), client: 172.17.0.1, server: kong, request: "GET / HTTP/1.1", host: "localhost:8000"
2020/01/03 17:55:35 [error] 490#0: *28773 lua coroutine: runtime error: /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: permission denied
stack traceback:
coroutine 0:
        [C]: in function 'assert'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: in function 'rpc_call'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:418: in function 'get_instance'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:479: in function </usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:478>
coroutine 1:
        [C]: in function 'resume'
        coroutine.wrap:21: in function <coroutine.wrap:21>
        /usr/local/share/lua/5.1/kong/init.lua:680: in function 'access'
        access_by_lua(nginx-kong.conf:98):2: in main chunk, client: 172.17.0.1, server: kong, request: "GET / HTTP/1.1", host: "localhost:8000"
2020/01/03 17:55:35 [error] 490#0: *28773 [kong] init.lua:687 /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:187: permission denied, client: 172.17.0.1, server: kong, request: "GET / HTTP/1.1", host: "localhost:8000"
```

I think I'll go change the file permissions for `go_pluginserver.sock`
file. 

```
$ ls -al go_pluginserver.sock
srwxr-xr-x 1 root root 0 Jan  3 17:26 go_pluginserver.sock
$ chmod 777 go_pluginserver.sock
$ ls -al go_pluginserver.sock
srwxrwxrwx 1 root root 0 Jan  3 17:26 go_pluginserver.sock
```

Let's try to access google again through our proxy!

```
$ curl -i localhost:8000
HTTP/1.1 200 OK
Content-Type: text/html; charset=ISO-8859-1
Transfer-Encoding: chunked
Connection: keep-alive
x-hello-from-go: Go says hello to localhost:8000
Date: Fri, 03 Jan 2020 18:01:22 GMT
Expires: -1
Cache-Control: private, max-age=0
P3P: CP="This is not a P3P policy! See g.co/p3phelp for more info."
Server: gws
X-XSS-Protection: 0
X-Frame-Options: SAMEORIGIN
Set-Cookie: 1P_JAR=2020-01-03-18; expires=Sun, 02-Feb-2020 18:01:22 GMT; path=/; domain=.google.com
Set-Cookie: NID=195=pXyJTXpe9ngth9kaE9_LQusmPKZP1dM-BFLt5I0DN7GUKLz-eAI_p7Wz0r7ljhJfuW7koctQtRizOqub5DW12PMZmwakudAyf2mWSXgZ7S1L2iE_8Sch2NX2xLE-WKiu-x4lDT0Ia2DvwOm5jJ1lM7uRfsv7NvdYbSTnDUKPTEQ; expires=Sat, 04-Jul-2020 18:01:22 GMT; path=/; domain=.google.com; HttpOnly
Accept-Ranges: none
Vary: Accept-Encoding
X-Kong-Upstream-Latency: 64
X-Kong-Proxy-Latency: 10
Via: kong/2.0.0rc1

<!doctype html><html itemscope="" itemtype="http://schema.org/WebPage" lang="en-IN"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type"><meta content="/images/branding/googleg/1x/googleg_standard_color_128dp.png" itemprop="image"><title>Google</title><script nonce="lLvBK6fctJ8MRm/sfCr5mQ==">(function(){window.google={kEI:'coEPXvrUHu6d4-EPpsKQ6A8',kEXPI:'0,1353747,5662,730,224,4726,379,206,2415,540,249,10,713,338,175,364,672,254,50,178,3,205,73,4,60,315,175,232,228,10,325,268,178,1128697,143,1197747,402,38,329080,1294,12383,4855,32691,2075,13173,861,28690,364,3319,5505,8384,4858,1362,4323,4967,774,2256,2814,1074,3968,6196,1719,1808,1976,2044,5762,1,3146,5297,2054,920,873,1217,1336,5933,1720,1,415,1141,7509,2,1782,252,620,2883,21,317,690,2483,975,1,368,2778,519,400,992,1285,9,3762,612,14,1279,2212,202,328,149,1103,841,519,315,1156,48,158,662,3438,260,52,1132,4,3,2063,606,1839,184,544,51,1182,143,377,260,426,1261,747,219,210,1053,94,327,1284,16,84,417,2426,1639,608,473,1339,29,719,1047,3084,135,773,1216,332,41,485,5,728,592,1574,1879,1295,220,1345,3,6510,299,2045,488,258,581,362,679,1042,2458,273,2411,4,842,1228,1864,1275,108,1246,25,1002,582,72,480,404,405,99,2,313,120,1478,118,1160,366,753,132,989,523,358,1158,8,344,85,583,351,4,103,302,1706,10,52,355,63,1158,1669,60,1,115,10,2,16,146,138,442,373,959,497,26,230,778,192,6,15,183,87,5,137,2,430,7,259,85,189,174,700,760,103,40,154,244,944,259,5859137,3214,1802680,4194851,2801171,549,333,444,1,2,80,1,900,896,1,8,1,2,2551,1,748,141,59,736,563,1,4265,1,1,1,1,137,1,802,77,9,164,8,4,2,2,13,2,2,2,2,220,23964287',authuser:0,kscs:'c9c918f0_coEPXvrUHu6d4-EPpsKQ6A8',kGL:'IN',kBL:'v77x'};google.sn='webhp';google.kHL='en-IN';google.jsfs='Ffpdje';})();(function(){google.lc=[];google.li=0;google.getEI=function(a){for(var b;a&&(!a.getAttribute||!(b=a.getAttribute("eid")));)a=a.parentNode;return b||google.kEI};google.getLEI=function(a){for(var b=null;a&&(!a.getAttribute||!(b=a.getAttribute("leid")));)a=a.parentNode;return b};google.https=function(){return"https:"==window.location.protocol};google.ml=function(){return null};google.time=function(){return(new Date).getTime()};google.log=function(a,b,e,c,g){if(a=google.logUrl(a,b,e,c,g)){b=new Image;var d=google.lc,f=google.li;d[f]=b;b.onerror=b.onload=b.onabort=function(){delete d[f]};google.vel&&google.vel.lu&&google.vel.lu(a);b.src=a;google.li=f+1}};google.logUrl=function(a,b,e,c,g){var d="",f=google.ls||"";e||-1!=b.search("&ei=")||(d="&ei="+google.getEI(c),-1==b.search("&lei=")&&(c=google.getLEI(c))&&(d+="&lei="+c));c="";!e&&google.cshid&&-1==b.search("&cshid=")&&"slh"!=a&&(c="&cshid="+google.cshid);a=e||"/"+(g||"gen_204")+"?atyp=i&ct="+a+"&cad="+b+d+f+"&zx="+google.time()+c;/^http:/i.test(a)&&google.https()&&(google.ml(Error("a"),!1,{src:a,glmm:1}),a="");return a};}).call(this);(function(){google.y={};google.x=function(a,b){if(a)var c=a.id;else{do c=Math.random();while(google.y[c])}google.y[c]=[a,b];return!1};google.lm=[];google.plm=function(a){google.lm.push.apply(google.lm,a)};google.lq=[];google.load=function(a,b,c){google.lq.push([[a],b,c])};google.loadAll=function(a,b){google.lq.push([a,b])};}).call(this);google.f={};(function(){document.documentElement.addEventListener("submit",function(b){var a;if(a=b.target){var c=a.getAttribute("data-submitfalse");a="1"==c||"q"==c&&!a.elements.q.value?!0:!1}else a=!1;a&&(b.preventDefault(),b.stopPropagation())},!0);}).call(this);var a=window.location,b=a.href.indexOf("#");if(0<=b){var c=a.href.substring(b+1);/(^|&)q=/.test(c)&&-1==c.indexOf("#")&&a.replace("/search?"+c.replace(/(^|&)fp=[^&]*/g,"")+"&cad=h")};</script><style>#gbar,#guser{font-size:13px;padding-top:1px !important;}#gbar{height:22px}#guser{padding-bottom:7px !important;text-align:right}.gbh,.gbd{border-top:1px solid #c9d7f1;font-size:1px}.gbh{height:0;position:absolute;top:24px;width:100%}@media all{.gb1{height:22px;margin-right:.5em;vertical-align:top}#gbar{float:left}}a.gb1,a.gb4{text-decoration:underline !important}a.gb1,a.gb4{color:#00c !important}.gbi .gb4{color:#dd8e27 !important}.gbf .gb4{color:#900 !important}
</style><style>body,td,a,p,.h{font-family:arial,sans-serif}body{margin:0;overflow-y:scroll}#gog{padding:3px 8px 0}td{line-height:.8em}.gac_m td{line-height:17px}form{margin-bottom:20px}.h{color:#36c}.q{color:#00c}.ts td{padding:0}.ts{border-collapse:collapse}em{font-weight:bold;font-style:normal}.lst{height:25px;width:496px}.gsfi,.lst{font:18px arial,sans-serif}.gsfs{font:17px arial,sans-serif}.ds{display:inline-box;display:inline-block;margin:3px 0 4px;margin-left:4px}input{font-family:inherit}a.gb1,a.gb2,a.gb3,a.gb4{color:#11c !important}body{background:#fff;color:black}a{color:#11c;text-decoration:none}a:hover,a:active{text-decoration:underline}.fl a{color:#36c}a:visited{color:#551a8b}a.gb1,a.gb4{text-decoration:underline}a.gb3:hover{text-decoration:none}#ghead a.gb2:hover{color:#fff !important}.sblc{padding-top:5px}.sblc a{display:block;margin:2px 0;margin-left:13px;font-size:11px}.lsbb{background:#eee;border:solid 1px;border-color:#ccc #999 #999 #ccc;height:30px}.lsbb{display:block}.ftl,#fll a{display:inline-block;margin:0 12px}.lsb{background:url(/images/nav_logo229.png) 0 -261px repeat-x;border:none;color:#000;cursor:pointer;height:30px;margin:0;outline:0;font:15px arial,sans-serif;vertical-align:top}.lsb:active{background:#ccc}.lst:focus{outline:none}</style><script nonce="lLvBK6fctJ8MRm/sfCr5mQ=="></script></head><body bgcolor="#fff"><script nonce="lLvBK6fctJ8MRm/sfCr5mQ==">(function(){var src='/images/nav_logo229.png';var iesg=false;document.body.onload = function(){window.n && window.n();if (document.images){new Image().src=src;}
if (!iesg){document.f&&document.f.q.focus();document.gbqf&&document.gbqf.q.focus();}
}
})();</script><div id="mngb"> <div id=gbar><nobr><b class=gb1>Search</b> <a class=gb1 href="http://www.google.co.in/imghp?hl=en&tab=wi">Images</a> <a class=gb1 href="http://maps.google.co.in/maps?hl=en&tab=wl">Maps</a> <a class=gb1 href="https://play.google.com/?hl=en&tab=w8">Play</a> <a class=gb1 href="http://www.youtube.com/?gl=IN&tab=w1">YouTube</a> <a class=gb1 href="http://news.google.co.in/nwshp?hl=en&tab=wn">News</a> <a class=gb1 href="https://mail.google.com/mail/?tab=wm">Gmail</a> <a class=gb1 href="https://drive.google.com/?tab=wo">Drive</a> <a class=gb1 style="text-decoration:none" href="https://www.google.co.in/intl/en/about/products?tab=wh"><u>More</u> &raquo;</a></nobr></div><div id=guser width=100%><nobr><span id=gbn class=gbi></span><span id=gbf class=gbf></span><span id=gbe></span><a href="http://www.google.co.in/history/optout?hl=en" class=gb4>Web History</a> | <a  href="/preferences?hl=en" class=gb4>Settings</a> | <a target=_top id=gb_70 href="https://accounts.google.com/ServiceLogin?hl=en&passive=true&continue=http://www.google.com/" class=gb4>Sign in</a></nobr></div><div class=gbh style=left:0></div><div class=gbh style=right:0></div> </div><center><br clear="all" id="lgpd"><div id="lga"><img alt="Google" height="92" src="/images/branding/googlelogo/1x/googlelogo_white_background_color_272x92dp.png" style="padding:28px 0 14px" width="272" id="hplogo"><br><br></div><form action="/search" name="f"><table cellpadding="0" cellspacing="0"><tr valign="top"><td width="25%">&nbsp;</td><td align="center" nowrap=""><input name="ie" value="ISO-8859-1" type="hidden"><input value="en-IN" name="hl" type="hidden"><input name="source" type="hidden" value="hp"><input name="biw" type="hidden"><input name="bih" type="hidden"><div class="ds" style="height:32px;margin:4px 0"><input class="lst" style="color:#000;margin:0;padding:5px 8px 0 6px;vertical-align:top" autocomplete="off" value="" title="Google Search" maxlength="2048" name="q" size="57"></div><br style="line-height:0"><span class="ds"><span class="lsbb"><input class="lsb" value="Google Search" name="btnG" type="submit"></span></span><span class="ds"><span class="lsbb"><input class="lsb" id="tsuid1" value="I'm Feeling Lucky" name="btnI" type="submit"><script nonce="lLvBK6fctJ8MRm/sfCr5mQ==">(function(){var id='tsuid1';document.getElementById(id).onclick = function(){if (this.form.q.value){this.checked = 1;if (this.form.iflsig)this.form.iflsig.disabled = false;}
else top.location='/doodles/';};})();</script><input value="AAP1E1EAAAAAXg-PgoF1oVom710P_zj3kKoyTby_7EzV" name="iflsig" type="hidden"></span></span></td><td class="fl sblc" align="left" nowrap="" width="25%"><a href="/advanced_search?hl=en-IN&amp;authuser=0">Advanced search</a><a href="/language_tools?hl=en-IN&amp;authuser=0">Language tools</a></td></tr></table><input id="gbv" name="gbv" type="hidden" value="1"><script nonce="lLvBK6fctJ8MRm/sfCr5mQ==">(function(){var a,b="1";if(document&&document.getElementById)if("undefined"!=typeof XMLHttpRequest)b="2";else if("undefined"!=typeof ActiveXObject){var c,d,e=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"];for(c=0;d=e[c++];)try{new ActiveXObject(d),b="2"}catch(h){}}a=b;if("2"==a&&-1==location.search.indexOf("&gbv=2")){var f=google.gbvu,g=document.getElementById("gbv");g&&(g.value=a);f&&window.setTimeout(function(){location.href=f},0)};}).call(this);</script></form><div id="gac_scont"></div><div style="font-size:83%;min-height:3.5em"><br><div id="gws-output-pages-elements-homepage_additional_languages__als"><style>#gws-output-pages-elements-homepage_additional_languages__als{font-size:small;margin-bottom:24px}#SIvCob{display:inline-block;line-height:28px;}#SIvCob a{padding:0 3px;}.H6sW5{display:inline-block;margin:0 2px;white-space:nowrap}.z4hgWe{display:inline-block;margin:0 2px}</style><div id="SIvCob">Google offered in:  <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=hi&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAU">&#2361;&#2367;&#2344;&#2381;&#2342;&#2368;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=bn&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAY">&#2476;&#2494;&#2434;&#2482;&#2494;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=te&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAc">&#3108;&#3142;&#3122;&#3137;&#3095;&#3137;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=mr&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAg">&#2350;&#2352;&#2366;&#2336;&#2368;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=ta&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAk">&#2980;&#2990;&#3007;&#2996;&#3021;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=gu&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAo">&#2711;&#2753;&#2716;&#2736;&#2750;&#2724;&#2752;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=kn&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAs">&#3221;&#3240;&#3277;&#3240;&#3233;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=ml&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCAw">&#3374;&#3378;&#3375;&#3390;&#3379;&#3330;</a>    <a href="http://www.google.com/setprefs?sig=0_QtfYH-boBwmMEcCYEUPxhS7YbJE%3D&amp;hl=pa&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwj61dXHgejmAhXuzjgGHSYhBP0Q2ZgBCA0">&#2602;&#2672;&#2588;&#2622;&#2604;&#2624;</a>  </div></div></div><span id="footer"><div style="font-size:10pt"><div style="margin:19px auto;text-align:center" id="fll"><a href="/intl/en/ads/">Advertisingâ€ Programs</a><a href="http://www.google.co.in/services/">Business Solutions</a><a href="/intl/en/about.html">About Google</a><a href="http://www.google.com/setprefdomain?prefdom=IN&amp;prev=http://www.google.co.in/&amp;sig=K_M8rcfybIpmqWUC14nLwPHp6e0fY%3D">Google.co.in</a></div></div><p style="color:#767676;font-size:8pt">&copy; 2020 - <a href="/intl/en/policies/privacy/">Privacy</a> - <a href="/intl/en/policies/terms/">Terms</a></p></span></center><script nonce="lLvBK6fctJ8MRm/sfCr5mQ==">(function(){window.google.cdo={height:0,width:0};(function(){var a=window.innerWidth,b=window.innerHeight;if(!a||!b){var c=window.document,d="CSS1Compat"==c.compatMode?c.documentElement:c.body;a=d.clientWidth;b=d.clientHeight}a&&b&&(a!=google.cdo.width||b!=google.cdo.height)&&google.log("","","/client_204?&atyp=i&biw="+a+"&bih="+b+"&ei="+google.kEI);}).call(this);})();(function(){var u='/xjs/_/js/k\x3dxjs.hp.en.3mkxARIkkN0.O/m\x3dsb_he,d/am\x3dAAMCbAQ/d\x3d1/rs\x3dACT90oH0ZgFCL-q_Qh6y8ytgGBhQJ9zvUw';
setTimeout(function(){var b=document;var a="SCRIPT";"application/xhtml+xml"===b.contentType&&(a=a.toLowerCase());a=b.createElement(a);a.src=u;google.timers&&google.timers.load&&google.tick&&google.tick("load","xjsls");document.body.appendChild(a)},0);})();(function(){window.google.xjsu='/xjs/_/js/k\x3dxjs.hp.en.3mkxARIkkN0.O/m\x3dsb_he,d/am\x3dAAMCbAQ/d\x3d1/rs\x3dACT90oH0ZgFCL-q_Qh6y8ytgGBhQJ9zvUw';})();function _DumpException(e){throw e;}
function _F_installCss(c){}
(function(){google.spjs=false;google.snet=true;google.em=[];google.emw=false;})();(function(){var pmc='{\x22d\x22:{},\x22sb_he\x22:{\x22agen\x22:true,\x22cgen\x22:true,\x22client\x22:\x22heirloom-hp\x22,\x22dh\x22:true,\x22dhqt\x22:true,\x22ds\x22:\x22\x22,\x22ffql\x22:\x22en\x22,\x22fl\x22:true,\x22host\x22:\x22google.com\x22,\x22isbh\x22:28,\x22jsonp\x22:true,\x22msgs\x22:{\x22cibl\x22:\x22Clear Search\x22,\x22dym\x22:\x22Did you mean:\x22,\x22lcky\x22:\x22I\\u0026#39;m Feeling Lucky\x22,\x22lml\x22:\x22Learn more\x22,\x22oskt\x22:\x22Input tools\x22,\x22psrc\x22:\x22This search was removed from your \\u003Ca href\x3d\\\x22/history\\\x22\\u003EWeb History\\u003C/a\\u003E\x22,\x22psrl\x22:\x22Remove\x22,\x22sbit\x22:\x22Search by image\x22,\x22srch\x22:\x22Google Search\x22},\x22ovr\x22:{},\x22pq\x22:\x22\x22,\x22refpd\x22:true,\x22rfs\x22:[],\x22sbpl\x22:24,\x22sbpr\x22:24,\x22scd\x22:10,\x22sce\x22:5,\x22stok\x22:\x22XqOMyCPYeKlO92Rh9yTqp7lmcMA\x22,\x22uhde\x22:false}}';google.pmc=JSON.parse(pmc);})();</script>        </body></html>
```

YAY!!!! Made it work! As you can see the header

```
x-hello-from-go: Go says hello to localhost:8000
```

That's the response header from our plugin! :D

The plugin server finally has some logs

```
2020/01/03 18:01:01 Started instance "go-hello":0
2020/01/03 18:01:09 Started instance "go-hello":1
```

By the way, looks like requests are sometimes stuck. Hmm.
Like now, my curl is getting stuck, not getting any google web page now.

For some weird reason it got stuck. Hmm. I restarted it and it worked
fine! plugin server logs!

```
2020/01/03 18:01:01 Started instance "go-hello":0
2020/01/03 18:01:09 Started instance "go-hello":1
2020/01/03 18:04:34 closing instance "go-hello":0
2020/01/03 18:04:34 closing instance "go-hello":1
2020/01/03 18:04:34 Started instance "go-hello":2
2020/01/03 18:04:35 Started instance "go-hello":3
2020/01/03 18:04:37 Started instance "go-hello":4
```

I also did this

```
$ while true; do curl -i localhost:8000; done;
```

and everything worked smoothly. But restarting plugin server was giving
problems - permission issues. Whenever I restart the plugin server, the
socket is modified by it I think. And permissions change, and since the
owner and the group is `root`, and cannot be read by others, kong has
some issues - even though the current docker container user is `root`.
Not sure how it's working inside. Anyways, after starting plugin server,
opening up another terminal to change the permissions is a good hack
for now!

That's all for today! :D I think I should start writing a blog on how
to write and run a simple plugin next. For which I mgiht have to learn
a bit more about plugins, and later, checking out the internals might
be interesting! :D