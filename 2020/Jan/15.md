# Jan 15th 2020

# Open Source Stuff 1

So, today I'm continuing on the kong plugin development! :D

Now, I was trying to `source` the `env` file I had created, and...well,
it just didn't work at all initially

```
$ source env
-bash: : command not found
```

I kept trying different things, and searching duckduckgo didn't exactly
help, and then I tried something weird

```
$ mv env .env
$ source env
```

and it worked! üôà I'm like what! Not sure what's the exact issue here. I
have seen many people use `.env` and `.env.sample`, so I just tried it
once after trying some sane options üòÇ

I still can't find much on it yet. I've gotta work on my ducking skills
and may be check google too sometime. For now, I'm going to move on!

So, I sourced the `.env` file I had

Let's start kong and see if it obeys it! :D

```
$ kong start
kong start
2020/01/15 06:08:25 [warn] ulimit is currently set to "256". For better performance set it to at least "4096" using "ulimit -n"
znginx: [error] [kong] init.lua:421 failure connecting to go plugin server socket: connect failure: Connection refused
^CKong started
```

Okay, so, I didn't start my golang plugin server. I'll do that, but the
weird thing is, it didn't stop, so I stopped it and then it said `Kong
started` ü§î I'm like - ummm, what? Too many whats :P

Now, I opened up another terminal to start kong, since my current tmux
window was already having two panes. I wanted to keep both the plugin
server and the kong in the same window in two panes, so moved to new
window. And this happened

```
$ ./go-pluginserver -socket /Users/karuppiahn/kong/go_pluginserver.sock
```

```
$ kong start
Error: [PostgreSQL error] failed to retrieve PostgreSQL server_version_num: FATAL: role "kong" does not exist

  Run with --v (verbose) or --vv (debug) for more details
```

I forgot to `source` the `.env` file in the new terminal üòÖ

```
$ source .env
$ kong start
2020/01/15 06:15:03 [warn] ulimit is currently set to "256". For better performance set it to at least "4096" using "ulimit -n"
```

Seems like it's working. It's blocking. Let's hit the proxy or the
admin port and see what happens

```
$ curl localhost:8000
{"message":"no Route matched with those values"}

$ curl localhost:8001
{"plugins":{"enabled_in_cluster":["kafka-upstream-golang"],"available_on_server":{"correlation-id":true,"pre-function":true,"cors":true,"ldap-auth":true,"loggly":true,"hmac-auth":true,"zipkin":true,"request-size-limiting":true,"azure-functions":true,"request-transformer":true,"oauth2":true,"response-transformer":true,"ip-restriction":true,"statsd":true,"jwt":true,"proxy-cache":true,"basic-auth":true,"key-auth":true,"http-log":true,"datadog":true,"tcp-log":true,"post-function":true,"prometheus":true,"acl":true,"syslog":true,"file-log":true,"session":true,"udp-log":true,"response-ratelimiting":true,"aws-lambda":true,"bot-detection":true,"rate-limiting":true,"request-termination":true}},"tagline":"Welcome to kong","configuration":{"plugins":["bundled"],"role":"traditional","admin_listen":["127.0.0.1:8001 reuseport backlog=16384","127.0.0.1:8444 http2 ssl reuseport backlog=16384"],"proxy_access_log":"logs\/access.log","trusted_ips":{},"prefix":"\/Users\/karuppiahn\/kong","loaded_plugins":{"correlation-id":true,"pre-function":true,"cors":true,"rate-limiting":true,"loggly":true,"hmac-auth":true,"zipkin":true,"bot-detection":true,"azure-functions":true,"request-transformer":true,"oauth2":true,"response-transformer":true,"syslog":true,"statsd":true,"jwt":true,"proxy-cache":true,"basic-auth":true,"key-auth":true,"http-log":true,"datadog":true,"tcp-log":true,"post-function":true,"ldap-auth":true,"acl":true,"ip-restriction":true,"file-log":true,"prometheus":true,"udp-log":true,"response-ratelimiting":true,"aws-lambda":true,"request-size-limiting":true,"session":true,"request-termination":true},"cassandra_username":"kong","ssl_cert_key":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.key","admin_ssl_cert_key":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.key","dns_resolver":{},"pg_user":"kong","mem_cache_size":"128m","ssl_ciphers":"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384","nginx_admin_directives":{},"nginx_http_upstream_directives":[{"value":"60s","name":"keepalive_timeout"},{"value":"100","name":"keepalive_requests"},{"value":"60","name":"keepalive"}],"client_max_body_size":"0","nginx_http_directives":[{"value":"off","name":"ssl_prefer_server_ciphers"},{"value":"TLSv1.2 TLSv1.3","name":"ssl_protocols"},{"value":"on","name":"ssl_session_tickets"},{"value":"1d","name":"ssl_session_timeout"},{"value":"prometheus_metrics 5m","name":"lua_shared_dict"}],"pg_host":"127.0.0.1","nginx_acc_logs":"\/Users\/karuppiahn\/kong\/logs\/access.log","pg_semaphore_timeout":60000,"proxy_listen":["0.0.0.0:8000 reuseport backlog=16384","0.0.0.0:8443 http2 ssl reuseport backlog=16384"],"declarative_config":"\/Users\/karuppiahn\/oss\/github.com\/kong\/kong-plugin-demo\/kong.yml","ssl_cert_key_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.key","client_ssl_cert_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.crt","cassandra_ssl":false,"go_plugins_dir":"\/Users\/karuppiahn\/kong-golang-plugins-dir","db_update_frequency":5,"db_update_propagation":0,"nginx_conf":"\/Users\/karuppiahn\/kong\/nginx.conf","stream_listen":["off"],"nginx_err_logs":"\/Users\/karuppiahn\/kong\/logs\/error.log","ssl_cert_csr_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.csr","cassandra_port":9042,"dns_order":["LAST","SRV","A","CNAME"],"dns_error_ttl":1,"headers":["server_tokens","latency_tokens"],"nginx_optimizations":true,"dns_no_sync":false,"status_listen":["off"],"dns_stale_ttl":4,"cluster_control_plane":"127.0.0.1:8005","nginx_http_upstream_keepalive_timeout":"60s","admin_ssl_enabled":true,"pg_timeout":60000,"cassandra_contact_points":["127.0.0.1"],"nginx_http_upstream_keepalive_requests":"100","database":"off","nginx_http_ssl_prefer_server_ciphers":"off","client_ssl":false,"nginx_sproxy_directives":{},"pg_database":"kong","nginx_worker_processes":"auto","anonymous_reports":true,"lua_package_cpath":"","cassandra_repl_factor":1,"admin_acc_logs":"\/Users\/karuppiahn\/kong\/logs\/admin_access.log","nginx_stream_directives":{},"cassandra_refresh_frequency":60,"lua_package_path":".\/?.lua;.\/?\/init.lua;","nginx_pid":"\/Users\/karuppiahn\/kong\/pids\/nginx.pid","upstream_keepalive":60,"nginx_daemon":"off","ssl_cipher_suite":"intermediate","nginx_http_ssl_session_tickets":"on","nginx_http_status_directives":{},"admin_access_log":"logs\/admin_access.log","pg_max_concurrent_queries":0,"pg_ssl_verify":false,"proxy_listeners":[{"listener":"0.0.0.0:8000 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":false,"ip":"0.0.0.0","backlog=16384":true,"http2":false,"port":8000,"bind":false},{"listener":"0.0.0.0:8443 ssl http2 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":true,"ip":"0.0.0.0","backlog=16384":true,"http2":true,"port":8443,"bind":false}],"proxy_ssl_enabled":true,"nginx_http_upstream_keepalive":"60","db_cache_warmup_entities":["services","plugins"],"enabled_headers":{"latency_tokens":true,"X-Kong-Response-Latency":true,"Server":true,"X-Kong-Admin-Latency":true,"X-Kong-Upstream-Status":false,"Via":true,"X-Kong-Proxy-Latency":true,"server_tokens":true,"X-Kong-Upstream-Latency":true},"nginx_http_ssl_protocols":"TLSv1.2 TLSv1.3","cassandra_lb_policy":"RequestRoundRobin","db_resurrect_ttl":30,"cassandra_timeout":60000,"cassandra_consistency":"ONE","db_cache_ttl":0,"admin_error_log":"logs\/error.log","status_listeners":{},"dns_not_found_ttl":30,"pg_ssl":false,"cassandra_data_centers":["dc1:2","dc2:3"],"status_access_log":"off","cluster_listeners":[{"listener":"0.0.0.0:8005","proxy_protocol":false,"reuseport":false,"backlog=%d+":false,"deferred":false,"ssl":false,"ip":"0.0.0.0","port":8005,"http2":false,"bind":false}],"status_error_log":"logs\/status_error.log","kong_env":"\/Users\/karuppiahn\/kong\/.kong_env","error_default_type":"text\/plain","log_level":"notice","nginx_kong_conf":"\/Users\/karuppiahn\/kong\/nginx-kong.conf","real_ip_header":"X-Real-IP","dns_hostsfile":"\/etc\/hosts","admin_listeners":[{"listener":"127.0.0.1:8001 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":false,"ip":"127.0.0.1","backlog=16384":true,"http2":false,"port":8001,"bind":false},{"listener":"127.0.0.1:8444 ssl http2 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":true,"ip":"127.0.0.1","backlog=16384":true,"http2":true,"port":8444,"bind":false}],"cassandra_schema_consensus_timeout":60000,"ssl_cert":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.crt","lua_ssl_verify_depth":1,"admin_ssl_cert_key_default":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.key","cassandra_ssl_verify":false,"cluster_listen":["0.0.0.0:8005"],"cassandra_repl_strategy":"SimpleStrategy","real_ip_recursive":"off","proxy_error_log":"logs\/error.log","client_ssl_cert_key_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.key","admin_ssl_cert":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.crt","router_consistency":"strict","nginx_proxy_directives":{},"lua_socket_pool_size":30,"pg_port":5432,"stream_listeners":{},"client_body_buffer_size":"8k","ssl_preread_enabled":true,"nginx_kong_stream_conf":"\/Users\/karuppiahn\/kong\/nginx-kong-stream.conf","admin_ssl_cert_default":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.crt","cassandra_keyspace":"kong","ssl_cert_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.crt","nginx_http_ssl_session_timeout":"1d","router_update_frequency":1},"version":"2.0.0rc1","node_id":"1e5943f6-4e70-4884-bc09-759a44dcbcff","lua_version":"LuaJIT 2.1.0-beta3","prng_seeds":{"pid: 93158":421462232410,"pid: 93155":246711621902,"pid: 93157":176712218922,"pid: 93156":159602271202,"pid: 93152":158167841149,"pid: 93153":666183238245,"pid: 93159":196182421961,"pid: 93005":53174638010,"pid: 93154":100231501384},"timers":{"pending":5,"running":0},"hostname":"Karuppiah-N.local"}
```

Looks like it's working! :)

But I don't see any logs in kong, hmm. I think the environment
variables are not right? Let me check

```
export KONG_GO_PLUGINS_DIR="/Users/karuppiahn/kong-golang-plugins-dir"
export KONG_PREFIX="/Users/karuppiahn/kong/"
export KONG_DATABASE="off"
export KONG_DECLARATIVE_CONFIG="/Users/karuppiahn/oss/github.com/kong/kong-plugin-demo/kong.yml"
export KONG_NGINX_DAEMON="off"
echo "variables exported!"
```

Okay, yeah, well, I missed the variables for `stdout`, `stderr` stuff
üôà Let me go put that! And then this should be fixed :)

```
export KONG_GO_PLUGINS_DIR="/Users/karuppiahn/kong-golang-plugins-dir"
export KONG_PREFIX="/Users/karuppiahn/kong/"
export KONG_DATABASE="off"
export KONG_DECLARATIVE_CONFIG="/Users/karuppiahn/oss/github.com/kong/kong-plugin-demo/kong.yml"
export KONG_NGINX_DAEMON="off"
export KONG_PROXY_ACCESS_LOG="/dev/stdout"
export KONG_ADMIN_ACCESS_LOG="/dev/stdout"
export KONG_PROXY_ERROR_LOG="/dev/stderr"
export KONG_ADMIN_ERROR_LOG="/dev/stderr"

echo "variables exported!"
```

Okay, that's done now. Let's restart kong!

```
$ source .env
$ kong start
2020/01/15 06:20:21 [notice] 5991#0: [lua] regex.lua:413: parse_regex_opts(): regex compilation cache disabled in init phase under macOS
2020/01/15 06:20:21 [notice] 5991#0: [lua] regex.lua:417: parse_regex_opts(): regex compilation disabled in init phase under macOS
2020/01/15 06:20:21 [notice] 5991#0: [lua] regex.lua:417: parse_regex_opts(): regex compilation disabled in init phase under macOS
2020/01/15 06:20:21 [notice] 5991#0: [lua] regex.lua:413: parse_regex_opts(): regex compilation cache disabled in init phase under macOS
2020/01/15 06:20:21 [notice] 5991#0: [kong] iam-ecs-credentials.lua:31 No ECS environment variables found for IAM
2020/01/15 06:20:21 [notice] 5991#0: using the "kqueue" event method
2020/01/15 06:20:21 [notice] 5991#0: openresty/1.15.8.2
2020/01/15 06:20:21 [notice] 5991#0: OS: Darwin 19.2.0
2020/01/15 06:20:21 [notice] 5991#0: hw.ncpu: 8
2020/01/15 06:20:21 [notice] 5991#0: net.inet.tcp.sendspace: 131072
2020/01/15 06:20:21 [notice] 5991#0: kern.ipc.somaxconn: 128
2020/01/15 06:20:21 [notice] 5991#0: getrlimit(RLIMIT_NOFILE): 256:9223372036854775807
2020/01/15 06:20:21 [notice] 5991#0: start worker processes
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6013
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6014
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6015
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6016
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6017
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6018
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6019
2020/01/15 06:20:21 [notice] 5991#0: start worker process 6020
2020/01/15 06:20:21 [warn] 6017#0: *5 [lua] globalpatches.lua:52: executing a blocking 'sleep' (0.01 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6013#0: *1 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.001 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [notice] 6015#0: *3 [kong] init.lua:280 declarative config loaded from /Users/karuppiahn/oss/github.com/kong/kong-plugin-demo/kong.yml, context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6016#0: *4 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.001 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6013#0: *1 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.002 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6016#0: *4 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.002 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6020#0: *8 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.001 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6013#0: *1 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.004 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6020#0: *8 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.002 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6016#0: *4 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.004 seconds), context: init_worker_by_lua*
2020/01/15 06:20:21 [warn] 6014#0: *2 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.001 seconds), context: init_worker_by_lua*
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received from 6015
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received from 6013
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received from 6014
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received from 6018
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received from 6016
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received
2020/01/15 06:20:22 [notice] 5991#0: signal 23 (SIGIO) received from 6017
2020/01/15 06:20:23 [notice] 5991#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6018#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6015#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6016#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6017#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6019#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6020#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6014#0: signal 28 (SIGWINCH) received from 92032
2020/01/15 06:20:23 [notice] 6013#0: signal 28 (SIGWINCH) received from 92032

```

Wow, cool! :D I should have expected these logs while starting it
itself, as I saw similar logs in the docker container, that's
because all the configurations were set correctly there. Hmm. Anyways,
now, let me hit kong and check if I can see logs of that too!

```
$ curl localhost:8000
...

$ curl localhost:8001
...

```

Okay! All seems good, I can see the below logs

```
127.0.0.1 - - [15/Jan/2020:06:23:02 +0530] "GET / HTTP/1.1" 404 48 "-" "curl/7.64.1"
127.0.0.1 - - [15/Jan/2020:06:23:07 +0530] "GET / HTTP/1.1" 200 7980 "-" "curl/7.64.1"
127.0.0.1 - - [15/Jan/2020:06:23:09 +0530] "GET / HTTP/1.1" 200 7980 "-" "curl/7.64.1"
```

The `200`s are basically requests to `localhost:8001`

Now, now, I have to check if all my plugins are good, and installed in
the right place and showing up in kong. Let me check that

Okay, I checked the plugins directory based on the config I had which
is this

```
export KONG_GO_PLUGINS_DIR="/Users/karuppiahn/kong-golang-plugins-dir"
```

```
$ cd /Users/karuppiahn/kong-golang-plugins-dir
$ ls
kafka-upstream-golang.so
```

and the admin api shows this

```
$ curl localhost:8001/plugins
{"next":null,"data":[{"created_at":1579049421,"consumer":null,"id":"d350f442-ffc6-5ebd-b8ea-21a2d9e242c5","service":null,"enabled":true,"tags":null,"name":"kafka-upstream-golang","protocols":["grpc","grpcs","http","https"],"route":{"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8"}}]}
```

I also have defined a `route` and a `plugin` for the `route`, which
shows up here

```
$ curl localhost:8001/routes
{"next":null,"data":[{"strip_path":true,"path_handling":"v0","paths":null,"destinations":null,"headers":null,"protocols":["http","https"],"created_at":1579049421,"snis":null,"hosts":["kafka-upstream.dev"],"name":"kafka-upstream","service":null,"preserve_host":false,"regex_priority":0,"tags":null,"sources":null,"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8","https_redirect_status_code":426,"updated_at":1579049421,"methods":null}]}

$ curl localhost:8001/routes/kafka-upstream
{"strip_path":true,"path_handling":"v0","paths":null,"destinations":null,"headers":null,"protocols":["http","https"],"created_at":1579049421,"snis":null,"hosts":["kafka-upstream.dev"],"name":"kafka-upstream","service":null,"preserve_host":false,"regex_priority":0,"tags":null,"sources":null,"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8","https_redirect_status_code":426,"updated_at":1579049421,"methods":null}

$ curl localhost:8001/routes/kafka-upstream/plugins
{"next":null,"data":[{"created_at":1579049421,"consumer":null,"id":"d350f442-ffc6-5ebd-b8ea-21a2d9e242c5","service":null,"enabled":true,"tags":null,"name":"kafka-upstream-golang","protocols":["grpc","grpcs","http","https"],"route":{"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8"}}]}
```

Now, I just have to make sure that I have the latest version of the
plugin. I guess there could be a concept of plugin versions? ü§î Let me
see if I can find the plugin version and about how to set it, so that I
know the plugin's version and can verify it's the latest ! :) All this
because the last time I was playing with the plugin, I broke it - you
know, calling `Exit` with `integer` body though it expects only `nil`,
`string` or `object` which is `map` in the case of `golang`.

# Car stuff 1

Okay, I took a break in between. Was checking out this site then -
[drivex.in](https://drivex.in). It's about using cars in subscription
model. "pay for what you use", sound familiar? ;) all the stuff have a
subscription model now ;) I think I got to know the concept through
cloud, but hey, this has been there for long - rents like stuff, or
leases. Anyways, back to Kong

# Open Source Stuff 2

Now, I'm going to 
1. check the plugin version stuff
2. then build the plugin once and put it in the golang plugins directory so that we
know that it's the latest and using version too
3. then we can check if it works once
4. then I plan to run Kafka and try some producing and consuming and
meddling
5. then check for kafka golang libraries - I have heard of some of
them, let's see what we find :)

plugin version stuff:
Looks like we can set version and even priority which I remember seeing
long ago. There are ways to do it over here - 

https://docs.konghq.com/1.4.x/plugin-development/plugin-configuration/

You can see this code in `lua`

```
CustomHandler.VERSION  = "1.0.0"
CustomHandler.PRIORITY = 10
```

Now, how do I do something similar in golang? I started digging into
some Kong code and starting searching for the words `VERSION`,
`PRIORITY` and the likes, to find these

https://github.com/Kong/kong/blob/2.0.0rc1/kong/db/dao/plugins/go.lua#L454-L463

You can see this

```
local plugin_info, err = rpc_call("plugin.GetPluginInfo", plugin_name)
    if not plugin_info then
      kong.log.err("calling GetPluginInfo: ", err)
      return nil, err
    end

    plugin = {
      PRIORITY = plugin_info.Priority,
      VERSION = plugin_info.Version,
      schema = plugin_info.Schema,
    }
```

and how there's a way to get version from the plugin. So, how's it even
set in the first place? For which I started digging into the
`GetPluginInfo` function in `go-pluginserver` code and found this

https://github.com/Kong/go-pluginserver/blob/master/pluginserver.go#L257-L265

```
v, _ := plug.code.Lookup("Version")
if v != nil {
  info.Version = v.(string)
}

prio, _ := plug.code.Lookup("Priority")
if prio != nil {
  info.Priority = prio.(int)
}
```

So, you can see how it's looking for some `Version`, `Priority` in the
code. I think if I define some variables at the package level scope
with these names and proper type - version is a string, priority is an
int, then kong will be able to understand it. In our case, we just need
a version. Priority - I was just checking how one would set it :)

And while doing all this, I also noticed that `kong` has a new release!
It's `2.0.0rc2` and `go-pluginserver` also has `0.2.0` release!

https://github.com/Kong/kong/releases/tag/2.0.0rc2
https://github.com/Kong/kong/releases - all releases


https://github.com/Kong/go-pluginserver/releases/tag/0.2.0
https://github.com/Kong/go-pluginserver/releases - all releases

May be I can get the latest now? ü§î I already pulled and rebased the
`go-pluginserver` - as I had some changes - like `go.mod`, `go.sum` as
I wanted to fix the version of `go-pdk` being used due to some version
errors I saw and also, I wanted to use my `go-pdk` which has the new
`Exit` method that I wrote, that I need for the `kafka-upstream-golang`
plugin - which makes me think - I have to ask folks to use my version
of `go-pluginserver` for this whole thing to work, due to all the
version issues and the non-existence of the `Exit` method. May be
sometime I'll work on making it better for the repos so that I don't
see these errors in the mainstream repo code itself and everyone can
then benefit from the plugin ! :D

Also, I was just checking if I can install the latest v2.0.0rc2 using
homebrew and I can :D this is their commit for it -

https://github.com/Kong/homebrew-kong/commit/46ce356cd97b9285f0f0fd776e7319d03eff0bc8

And I also see a cool announcement for the release :D

https://discuss.konghq.com/t/kong-2-0-0rc2-released/5294

Now, I have to see what to do to update to the latest. I think I'll
use upgrade and use `--devel` too. Let me see my old command first!

Found it!

```
$ brew install --devel kong
```

So, now Imma do this!

```
$ brew upgrade --devel kong
```

Okay, I was reading the announcement while brew was slowly running :P

after all the updating brew just failed with

```
Error: invalid option: --devel
```

Looks like I'll just use

```
$ brew upgrade kong
```

I get this

```
Warning: kong/kong/kong 2.0.0 already installed
```

Hmm. Time to reinstall I guess

```
$ brew reinstall --help
Usage: brew reinstall [options] formula

Uninstall and then install formula using the same options it was originally
installed with, plus any appended brew formula options.

Unless HOMEBREW_NO_INSTALL_CLEANUP is set, brew cleanup will then be run for
the reinstalled formulae or, every 30 days, for all formulae.

    -d, --debug                      If brewing fails, open an interactive
                                     debugging session with access to IRB or a
                                     shell inside the temporary build directory.
    -s, --build-from-source          Compile formula from source even if a
                                     bottle is available.
        --force-bottle               Install from a bottle if it exists for the
                                     current or newest version of macOS, even if
                                     it would not normally be used for
                                     installation.
        --keep-tmp                   Retain the temporary files created during
                                     installation.
    -f, --force                      Install without checking for previously
                                     installed keg-only or non-migrated
                                     versions.
    -v, --verbose                    Print the verification and postinstall
                                     steps.
        --display-times              Print install times for each formula at the
                                     end of the run.
    -h, --help                       Show this message.
```

But reinstall does not have `--devel` option, hmm. And I still used it
:P and it failed :P

```
Error: invalid option: --devel
```

I'm just planning to either delete and install or just reinstall with
no options. But reinstall might give stable version. Let's try though

ooooooh, it's working I think

```
$ brew reinstall kong
==> Reinstalling kong/kong/kong
==> Cloning https://github.com/Kong/kong.git
Updating /Users/karuppiahn/Library/Caches/Homebrew/kong--git
From https://github.com/Kong/kong
 * [new tag]         2.0.0rc2   -> 2.0.0rc2
==> Checking out tag 2.0.0rc2
Previous HEAD position was f7f2448e release: 2.0.0rc1
HEAD is now at a93b9f4d release: 2.0.0rc2
HEAD is now at a93b9f4d release: 2.0.0rc2
==> Patching
patching file kong/templates/kong_defaults.lua
==> /usr/local/opt/openresty/luarocks/bin/luarocks --tree=/usr/local/Cellar/kong/2.0.0 make CRYPTO_DIR=/usr/local/o
```

But it's still not yet done, too slow...meanwhile, I checked out some
cool stuff that the kong maintainers have done :D I saw it in their
announcement

https://discuss.konghq.com/t/kong-2-0-0rc2-released/5294

The two things that caught my eye was - 

```
Kong manages the lifecycle of the Go language plugin server by itself #5366 2
godoc documentation for Go PDK go-pdk#18 2
```

So, now we have docs, that's a good thing, but however I found the docs
from the lua code üòÖ and the docs site. But now it will be a bit easier
I think. Also, look at the thing about kong managing go plugin server!
:D Now I don't have to start it myself ;) I do hope that I can use my
version of go plugin server. I guess it will just look at the `$PATH`
environment variable and find the `go-pluginserver` binary. Let's see,
and we will clearly know if it doesn't work :)

And this is the PR - https://github.com/Kong/kong/pull/5366

It says

```
process management to make the running of go-pluginserver transparent to the user

    starts it when needed
    restarts if it dies
    it's killed when nginx quits.
```

I mean, I'm impressed :D I do have to check what happens when we update
the plugin `.so` file in the golang plugins directory. I have
previously seen that it didn't take up the latest version if it has
been invoked once already, when it was a different version. Some weird
behavior happened. May be this time I can raise an issue if I see it
again. Let's see :)

And brew is done finally

```
üç∫  /usr/local/Cellar/kong/2.0.0: 1,175 files, 8.5MB, built in 3 minutes 14 seconds
```

```
$ kong version
2.0.0rc2
```

yay!

Okay, I took a biiiiig break. Back now! :D

I'm gonna add version to the plugin code now

So, I'm adding this

```
var Version string = "0.1.0"
```

Let's build and use it! :)

```
$ make
$ export KONG_GO_PLUGINS_DIR="/Users/karuppiahn/kong-golang-plugins-dir"
$ cp kafka-upstream-golang.so $KONG_GO_PLUGINS_DIR
```

I'll start kong now! We can use this command:

```
$ kong start
```

Also, notice how I'm not starting the golang plugin server ;) This is
because kong is going to manage it, so now I don't have to worry about
it. I just recalled it when I was going to start kong üòÖ 

Also, there are some new options in the golang plugin server

```
$ go-pluginserver -h
Usage of go-pluginserver:
  -dump-plugin-info plugin
        Dump info about plugin as a MessagePack object
  -kong-prefix string
        Kong prefix path (specified by the -p argument commonly used in the kong cli) (default "/usr/local/kong")
  -plugins-directory path
        Set directory path where to search plugins
  -version
        Print binary and runtime version
```

Previously it used to take `-socket` option only. Now it has changed!
:)

```
$ go-pluginserver -version
Version: development
Runtime Version: go1.13.5
```

Okay, so our kong, I just started it, and it didn't end well üòÖ damn, I
got lots and lots of errors. Like tons I think? Idk, so it was the same
error over and over again -

```
$ kong start
```

```
2020/01/15 13:15:56 [notice] 40343#0: signal 20 (SIGCHLD) received from 42330
2020/01/15 13:15:56 [notice] 40343#0: *12 [kong] go.lua:80 go-pluginserver terminated: exit 1, context: ngx.timer
2020/01/15 13:15:56 [notice] 40343#0: *12 [kong] go.lua:69 Starting go-pluginserver, context: ngx.timer
2020/01/15 13:15:56 [error] 40343#0: lua pipe child execvp() failed while executing /usr/local/bin/go-pluginserver (2: No such file or directory)
```

I think I remember seeing a mention about something about the binary
path being hardcoded. Let me check

Okay, so there's a config to tell where the executable can be found and
the default value is `/usr/local/bin/go-pluginserver`

I found it here -

https://github.com/Kong/kong/pull/5366/files#diff-20b52879c52e3345f57b35b6e6b0ccd2R118

The actual code is here -

https://github.com/Kong/kong/blob/2.0.0rc2/kong.conf.default#L118

Anyways, let's set that now. My plugin server is here

```
$ which go-pluginserver
/Users/karuppiahn/go/bin//go-pluginserver
```

I'll add this to the `.env`

```
export GO_PLUGINSERVER_EXE="/Users/karuppiahn/go/bin/go-pluginserver"
```

```
$ source .env
$ kong start
```

Hmm, still the same errors

```
2020/01/15 13:22:56 [notice] 56680#0: signal 20 (SIGCHLD) received from 57835
2020/01/15 13:22:56 [notice] 56680#0: *16 [kong] go.lua:80 go-pluginserver terminated: exit 1, context: ngx.timer
2020/01/15 13:22:56 [notice] 56680#0: *16 [kong] go.lua:69 Starting go-pluginserver, context: ngx.timer
2020/01/15 13:22:56 [error] 56680#0: lua pipe child execvp() failed while executing /usr/local/bin/go-pluginserver (2: No such file or directory)
```

Oops. I missed the `KONG` prefix in the env variable.

```
export KONG_GO_PLUGINSERVER_EXE="/Users/karuppiahn/go/bin/go-pluginserver"
```

```
$ source .env
$ kong start
```

yay! everything is good and it's working! :)

Let's check if I can see the version. Also, I reverted all the integer
body changes I had when I built the plugin, so that shouldn't be any
problem when the plugin is invoked

```
$ curl localhost:8001/plugins | jq .
{
  "next": null,
  "data": [
    {
      "created_at": 1579074924,
      "consumer": null,
      "id": "d350f442-ffc6-5ebd-b8ea-21a2d9e242c5",
      "service": null,
      "enabled": true,
      "tags": null,
      "name": "kafka-upstream-golang",
      "protocols": [
        "grpc",
        "grpcs",
        "http",
        "https"
      ],
      "route": {
        "id": "0c526b08-ede8-5178-bef7-1e59d3503ae8"
      }
    }
  ]
}
```

```
$ curl localhost:8001
{"plugins":{"enabled_in_cluster":["kafka-upstream-golang"],"available_on_server":{"correlation-id":true,"pre-function":true,"cors":true,"ldap-auth":true,"loggly":true,"hmac-auth":true,"zipkin":true,"request-size-limiting":true,"azure-functions":true,"request-transformer":true,"oauth2":true,"response-transformer":true,"ip-restriction":true,"statsd":true,"jwt":true,"proxy-cache":true,"basic-auth":true,"key-auth":true,"http-log":true,"datadog":true,"tcp-log":true,"post-function":true,"prometheus":true,"acl":true,"syslog":true,"file-log":true,"session":true,"udp-log":true,"response-ratelimiting":true,"aws-lambda":true,"bot-detection":true,"rate-limiting":true,"request-termination":true}},"tagline":"Welcome to kong","configuration":{"plugins":["bundled"],"admin_listen":["127.0.0.1:8001 reuseport backlog=16384","127.0.0.1:8444 http2 ssl reuseport backlog=16384"],"proxy_access_log":"\/dev\/stdout","prefix":"\/Users\/karuppiahn\/kong","nginx_conf":"\/Users\/karuppiahn\/kong\/nginx.conf","cassandra_username":"kong","nginx_events_directives":[{"value":"auto","name":"worker_connections"},{"value":"on","name":"multi_accept"}],"admin_ssl_cert_key":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.key","dns_resolver":{},"nginx_upstream_keepalive_requests":"100","nginx_http_upstream_directives":[{"value":"100","name":"keepalive_requests"},{"value":"60s","name":"keepalive_timeout"},{"value":"60","name":"keepalive"}],"nginx_main_daemon":"off","stream_proxy_ssl_enabled":false,"nginx_acc_logs":"\/Users\/karuppiahn\/kong\/logs\/access.log","pg_semaphore_timeout":60000,"proxy_listen":["0.0.0.0:8000 reuseport backlog=16384","0.0.0.0:8443 http2 ssl reuseport backlog=16384"],"client_ssl_cert_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.crt","go_pluginserver_exe":"\/Users\/karuppiahn\/go\/bin\/go-pluginserver","dns_no_sync":false,"db_update_propagation":0,"stream_listen":["off"],"nginx_err_logs":"\/Users\/karuppiahn\/kong\/logs\/error.log","cassandra_port":9042,"headers":["server_tokens","latency_tokens"],"nginx_http_client_max_body_size":"0","status_listen":["off"],"dns_stale_ttl":4,"cluster_control_plane":"127.0.0.1:8005","nginx_http_ssl_prefer_server_ciphers":"off","pg_database":"kong","nginx_http_client_body_buffer_size":"8k","admin_acc_logs":"\/Users\/karuppiahn\/kong\/logs\/admin_access.log","cassandra_refresh_frequency":60,"nginx_pid":"\/Users\/karuppiahn\/kong\/pids\/nginx.pid","nginx_main_worker_rlimit_nofile":"auto","admin_access_log":"\/dev\/stdout","proxy_listeners":[{"listener":"0.0.0.0:8000 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":false,"ip":"0.0.0.0","backlog=16384":true,"http2":false,"port":8000,"bind":false},{"listener":"0.0.0.0:8443 ssl http2 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":true,"ip":"0.0.0.0","backlog=16384":true,"http2":true,"port":8443,"bind":false}],"db_cache_warmup_entities":["services","plugins"],"enabled_headers":{"latency_tokens":true,"X-Kong-Response-Latency":true,"Server":true,"X-Kong-Admin-Latency":true,"X-Kong-Upstream-Status":false,"Via":true,"X-Kong-Proxy-Latency":true,"server_tokens":true,"X-Kong-Upstream-Latency":true},"nginx_http_ssl_protocols":"TLSv1.2 TLSv1.3","db_cache_ttl":0,"nginx_events_multi_accept":"on","admin_ssl_cert_default":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.crt","pg_ssl":false,"status_access_log":"off","cluster_listeners":[{"listener":"0.0.0.0:8005","proxy_protocol":false,"reuseport":false,"backlog=%d+":false,"deferred":false,"ssl":false,"ip":"0.0.0.0","port":8005,"http2":false,"bind":false}],"kong_env":"\/Users\/karuppiahn\/kong\/.kong_env","cassandra_schema_consensus_timeout":60000,"log_level":"notice","admin_ssl_cert_key_default":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.key","real_ip_recursive":"off","cassandra_repl_factor":1,"ssl_cipher_suite":"intermediate","router_consistency":"strict","pg_port":5432,"cassandra_keyspace":"kong","ssl_cert_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.crt","nginx_http_ssl_session_timeout":"1d","nginx_upstream_directives":[{"value":"100","name":"keepalive_requests"},{"value":"60s","name":"keepalive_timeout"},{"value":"60","name":"keepalive"}],"role":"traditional","client_ssl":false,"trusted_ips":{},"nginx_events_worker_connections":"auto","nginx_supstream_directives":{},"ssl_cert_key":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.key","pg_user":"kong","mem_cache_size":"128m","ssl_ciphers":"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384","nginx_admin_directives":{},"nginx_upstream_keepalive_timeout":"60s","nginx_http_directives":[{"value":"0","name":"client_max_body_size"},{"value":"off","name":"ssl_prefer_server_ciphers"},{"value":"8k","name":"client_body_buffer_size"},{"value":"TLSv1.2 TLSv1.3","name":"ssl_protocols"},{"value":"on","name":"ssl_session_tickets"},{"value":"1d","name":"ssl_session_timeout"},{"value":"prometheus_metrics 5m","name":"lua_shared_dict"}],"pg_host":"127.0.0.1","declarative_config":"\/Users\/karuppiahn\/oss\/github.com\/kong\/kong-plugin-demo\/kong.yml","nginx_kong_stream_conf":"\/Users\/karuppiahn\/kong\/nginx-kong-stream.conf","ssl_cert_csr_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.csr","go_plugins_dir":"\/Users\/karuppiahn\/kong-golang-plugins-dir","cluster_listen":["0.0.0.0:8005"],"dns_order":["LAST","SRV","A","CNAME"],"dns_error_ttl":1,"nginx_optimizations":true,"nginx_http_upstream_keepalive_timeout":"60s","pg_timeout":60000,"nginx_http_upstream_keepalive_requests":"100","database":"off","nginx_upstream_keepalive":"60","nginx_worker_processes":"auto","nginx_http_status_directives":{},"lua_package_path":".\/?.lua;.\/?\/init.lua;","router_update_frequency":1,"upstream_keepalive":60,"pg_max_concurrent_queries":0,"proxy_ssl_enabled":true,"nginx_http_upstream_keepalive":"60","lua_socket_pool_size":30,"db_resurrect_ttl":30,"nginx_proxy_real_ip_header":"X-Real-IP","cassandra_consistency":"ONE","client_max_body_size":"0","admin_error_log":"\/dev\/stderr","nginx_main_directives":[{"value":"off","name":"daemon"},{"value":"auto","name":"worker_rlimit_nofile"},{"value":"auto","name":"worker_processes"}],"dns_not_found_ttl":30,"nginx_http_ssl_session_tickets":"on","cassandra_ssl":false,"db_update_frequency":5,"cassandra_repl_strategy":"SimpleStrategy","status_error_log":"logs\/status_error.log","loaded_plugins":{"correlation-id":true,"pre-function":true,"cors":true,"rate-limiting":true,"loggly":true,"hmac-auth":true,"zipkin":true,"bot-detection":true,"azure-functions":true,"request-transformer":true,"oauth2":true,"response-transformer":true,"syslog":true,"statsd":true,"jwt":true,"proxy-cache":true,"basic-auth":true,"key-auth":true,"http-log":true,"datadog":true,"tcp-log":true,"post-function":true,"ldap-auth":true,"acl":true,"ip-restriction":true,"file-log":true,"prometheus":true,"udp-log":true,"response-ratelimiting":true,"aws-lambda":true,"request-size-limiting":true,"session":true,"request-termination":true},"nginx_status_directives":{},"nginx_main_worker_processes":"auto","nginx_kong_conf":"\/Users\/karuppiahn\/kong\/nginx-kong.conf","real_ip_header":"X-Real-IP","dns_hostsfile":"\/etc\/hosts","admin_listeners":[{"listener":"127.0.0.1:8001 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":false,"ip":"127.0.0.1","backlog=16384":true,"http2":false,"port":8001,"bind":false},{"listener":"127.0.0.1:8444 ssl http2 reuseport backlog=16384","proxy_protocol":false,"reuseport":true,"deferred":false,"ssl":true,"ip":"127.0.0.1","backlog=16384":true,"http2":true,"port":8444,"bind":false}],"nginx_stream_directives":[{"value":"stream_prometheus_metrics 5m","name":"lua_shared_dict"}],"ssl_cert":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.crt","nginx_proxy_real_ip_recursive":"off","cassandra_contact_points":["127.0.0.1"],"cassandra_ssl_verify":false,"error_default_type":"text\/plain","admin_ssl_cert":"\/Users\/karuppiahn\/kong\/ssl\/admin-kong-default.crt","proxy_error_log":"\/dev\/stderr","nginx_sproxy_directives":{},"nginx_proxy_directives":[{"value":"X-Real-IP","name":"real_ip_header"},{"value":"off","name":"real_ip_recursive"}],"nginx_daemon":"off","anonymous_reports":true,"cassandra_timeout":60000,"pg_ssl_verify":false,"status_listeners":{},"client_ssl_cert_key_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.key","client_body_buffer_size":"8k","ssl_cert_key_default":"\/Users\/karuppiahn\/kong\/ssl\/kong-default.key","admin_ssl_enabled":true,"stream_listeners":{},"lua_package_cpath":"","cassandra_lb_policy":"RequestRoundRobin","cassandra_data_centers":["dc1:2","dc2:3"],"lua_ssl_verify_depth":1},"version":"2.0.0rc2","node_id":"3c359ba0-9f5b-4b18-9772-bad979127b2b","lua_version":"LuaJIT 2.1.0-beta3","prng_seeds":{"pid: 63201":177232371513,"pid: 63202":177204921066,"pid: 63203":226752139087,"pid: 63207":865517617127,"pid: 62905":234611613616,"pid: 63206":216723102118,"pid: 63204":243163111174,"pid: 63208":144226446452,"pid: 63205":156137482777},"timers":{"pending":6,"running":0},"hostname":"Karuppiah-N.local"}
```

Okay, it's weird that the plugin shows as enabled, even though the
admin portal shows the `plugins` config as just `bundled`

```
"configuration": {
    "plugins": [
      "bundled"
    ],
```

This is understandable since I didn't change the default config using
envs for `plugins`, which is `KONG_PLUGINS`. But it looks enabled.
Let's run it and see! :)

Hmm, I get a weird error

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev'
{"message":"no Service found with those values"}
```

Hmm, let me check the routes and more. Before that, I was thinking may
be we could check the plugin server logs. Hmm. Not sure if that's
possible or how to check. But kong is maintaining it, gotta check how
plugin server logs and info in that can be checked ü§î

For now I can see a plugin server running using this

```
$ ps aux | rg plugin
...
karuppiahn       63216   0.0  0.0  4406656   5244 s004  S+    1:25PM   0:00.10 /Users/karuppiahn/go/bin/go-pluginserver -kong-prefix /Users/karuppiahn/kong -plugins-directory /Users/karuppiahn/kong-golang-plugins-dir
...
```

Too many info, but I found it finally. It at the end üòÖ Easy for me! :D

Anyways, found the plugin server.

Now, let's hit kong admin api

```
$ curl localhost:8001/routes | pbcopy
{"next":null,"data":[{"strip_path":true,"path_handling":"v0","paths":null,"destinations":null,"headers":null,"protocols":["http","https"],"created_at":1579074924,"snis":null,"hosts":["kafka-upstream.dev"],"name":"kafka-upstream","service":null,"preserve_host":false,"regex_priority":0,"tags":null,"sources":null,"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8","https_redirect_status_code":426,"updated_at":1579074924,"methods":null}]}
```


```
$ curl localhost:8001/routes/kafka-upstream/plugins
{"next":null,"data":[{"created_at":1579074924,"consumer":null,"id":"d350f442-ffc6-5ebd-b8ea-21a2d9e242c5","service":null,"enabled":true,"tags":null,"name":"kafka-upstream-golang","protocols":["grpc","grpcs","http","https"],"route":{"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8"}}]}
```

For some reason, I think the `plugins` config might be causing this and
that this not be working as expected?

Something similar happened before, weird stuff, but last it said

```
{"message":"no Route found with those values"}
```

Now it says

```
{"message":"no Service found with those values"}
```

Hmm. Let's restart for now, and then see again. 

Damn, same error. Let's fix that `plugins` configuration!

Adding this to `.env`

```
export KONG_PLUGINS="bundled,kafka-upstream-golang"
```

```
$ source .env
$ kong start
...
...
panic: interface conversion: plugin.Symbol is *string, not string

goroutine 1 [running]:
main.(*PluginServer).GetPluginInfo(0xc0000120a0, 0x7ffeefbfef20, 0x15, 0xc0000d3e40, 0x0, 0x0)
        /Users/karuppiahn/oss/github.com/kong/go-pluginserver/pluginserver.go:259 +0x806
main.dumpInfo()
        /Users/karuppiahn/oss/github.com/kong/go-pluginserver/main.go:48 +0x8e
main.main()
        /Users/karuppiahn/oss/github.com/kong/go-pluginserver/main.go:114 +0x73
2020/01/15 13:49:39 [error] 23230#0: init_by_lua error: /usr/local/share/lua/5.1/MessagePack.lua:813: missing bytes
stack traceback:
        [C]: in function 'error'
        /usr/local/share/lua/5.1/MessagePack.lua:813: in function 'underflow'
        /usr/local/share/lua/5.1/MessagePack.lua:529: in function 'unpack_cursor'
        /usr/local/share/lua/5.1/MessagePack.lua:843: in function 'unpack'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:383: in function 'get_plugin_info'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:392: in function 'get_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:426: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:151: in function 'load_plugin_handler'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:227: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:275: in function 'load_plugin_schemas'
        /usr/local/share/lua/5.1/kong/init.lua:425: in function 'init'
        init_by_lua:3: in main chunk
nginx: [error] init_by_lua error: /usr/local/share/lua/5.1/MessagePack.lua:813: missing bytes
stack traceback:
        [C]: in function 'error'
        /usr/local/share/lua/5.1/MessagePack.lua:813: in function 'underflow'
        /usr/local/share/lua/5.1/MessagePack.lua:529: in function 'unpack_cursor'
        /usr/local/share/lua/5.1/MessagePack.lua:843: in function 'unpack'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:383: in function 'get_plugin_info'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:392: in function 'get_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins/go.lua:426: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:151: in function 'load_plugin_handler'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:227: in function 'load_plugin'
        /usr/local/share/lua/5.1/kong/db/dao/plugins.lua:275: in function 'load_plugin_schemas'
        /usr/local/share/lua/5.1/kong/init.lua:425: in function 'init'
        init_by_lua:3: in main chunk
Error: /usr/local/share/lua/5.1/kong/cmd/start.lua:64: failed to start nginx (exit code: 1)

  Run with --v (verbose) or --vv (debug) for more details
```

Wow, big error. Hmm. Let's fix it! :)

Looking at exactly this line

```
panic: interface conversion: plugin.Symbol is *string, not string
```

Looks like the problem might be our `Version` string. Let's dig
further and confirm it though!

Weird how we have defined the `Version` as a string, but in the code
over here

https://github.com/Kong/go-pluginserver/blob/0.2.0/pluginserver.go#L259

it fails. Looking at the code further over here which is part of golang
std library `plugin`

https://godoc.org/plugin#Plugin.Lookup

```
// Lookup searches for a symbol named symName in plugin p.
// A symbol is any exported variable or function.
// It reports an error if the symbol is not found.
// It is safe for concurrent use by multiple goroutines.
func (p *Plugin) Lookup(symName string) (Symbol, error) {
	return lookup(p, symName)
}
```

And symbol - https://godoc.org/plugin#Symbol

Symbol is actually a `pointer` to a `variable` or `function`.

Notice how they say it's a pointer. And there's also a sample code in
the same place where they show

```
*v.(*int) = 7
```

I think they are taking up the `interface{}` and converting it to `*int`
and then dereferencing it and then giving a value to the integer.
That's my wild guess

Is it possible that the plugin server code is wrong? ü§î I mean, if they
haven't tried an golang plugin with versions or priority, then it's
possible. Only one way to find out. I'll change the golang plugin
server code and then try it out :)

So, I'm going to change the code to this -

```
v, _ := plug.code.Lookup("Version")
if v != nil {
  info.Version = *v.(*string)
}

prio, _ := plug.code.Lookup("Priority")
if prio != nil {
  info.Priority = *prio.(*int)
}
```

Let me build it and install

```
$ go install -v .
```

Let's start kong now :)

```
$ kong start
```

Wow! Everything works! :D I can even see a log line for the golang
plugin server

```
2020/01/15 14:19:09 [notice] 55391#0: *16 [kong] go.lua:69 Starting go-pluginserver, context: ngx.timer
```

So, what does this say? Only now the plugin was loaded, and there was
an error while loading, and the service not found error was most
probably because the plugin didn't exist.

I have seen something similar before - where I named the plugin wrong
while configuring it in the routes. No where I saw proper error
messages. Weird. Hmm. May be I could raise an issue regarding this and
one regarding the version and priority variable and may be even raise a
PR for it :) and for others too if I can ;)

And wow, I directly tried this -

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev'
{"message":"you are da best! :D"}
```

and it worked :D :D

Let's check plugin version now, and see if kong shows it :)

```
$ curl localhost:8001/plugins
{"next":null,"data":[{"created_at":1579078148,"config":{},"id":"d350f442-ffc6-5ebd-b8ea-21a2d9e242c5","service":null,"name":"kafka-upstream-golang","tags":null,"consumer":null,"protocols":["grpc","grpcs","http","https"],"route":{"id":"0c526b08-ede8-5178-bef7-1e59d3503ae8"},"enabled":true}]} 

$ curl localhost:8001/plugins/kafka-upstream-golang
{"message":"invalid primary key: '{id=\"expected a valid UUID\"}'","name":"invalid primary key","fields":{"id":"expected a valid UUID"},"code":1}
```

It's weird how I can't use the plugin name üòÖ and I don't get how
`/plugins` endpoint is also showing details about which route the
plugin is enabled for, hmm. Maybe I got the wrong idea about that
endpoint. Let me check the docs to see what other endpoints are there
to check plugin info :)

Looks like I can't find much on how to check the version. Right. Only
in Kong hub, version shows up on the top right

https://docs.konghq.com/hub/kong-inc/prometheus/

Let me check kong code to see how the plugin info is used!

Okay, I searched kong code a lot, but couldn't find a single place
where `VERSION` field is shown outside to the user. It was just used
in tests to make sure it's present. I did see priority being used. Hmm.
Weird. May be it's used in the docs site, I don't know. I could check
that

Nothing much in kong docs repo too. Okay, I'll leave that for now!
Let's get back to our work üôà We have been doing so much stuff around
this - running kong in local, plugins in local, plugin server in local,
running without db and instead using config file, updating kong and
using some new features, checking how to add version (may be this was
too much? :P üôà) and priority, finding out it doesn't work exactly. Then
fixing that in golang plugin server and then checking where it's shown
to the user to understand why it exists (lol üôà). Finally, back to Kafka
stuff! Finally! We have done version stuff, also checked that the
plugin works :)

So, now, let's run kakfa once and see how to produce and consume
messages, so that we know how to test our plugin works when we use it!

I'm going to be using this web page to try things out

https://kafka.apache.org/quickstart

I'll follow the steps in it :)

Downloading the tar ball from here - 

http://apachemirror.wuchna.com/kafka/2.4.0/kafka_2.12-2.4.0.tgz

extracted it. Next

```
$ cd ~/Downloads/kafka_2.12-2.4.0/
```

starting zookeeper

```
$ bin/zookeeper-server-start.sh config/zookeeper.properties
```

In another terminal, start kafka server

```
$ bin/kafka-server-start.sh config/server.properties
```

Creating a `test` topic

```
$ bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic test
```

Let's send some messages using a producer

```
$ bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test

>ok
>haha
>lol
```

Start a consumer too

```
$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
ok
haha
lol
```

notice how I say I want to consume messages from the start of the topic!

There's more info on how to run more brokers. I'm not going to go deep
into the details for now. I think this is good for us to test if our
plugin will work - like the basic features at least :)

Now, I'm going to check some kafka golang libraries!

I have seen quite some libraries now. Like, just links, not docs. But I
am not going to spend too much time checking if it's good or bad. I'll
just check if it works for now, we can swap out and change the library
anytime we want to. May be I can write some interface and make sure we
don't have to make much code changes to swap out stuff. Let's see. So,
here are some links that I saw

https://github.com/segmentio/kafka-go
https://github.com/confluentinc/confluent-kafka-go
https://github.com/optiopay/kafka
https://github.com/jdamick/kafka
https://github.com/elodina/go_kafka_client
https://github.com/Shopify/sarama

Now, the functionality we want is - first, it needs to be a library,
that is, a golang package. And what kind of library? a kafka client
library. with what functionality? to be able to produce kafka messages
in a topic :)

I have seen some people talk about confluent one and shopify one too.
I'm just blindly gonna go with shopofy one, which has more stars üòÖ
üôà

So, now, let's see how to use it and let's send, umm, our request body?
to a test kafka topic :) in a JSON format. Let's say I send post http
requests with some body, to kong, at a particular route which has our
plugin enabled, and the plugin sends the post message body to kafka
in a topic like this

```
{ "body": "random post body message" }
{ "body": "{ \"someKey\": \"someValue\" }" }
```

Let's make this happen! üòé

Okay, so I'm looking at this example code, where there's an http server.
It looks pretty cool. This is how they tell about it -

```
http_server is a simple HTTP server uses both the sync producer to produce data as part of the request handling cycle, as well as the async producer to maintain an access log. It also uses the mocks subpackage to test both.
```

So, we have examples for both synchronous producer and asynchronous
producer. This is the folder -

https://github.com/Shopify/sarama/tree/master/examples

And I was seeing this code - 

https://github.com/Shopify/sarama/blob/master/examples/http_server/http_server.go

Now, I'm going to use the sync producer to start with. Let's hardcode
all the details and make it work first! :)

I was copy pasting some code, but code completion will work only if I
download the library, so I did just that

```
$ go get -u -v github.com/Shopify/sarama
```

Now, gonna use the code

```
producer, err := sarama.NewSyncProducer(brokerList, config)
if err != nil {
  log.Fatalln("Failed to start Sarama producer:", err)
}
```

Gotta put some config and broker list now!

```
func New() interface{} {
	brokerList := []string{"localhost:9092"}
	config := sarama.NewConfig()
	config.Producer.RequiredAcks = sarama.WaitForAll // Wait for all in-sync replicas to ack the message
	config.Producer.Retry.Max = 10                   // Retry up to 10 times to produce the message
	config.Producer.Return.Successes = true
	producer, err := sarama.NewSyncProducer(brokerList, config)
	if err != nil {
		log.Fatalln("Failed to start Sarama producer:", err)
	}
	return &PluginConfig{Producer: producer}
}
```

So, that's my code now. Mostly copy pasted from the example. :)

Next, I'm going to write code to send the kafka message. Not writing
any tests for now üôà Just seeing if things work first :)

```
type JSONEncoder string

func (jsonEncoder JSONEncoder) Length() int {
	data, err := jsonEncoder.Encode()
	if err != nil {
		return 0
	}
	return len(data)
}

func (conf *PluginConfig) Access(kong *pdk.PDK) {
	body, err := kong.Request.GetRawBody()
	if err != nil {
		sendError(kong, err)
		return
	}

	_, _, err = conf.Producer.SendMessage(&sarama.ProducerMessage{
		Topic: "test",
		Value: JSONEncoder(body),
	})
	if err != nil {
		sendError(kong, err)
		return
	}

	err = kong.Response.Exit(200, map[string]interface{}{"message": "message sent"}, nil)
	if err != nil {
		_ = kong.Log.Err(err.Error())
	}
}

func sendError(kong *pdk.PDK, err error) {
	exitErr := kong.Response.Exit(200, map[string]interface{}{
		"message": "message not sent :/",
		"error":   err.Error(),
	}, nil)
	if exitErr != nil {
		_ = kong.Log.Err(err.Error())
	}
}
```

and I just guessed that bootstrap server, which is `localhost:9092`,
is the broker. As I couldn't find any other option under

```
$ bin/kafka-console-consumer.sh --help
```

Okay, now, let me build the plugin! :)

```
$ make
$ cp kafka-upstream-golang.so $KONG_GO_PLUGINS_DIR
```

Let's start kong! I stopped it and started it off!

```
$ kong start
```

Let's hit the proxy now!

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev'
{"message":"message sent"}

$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -X POST -d 'random post body message'
{"message":"message sent"}

$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -X POST -d '{"someKey": "someValue"}'
{"message":"message sent"}
```

Wow! And I had the consumer running

```
$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
ok
haha
lol
 ok
hehe

""
"random post body message"
"{\"someKey\": \"someValue\"}"
```

I actually missed to put the message under `body` key üòÖ Let me just do
that :)

I changed the code to this

```
	jsonData, err := json.Marshal(map[string]interface{}{"body": jsonEncoder})
```

And then rebuilt

```
$ make
$ cp kafka-upstream-golang.so $KONG_GO_PLUGINS_DIR
```

And then restarted kong, by stopping and starting it again

```
$ kong start
```

And then did this

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -X POST -d '{"someKey": "someValue"}'
{"message":"message sent"}
```

And got this in the consumer :D

```
{"body":"{\"someKey\": \"someValue\"}"}
```

Yay! :D

Next things to do is -
1. Check all the configurations of the kafka upstream plugin

https://docs.konghq.com/hub/kong-inc/kafka-upstream/

2. Bring in each configuration one by one :) But I'm not sure how
robust my implementation will be. Let's see :) If someone uses it at
scale, only then I'll know üòÖ 

3. May be write some tests to make things easily testable. Can't run
plugin each time to do stuff. That's like integration test. We need
some tests, so yeah

I'll do this tomorrow may be :)

Damn, I didn't read the "Start with why?" book and I also didn't do
many other stuff on my list. I guess I have to manage my time better
and understand how much time I really have and plan accordingly,
instead of wondering why I don't have time üòÖ and also plan to have
some time for myself. Like, just myself :P
