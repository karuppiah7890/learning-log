# Jan 5th 2020

Possibilities I created through yesterday's learnings on Kong plugins
are:
1. Now I can checkout the enterprise plugins and kind of reverse
engineer the kind of functionality they provide and some possible
implementation details based on their configuration and the details
that they put

2. A new repo in my list of open source repos. I mean, this was
obvious. Just that, I'm going to create something a bit useful for
people who have the usecase for sending messages to Kafka using Kong,
unlike a simple dummy Kong plugin. :)

3. A blog post on the journey may be?

4. A blog post on how to create a Kong plugin that intercepts requests?
which is a very specific type of Kong plugin, as I think there are many
types. In our case, we intercept requests and also respond to it right
away from Kong, without any proxying to upstreams - microservices /
services

Surely I'm saying the term "blog post" a lot. I think I should really
start writing them üôà by copy pasting some of the stuff in my learning
log and keeping things concise too!

Possibilities I created by reading a bit of "Start with Why":
1. Keep asking why to all the stuff, to make good decisions
2. Inspiring people with the ideas in the book

Now, let's get started with the day

## Startup Stuff 1

So, my friend recently spoke about startups and how it would be great
to start one. You know, everyone wants to start a business and be
famous and earn lots. I liked the idea too. But I wanted to keep it
serious and so yesterday I started asking him lots of questions and his
thoughts on tech and stuff like that. We are yet to talk about what
idea we have for the startup and stuff like that.

We just decided that we will keep it small, try to be able to do it
while keeping our day jobs. And check the legality of it too and stuff
like that. I should have written this in my log yesterday itself. But
it's fine. I think I'll write a complete log of what questions we spoke
about and what's the idea in a separate log may be. I have my diary to
help me remember stuff ;)

## Open Source Stuff 1

Now, let's get on and do some work on the Kong plugin! Too much
research but no code üôà But I think it's better to follow this

https://twitter.com/carmatrocity/status/1212060676199526402

you might want checkout the whole thread, it's cool! :D

https://twitter.com/carmatrocity/status/1212057561257656320

So, it says reading documentation is important and it makes you go
faster later but slow initially. 

So, I'll be honest, we still have some very little research to do!
Like, yesterday I was thinking about how to build stuff, but I didn't
finish the answer to "what are we building?" completely. Let's finish
it off!

I actually skimmed through this implementation details -

https://docs.konghq.com/hub/kong-inc/kafka-upstream/#implementation-details

I think now it won't be called reverse engineering üòõ since they gave
answers to some stuff.

It tells about how the request body is handled - when `Content-Type`
is `application/x-www-form-urlencoded`, `multipart/form-data` or 
`application/json`, the raw body is put in `body` key and then
there's a parsed version too in `body_args`. I think that's present
as key-value pairs or something.

There's also a point about how if the `Content-Type` is not 
`text/plain`, `text/html`, `application/xml`, `text/xml` or
`application/soap+xml`, then it is base64 encoded to ensure the message
can be sent in JSON, and there's another key that's set to tell that
the content is base64 encoded, a key called `body_base64` which is
set to `true`

Notice how they talk about JSON? So that's surely our format in which
messages are sent :)

They have put some known issues and limitations too.

So, considering that it has so much stuff, we can start with something
very simple and build more on top of it if there's time and interest :P

Let's define what exactly our plugin will do at an overview at least.

When the plugin is applied, globally or to a particular route or
service, anything, when it receives requests, it will send the request
as a Kafka message to a topic in the configured Kafka. How it is sent
is based on the configuration. To start with, the plugin will support
only `Content-Type: application/json`. Once the plugin is done, it will
send a response `200` with body as `{ "message": "message sent" }`. For
any failures, an appropriate response code (client error / server
error) and message will be sent

I think that's a good definition to start with :)

Let's create a repo now!

```
$ mkdir kong-plugin-kafka-upstream
$ cd kong-plugin-kafka-upstream
$ git init
$ go mod init github.com/karuppiah7890/kong-plugin-kafka-upstream
$ git add .
$ git commit -m "add go.mod"
$ git remote add origin git@github.com:karuppiah7890/kong-plugin-kafka-upstream.git
$ git push -u origin master
```

Cool! Now we have something in a github repo!

https://github.com/karuppiah7890/kong-plugin-kafka-upstream

Let's add a readme to it!

I'm going to say that it's a demo golang plugin? May be if I make it
full fledged, and spend time and maintain it a bit, then I could tell
it's just a plugin and it's an alternative for the enterprise one

May be I'll do the latter ;) Let's see how it all turns out!

I use IntelliJ a lot. I'm going to gitignore it and then add the readme

Okay, now that's done!

I took a small break. And then I was thinking about how enabling this
plugin at a route or service level would work ü§î may be we will come
back to it. I think it cannot be added to service level. The enterprise
plugin info page shows how to add at route level. We can see how it all
makes sense and works later :) For now, I think I'll try the same thing
as what the Enterprise plugin says. Somehow I confused myself thinking
that a route always needs a service behind it, looks like that's not
the case - after checking out the Enterprise plugin example

Now, we have to check the doc at 

http://docs.konghq.com/1.4.x/plugin-development/

and the gist -

https://gist.github.com/guanlan/45df35521b746c28d024691fffc01032

Let me eat my breakfast and come back and continue on that!

Back! Okay, now, let's understand what Kong plugins do using the docs!

Apparently for a complete reference of the PDK - plugin development
kit, we need to check this http://docs.konghq.com/1.4.x/pdk/ it
seems

We'll come back to that. Next in line is this 

http://docs.konghq.com/1.4.x/plugin-development/file-structure/

At a glimpse, most of the stuff here looks very very specific to Lua,
so I'm gonna skip to writing custom logic here

http://docs.konghq.com/1.4.x/plugin-development/custom-logic/

Apparently we can execute custom logic at different phases of the
execution life cycle of Kong

http://docs.konghq.com/1.4.x/plugin-development/custom-logic/#available-contexts

Looking at this, I think we will go with `access`, where it is -
executed for every request from a client and before it is being proxied
to the upstream service.

`rewrite` looked a fit function too, but that's for global plugins
only, where the upstream service is not known. In our case, we are
planning to have route level plugins too. 

A lot of stuff seems next to be very Lua specific. Next comes PDK

http://docs.konghq.com/1.4.x/plugin-development/custom-logic/#plugin-development-kit

So, the PDK provides some lua functions and variables. In our case it
will be golang functions and variables I think. And looks like we can
do stuff like - retrieving request headers, producing a response from
a plugin, logging some error or debug information. That's given as an
example. We'll be using request headers, and producing a response, and
may be even log errors or debugging information, so that's all useful!
:D

Next up is plugin execution order

http://docs.konghq.com/1.4.x/plugin-development/custom-logic/#plugins-execution-order

This is for plugins that depend on the execution of other plugins. In
our case, we aren't going to depend on any other plugin's output or
result. At least with the current definition of our plugin, no. So,
let's not worry about the priority number and go ahead with the next
thing. The next thing seems to be 

http://docs.konghq.com/1.4.x/plugin-development/plugin-configuration/

Apparently, we don't need to specify any schema for our plugin
configuration, according to the github gist that I saw a bit earlier,
so let's skip the schema, or even the configuration. I'm just going to
assume that our configuration will be available to us. Next, I can see
many other sections, like 

Accessing the datastore
Storing custom entities
Caching custom entities
Extending the Admin API

nothing much related to our plugin. And then there's

Writing tests
(un)Installing your plugin

For tests, they have mentioned about integration tests

http://docs.konghq.com/1.4.x/plugin-development/tests/

It's specific to lua. But it might be useful. I'll check it out later.
But we surely need to write unit tests for our plugin to keep it
robust! :)

There's some info on (un)installing plugins here

http://docs.konghq.com/1.4.x/plugin-development/distribution/

I think I'll check it out later. I just skimmed through. I think we'll
be fine for now, as we know how to install golang plugins and we have
also enabled them and seen them working. So, no issues over there, for
a dev environment at least

Now we will be checking the PDK reference here

http://docs.konghq.com/1.4.x/pdk/

I can see some basic things like checking version, using the DB and so
on. But none of this is going to be used in our plugin, so I'm going to
move on

Took a break, was talking about startups to my friend. Back to Kong now

Now, I can see a lot of modules and stuff to help with interacting with
Kong and it's request and response

```
kong.client
kong.ctx
kong.ip
kong.log
kong.nginx
kong.node
kong.request
kong.response
kong.router
kong.service
kong.service.request
kong.service.response
kong.table
```

I'm going to check the `kong.request`, `kong.response` and then check
about `kong.service`, `kong.service.request`, `kong.service.response`.
Only these look related to what we are going to do. Let's see if these
help!

First

http://docs.konghq.com/1.4.x/pdk/kong.request/

This has some lua stuff, I'm going to check if I can find some similar
golang stuff in https://github.com/Kong/go-pdk , for which I'm going to
leverage the powerful golang documentation - https://godoc.org

https://godoc.org/github.com/Kong/go-pdk

Looks like the `PDK` struct has all the fields corresponding to what we
have seen above

```
type PDK struct {
    Client          client.Client
    Log             log.Log
    Nginx           nginx.Nginx
    Request         request.Request
    Response        response.Response
    Router          router.Router
    IP              ip.Ip
    Node            node.Node
    Service         service.Service
    ServiceRequest  service_request.Request
    ServiceResponse service_response.Response
}
```

Awesome, I can find stuff for `request` over here 

https://godoc.org/github.com/Kong/go-pdk/request#Request

And then I can see some `response` stuff here

http://docs.konghq.com/1.4.x/pdk/kong.response

And I can see many `setABC` functions to set things, but I think these
are for changing the data after the upstream behind Kong replies.

I think what we want is the exit function here

http://docs.konghq.com/1.4.x/pdk/kong.response/#kongresponseexitstatus-body-headers

which clearly shows how we can do what we want - interrupt the current
processing and produce a response, in lua

In golang, I can't really see anything of that sort

https://godoc.org/github.com/Kong/go-pdk/response

I'm afraid it might not be possible to do the exit functionality in
golang similar to lua. Hmm

Let me dig into the code of golang PDK. May be they didn't document the
exit method or something

Oops. The code over here 

https://github.com/Kong/go-pdk/blob/b5672ac3fca7da76a2290a551fe308ef7388bb91/response/response.go#L60

says `TODO exit` üôà damn. May be I think I'll write code for this and
then use that? That's the only go for now, if I want to continue
working on this plugin. Or else I have to wait for someone to write the
code for it. Why wait when you can do it yourself? üòé The only fear is,
the programmers did so much, I can see the code for other methods,
and it looks good. Not sure why they left out `exit` alone ü§î It was
probably tough? üôà Anyways, let that not stop me üòé I'm also planning to
raise a PR to the `go-pdk` repo. Created an issue for it 

https://github.com/Kong/go-pdk/issues/16

Also, on Twitter, Kong said they are looking forward to checking out my
plugin ;) :D

https://twitter.com/thekonginc/status/1213703680869847041

Now, let's get the lua code and see what's happening in the lua pdk
code or the Kong core code, wherever these modules / methods are
present :P Let's dive in!

Also, forking the `go-pdk` code for the PR!

https://github.com/karuppiah7890/go-pdk

Took a small break, back now!

I'm coding in a new branch called `add-response-exit-method` and I have
already done two commits - small ones, one is a gitignore for my
`.idea` dir, and then a `go.mod` and a `go.sum` :)

Next, gonna find the lua code for `kong.response.exit` !

Okay, looks like there's no separate repo for the module, so, it must
be inside the core kong repo! github.com/Kong/kong

I'm on branch `release/2.0.0` and gonna open it in code

```
$ code .
```

Okay, neat! I can see a directory path `kong/pdk` in the repo, and
there's a `response.lua` file in it. I think this is the file

And the function is this I guess

```
function _RESPONSE.exit(status, body, headers)
```

https://github.com/Kong/kong/blob/release/2.0.0/kong/pdk/response.lua#L704

Okay, so, looking at the other function implementations in the go-pdk
library, I'm just going to do something similar

For example, for `kong.response.set_headers`, the implementation looks
like

```
func (r Response) SetHeaders(headers map[string]interface{}) error {
	_, err := r.Ask(`kong.response.set_headers`, headers)
	return err
}
```

So, for `kong.response.exit`, I'm going to put something similar, like
this

```
func (r Response) Exit(status int, body interface{}, headers map[string]interface{}) error {
	_, err := r.Ask(`kong.response.exit`, status, body, headers)
	return err
}
```

But I don't know about what the return data would be or it's type. I'm
going to assume for that it's not needed. And go ahead and see how it
works :)

Also, in lua pdk, looks like the exit method had some optional
arguments like `body` and `headers`, but I made them as explicit
arguments, and if people don't want to send it, then they can use
`nil` as arguments :)

And the reason to keep `body` as `interface{}` is that, in the lua code
I can see that it can be a string or a table, which I think means an
object or a map. So, to accomodate both strings and maps, I put that.
Not sure if sending struct will also work ü§∑‚Äç‚ôÇ

Now, let's push these changes and use my version of pdk now and see how
everything works out!

By the way, looks like there are also some tests in this file
`response_test.go` here

https://github.com/Kong/go-pdk/blob/f9e6488e0a4419b849c0308949fa56c04eb6c5ba/response/response_test.go

I think I'll add some tests for the `Exit` function ;)

Added it! :D

```
func TestExit(t *testing.T) {
	var headers map[string]interface{} = nil
	var body interface{} = nil
	status := 200
	assert.Equal(t, bridge.StepData{Method: "kong.response.exit", Args: []interface{}{status, body, headers}}, getBack(func() { response.Exit(status, body, headers) }))
}
```

Now, let's get test this completely and then push commits and start
using it in the `go-pluginserver` and then in my new Kafka Upstream
plugin ;)

```
$ go test -v ./...
```

I also `gofmt`ed all the files and then `goimports`ed all the files

```
$ gofmt -w .
$ git commit -m "gofmt all the files"
$ goimports -w .
$ git commit -m "goimports all the files"
```

The lint using `golint` is failing, that's because there are no
comments on exported functions to start with, and probably other
issues. I'm going to leave them for now.

Let's push! :D

```
$ git push --set-upstream origin add-response-exit-method
```

Now, on to the `go-pluginserver` code to import my code!

I changed the `go.mod` to include my pdk code

```
	github.com/karuppiah7890/go-pdk v0.0.0-20200105134008-9e1d5d9b5824
```

Now, going insider docker container to build for linux :)

```
$ docker run --rm -it -v $(pwd):/go-pluginserver golang bash
$ cd /go-pluginserver/
$ go build -v
go: github.com/karuppiah7890/go-pdk@v0.0.0-20200105134008-9e1d5d9b5824: parsing go.mod:
        module declares its path as: github.com/Kong/go-pdk
                but was required as: github.com/karuppiah7890/go-pdk
```

So, I kept getting this error and I thought I had to change all the
references in the plugin server codebase, only to realize it was
talking about my module, and not the plugin server codebase ü§¶‚Äç‚ôÇ

So, the go compiler is talking about my fork, which has been required
as `github.com/karuppiah7890/go-pdk` but the module, that is the
`go.mod` declares it's path as `github.com/Kong/go-pdk`. I need to go
change the `go.mod` in my fork üòÖ Let's do that now

So, I had to change `go.mod` file and all the other references, around
37 of them (!) in all the modules where internal packages were referred

And all the tests pass

```
$ go test -v ./...
```

So, I'm committing it and pushing ;)

Now chaging the plugin server code `go.mod`

```
github.com/karuppiah7890/go-pdk 77a4ed705c082aa0bf37e7f5ba27fe9209d4805a
```

and then

```
$ go mod tidy -v
go: downloading github.com/karuppiah7890/go-pdk v0.0.0-20200105135504-77a4ed705c08
go: finding github.com/Kong/go-pdk latest
go: extracting github.com/karuppiah7890/go-pdk v0.0.0-20200105135504-77a4ed705c08
```

Now, I'll build inside container

```
$ go build -v
```

Now that that's done, let's run Kong and copy the `go-pluginserver` to
it and then create a simple plugin functionality in my Kafka Upstream
Plugin!

The most basic functionality I'm thinking of is - no connection to
Kafka, lol. Just enable plugin, and plugin will respond with 200 OK
using the exit function that we have just created. I think that's a
good starting point. Then we can look at some Kafka libraries and then
connect to Kafka and stuff

Okay, I just noticed that there was a mix of my go-pdk and official
kong pdk in `go-pluginserver`, I realized I didn't change some imports.
Did that just now. I need to get better at find and replace üòõ

Now, build again!

Now, I'm going to start my existing `kong-database` and `kong`
containers. `kong` container is just going to run `bash`. I'll have to
start `kong` myself, after running `go-pluginserver`

Now, copy!

```
$ docker cp go-pluginserver kong:/usr/local/bin/go-pluginserver
```

Done. Now, let's create a plugin finally with a simple functionality,
in our Kafka Upstream plugin

Let's check the gist

https://gist.github.com/guanlan/45df35521b746c28d024691fffc01032

So, according to this, we need to define a struct type to hold our
configuration. To start with, let's not have anything in our config and
we can build upon it later :)

```
type PluginConfig struct {}
```

Okay, now, we need to create a function `New` that creates an instance
of this type and returns `interface{}`

```
func New() interface{} {
    return &PluginConfig{}
}
```

Now that's done. Next, we need to define methods on the `PluginConfig`
struct to handle events. In our case, it's `Access`

```
func (conf *PluginConfig) Access (kong *pdk.PDK) {
	err := kong.Response.Exit(200, nil, nil)
	if err != nil {
		_ = kong.Log.Err(err)
	}
}
```

In this case, I used my `Exit` function, and I also logged any errors
that's encountered. I ignored the error that comes up while logging.
I just assumed this is how logging would look. We can check the demo
plugin in `go-plugins` repo here https://github.com/kong/go-plugins

So, looking at this, we are right about the logging

https://github.com/Kong/go-plugins/blob/master/go-hello.go#L23

Just that they logged using `err.Error()` string. So, I'll change that
alone in my code :)

```
func (conf *PluginConfig) Access (kong *pdk.PDK) {
	err := kong.Response.Exit(200, nil, nil)
	if err != nil {
		_ = kong.Log.Err(err.Error())
	}
}
```

Now, let's build it! :D inside a container

```
$ docker run --rm -it -v $(pwd):/kong-plugin-kafka-upstream golang bash
$ cd /kong-plugin-kafka-upstream/
```

Now, I made some mistakes while building üòÖ I'll put the whole thing
here to show the mistakes :)

```
$ go build -v -buildmode=plugin . -o kafka-upstream-golang
go: downloading github.com/karuppiah7890/go-pdk v0.0.0-20200105135504-77a4ed705c08
go: extracting github.com/karuppiah7890/go-pdk v0.0.0-20200105135504-77a4ed705c08
go: finding github.com/karuppiah7890/go-pdk v0.0.0-20200105135504-77a4ed705c08
can't load package: package -o: malformed module path "-o": leading dash
can't load package: package kafka-upstream-golang: malformed module path "kafka-upstream-golang": missing dot in first path element

$ go build -v -buildmode=plugin -o kafka-upstream-golang .
-buildmode=plugin requires exactly one main package

$ go build -v -buildmode=plugin -o kafka-upstream-golang .
internal/cpu
runtime/internal/sys
runtime/internal/atomic
math/bits
runtime/internal/math
unicode/utf8
internal/race
sync/atomic
internal/bytealg
math
unicode
internal/testlog
runtime
github.com/karuppiah7890/go-pdk/entities
runtime/cgo
sync
internal/reflectlite
errors
sort
io
strconv
internal/oserror
syscall
github.com/karuppiah7890/go-pdk/bridge
github.com/karuppiah7890/go-pdk/ip
github.com/karuppiah7890/go-pdk/log
github.com/karuppiah7890/go-pdk/nginx
github.com/karuppiah7890/go-pdk/node
github.com/karuppiah7890/go-pdk/request
github.com/karuppiah7890/go-pdk/response
reflect
github.com/karuppiah7890/go-pdk/router
github.com/karuppiah7890/go-pdk/service
github.com/karuppiah7890/go-pdk/service/request
github.com/karuppiah7890/go-pdk/service/response
internal/syscall/unix
time
internal/poll
os
internal/fmtsort
fmt
github.com/karuppiah7890/go-pdk/client
github.com/karuppiah7890/go-pdk
github.com/karuppiah7890/kong-plugin-kafka-upstream

$ ls -al
total 4168
drwxr-xr-x 10 root root     320 Jan  5 14:33 .
drwxr-xr-x  1 root root    4096 Jan  5 14:33 ..
drwxr-xr-x 10 root root     320 Jan  5 14:26 .git
-rw-r--r--  1 root root       7 Jan  5 05:03 .gitignore
drwxr-xr-x  7 root root     224 Jan  5 14:26 .idea
-rw-r--r--  1 root root     387 Jan  5 05:01 README.md
-rw-r--r--  1 root root     144 Jan  5 14:26 go.mod
-rw-r--r--  1 root root    1122 Jan  5 14:26 go.sum
-rw-r--r--  1 root root 4243392 Jan  5 14:33 kafka-upstream-golang
-rw-r--r--  1 root root     288 Jan  5 14:33 kafka_upstream.go
```

Now that our plugin is ready ;) let's run it in our Kong :D :D

I named our plugin `kafka-upstream-golang`, but it's supposed to have
a `.so` at the end, so, let me change that first

```
$ mv kafka-upstream-golang kafka-upstream-golang.so
```

Next, copy to kong container

```
$ docker cp kafka-upstream-golang.so kong:/root/golang-plugins
```

Now, let's get into Kong container and run the plugin server

```
$ cd /usr/local/kong
$ go-pluginserver -socket go_pluginserver.sock
```

In another Kong container shell, change permissions of the socket
file

```
$ docker exec -it kong bash
$ cd /usr/local/kong/
$ chmod 777 go_pluginserver.sock
$ ls -al go_pluginserver.sock
srwxrwxrwx 1 root root 0 Jan  5 14:40 go_pluginserver.sock
```

Next, let's make sure our configuration is right

```
$ vi /etc/kong/kong.conf
...
...
plugins = bundled,go-hello,kafka-upstream-golang
...
...
```

Everything is good, I just added our plugin for now.

Let's start Kong now! :D

```
/docker-entrypoint.sh kong docker-start
2020/01/05 14:43:41 [notice] 55#0: [kong] iam-ecs-credentials.lua:31 No ECS environment variables found for IAM
2020/01/05 14:43:41 [notice] 55#0: using the "epoll" event method
2020/01/05 14:43:41 [notice] 55#0: openresty/1.15.8.2
2020/01/05 14:43:41 [notice] 55#0: built by gcc 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.12)
2020/01/05 14:43:41 [notice] 55#0: OS: Linux 4.9.184-linuxkit
2020/01/05 14:43:41 [notice] 55#0: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2020/01/05 14:43:41 [notice] 55#0: start worker processes
2020/01/05 14:43:41 [notice] 55#0: start worker process 76
2020/01/05 14:43:41 [notice] 55#0: start worker process 77
2020/01/05 14:43:41 [notice] 55#0: start worker process 78
2020/01/05 14:43:41 [notice] 55#0: start worker process 79
2020/01/05 14:43:41 [warn] 79#0: *4 [lua] globalpatches.lua:52: sleep(): executing a blocking 'sleep' (0.001 seconds), context: init_worker_by_lua*
2020/01/05 14:43:41 [notice] 76#0: *3 [lua] cache_warmup.lua:45: cache_warmup_single_entity(): Preloading 'services' into the cache ..., context: init_worker_by_lua*
2020/01/05 14:43:44 [notice] 76#0: *3 [lua] cache_warmup.lua:84: cache_warmup_single_entity(): finished preloading 'services' into the cache (in 2963ms), context: init_worker_by_lua*
2020/01/05 14:43:44 [notice] 76#0: *3 [lua] cache_warmup.lua:45: cache_warmup_single_entity(): Preloading 'plugins' into the cache ..., context: init_worker_by_lua*
2020/01/05 14:43:44 [notice] 76#0: *3 [lua] cache_warmup.lua:84: cache_warmup_single_entity(): finished preloading 'plugins' into the cache (in 55ms), context: init_worker_by_lua*
2020/01/05 14:43:44 [notice] 76#0: *17 [lua] cache_warmup.lua:25: warming up DNS entries ..., context: ngx.timer
2020/01/05 14:43:44 [notice] 76#0: *17 [lua] cache_warmup.lua:35: finished warming up DNS entries' into the cache (in 56ms), context: ngx.timer
```

Now, let's configure using the configuration similar to what was there
in the enterprise plugin -
https://docs.konghq.com/hub/kong-inc/kafka-upstream/#quickstart

```
$ curl -X POST http://localhost:8001/routes \
     --data "name=kafka-upstream" \
     --data "hosts[]=kafka-upstream.dev"

{"id":"5766e5ec-a5e7-4792-8ce4-cc7bcca07db6","path_handling":"v0","paths":null,"destinations":null,"headers":null,"protocols":["http","https"],"methods":null,"snis":null,"service":null,"name":"kafka-upstream","strip_path":true,"preserve_host":false,"regex_priority":0,"updated_at":1578235500,"sources":null,"hosts":["kafka-upstream.dev"],"https_redirect_status_code":426,"tags":null,"created_at":1578235500}
```

```
$ curl -X POST http://localhost:8001/routes/kafka-upstream/plugins \
     --data "name=kafka-upstream-golang"

{"created_at":1578235567,"config":{},"id":"e3de31b5-dc0b-41a9-9663-57bdc2ad884a","service":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"kafka-upstream-golang","consumer":null,"route":{"id":"5766e5ec-a5e7-4792-8ce4-cc7bcca07db6"},"tags":null}
```

Okay, now we can try to trigger the route by using the following
curl 

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -i
HTTP/1.1 200 OK
Date: Sun, 05 Jan 2020 14:47:35 GMT
Connection: keep-alive
Content-Length: 0
X-Kong-Response-Latency: 8
Server: kong/2.0.0rc1
```

Wow!!! :D I guess we should have put some body in that message :P

Let me see if some other host works :P It shouldn't ideally

```
$ curl http://localhost:8000 --header 'Host: kafka-blah.dev' -i
HTTP/1.1 200 OK
Content-Type: text/html; charset=ISO-8859-1
Transfer-Encoding: chunked
Connection: keep-alive
Date: Sun, 05 Jan 2020 14:49:00 GMT
Expires: -1
Cache-Control: private, max-age=0
P3P: CP="This is not a P3P policy! See g.co/p3phelp for more info."
Server: gws
X-XSS-Protection: 0
X-Frame-Options: SAMEORIGIN
Set-Cookie: 1P_JAR=2020-01-05-14; expires=Tue, 04-Feb-2020 14:49:00 GMT; path=/; domain=.google.com
Set-Cookie: NID=195=dR-vklSriytlKBQuI7DMZ6PJqaGTlZJhf9raluVeR4H4Jln576A7orV9-vsUdZ74QmzvF-AtpQe2K0F9c8jo0Hojc2EWd1B6MkFqmZoUG1XUdP6mCFOWP1v3bnOrRnIrDz5NETQ1A7kPIKpvf8pCSxQiLTk8CvUloAs8KtkXMQ0; expires=Mon, 06-Jul-2020 14:49:00 GMT; path=/; domain=.google.com; HttpOnly
Accept-Ranges: none
Vary: Accept-Encoding
X-Kong-Upstream-Latency: 71
X-Kong-Proxy-Latency: 10
Via: kong/2.0.0rc1

<!doctype html><html itemscope="" itemtype="http://schema.org/WebPage" lang="en-IN"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type"><meta content="/images/branding/googleg/1x/googleg_standard_color_128dp.png" itemprop="image"><title>Google</title><script nonce="1/dmvtu0z5ENPmniAgA6iw==">(function(){window.google={kEI:'XPcRXt66L6KX4-EPxaCImA8',kEXPI:'0,18168,183888,1151690,5663,730,224,4727,378,206,2955,249,10,168,545,338,175,364,1118,36,3,278,4,60,2,313,175,252,41,167,10,1129468,143,1197724,425,38,329080,1294,12383,4855,32692,15247,867,28684,369,3314,5505,8384,1700,3159,1361,284,4039,4967,774,2250,3894,850,3118,6196,1719,1808,1976,2044,5762,1,3146,1911,3386,2054,920,873,1217,1336,1639,2785,1509,1720,1,415,1141,9293,252,621,2882,17,1,321,689,2483,975,1,369,1396,1381,520,399,992,1285,8,2796,967,612,14,1279,390,1583,241,200,328,149,1103,840,517,1474,48,820,3438,260,52,1132,4,3,2063,606,1839,184,595,1182,143,377,686,1261,747,429,44,1009,93,328,1284,16,84,417,1760,666,45,1,1593,607,474,1339,29,719,1039,2757,470,773,1548,524,7,521,207,592,1574,1879,826,489,1545,5320,1193,299,2533,257,215,2,365,170,871,1042,374,2084,2631,57,842,2283,440,369,1275,108,1246,25,1002,653,482,808,99,2,433,1362,235,1159,366,881,993,258,265,361,1033,2,120,9,426,507,78,360,97,1494,525,46,361,63,562,3,464,94,37,818,850,65,1,109,10,2,16,146,138,442,155,218,959,497,26,230,776,194,6,15,271,4,426,143,7,258,86,364,329,11,174,47,1,137,186,574,104,273,173,1194,229,92,3,383,50,5858381,1873,1804020,4194851,2801171,549,333,444,1,2,80,1,900,896,1,8,1,2,2551,1,748,141,59,736,563,1,4265,1,1,1,1,137,1,802,77,9,168,4,2,2,4,5,6,2,4,2,222,23664294,299994',authuser:0,kscs:'c9c918f0_XPcRXt66L6KX4-EPxaCImA8',kGL:'IN',kBL:'v77x'};google.sn='webhp';google.kHL='en-IN';google.jsfs='Ffpdje';})();(function(){google.lc=[];google.li=0;google.getEI=function(a){for(var b;a&&(!a.getAttribute||!(b=a.getAttribute("eid")));)a=a.parentNode;return b||google.kEI};google.getLEI=function(a){for(var b=null;a&&(!a.getAttribute||!(b=a.getAttribute("leid")));)a=a.parentNode;return b};google.https=function(){return"https:"==window.location.protocol};google.ml=function(){return null};google.time=function(){return(new Date).getTime()};google.log=function(a,b,e,c,g){if(a=google.logUrl(a,b,e,c,g)){b=new Image;var d=google.lc,f=google.li;d[f]=b;b.onerror=b.onload=b.onabort=function(){delete d[f]};google.vel&&google.vel.lu&&google.vel.lu(a);b.src=a;google.li=f+1}};google.logUrl=function(a,b,e,c,g){var d="",f=google.ls||"";e||-1!=b.search("&ei=")||(d="&ei="+google.getEI(c),-1==b.search("&lei=")&&(c=google.getLEI(c))&&(d+="&lei="+c));c="";!e&&google.cshid&&-1==b.search("&cshid=")&&"slh"!=a&&(c="&cshid="+google.cshid);a=e||"/"+(g||"gen_204")+"?atyp=i&ct="+a+"&cad="+b+d+f+"&zx="+google.time()+c;/^http:/i.test(a)&&google.https()&&(google.ml(Error("a"),!1,{src:a,glmm:1}),a="");return a};}).call(this);(function(){google.y={};google.x=function(a,b){if(a)var c=a.id;else{do c=Math.random();while(google.y[c])}google.y[c]=[a,b];return!1};google.lm=[];google.plm=function(a){google.lm.push.apply(google.lm,a)};google.lq=[];google.load=function(a,b,c){google.lq.push([[a],b,c])};google.loadAll=function(a,b){google.lq.push([a,b])};}).call(this);google.f={};(function(){document.documentElement.addEventListener("submit",function(b){var a;if(a=b.target){var c=a.getAttribute("data-submitfalse");a="1"==c||"q"==c&&!a.elements.q.value?!0:!1}else a=!1;a&&(b.preventDefault(),b.stopPropagation())},!0);}).call(this);var a=window.location,b=a.href.indexOf("#");if(0<=b){var c=a.href.substring(b+1);/(^|&)q=/.test(c)&&-1==c.indexOf("#")&&a.replace("/search?"+c.replace(/(^|&)fp=[^&]*/g,"")+"&cad=h")};</script><style>#gbar,#guser{font-size:13px;padding-top:1px !important;}#gbar{height:22px}#guser{padding-bottom:7px !important;text-align:right}.gbh,.gbd{border-top:1px solid #c9d7f1;font-size:1px}.gbh{height:0;position:absolute;top:24px;width:100%}@media all{.gb1{height:22px;margin-right:.5em;vertical-align:top}#gbar{float:left}}a.gb1,a.gb4{text-decoration:underline !important}a.gb1,a.gb4{color:#00c !important}.gbi .gb4{color:#dd8e27 !important}.gbf .gb4{color:#900 !important}
</style><style>body,td,a,p,.h{font-family:arial,sans-serif}body{margin:0;overflow-y:scroll}#gog{padding:3px 8px 0}td{line-height:.8em}.gac_m td{line-height:17px}form{margin-bottom:20px}.h{color:#36c}.q{color:#00c}.ts td{padding:0}.ts{border-collapse:collapse}em{font-weight:bold;font-style:normal}.lst{height:25px;width:496px}.gsfi,.lst{font:18px arial,sans-serif}.gsfs{font:17px arial,sans-serif}.ds{display:inline-box;display:inline-block;margin:3px 0 4px;margin-left:4px}input{font-family:inherit}a.gb1,a.gb2,a.gb3,a.gb4{color:#11c !important}body{background:#fff;color:black}a{color:#11c;text-decoration:none}a:hover,a:active{text-decoration:underline}.fl a{color:#36c}a:visited{color:#551a8b}a.gb1,a.gb4{text-decoration:underline}a.gb3:hover{text-decoration:none}#ghead a.gb2:hover{color:#fff !important}.sblc{padding-top:5px}.sblc a{display:block;margin:2px 0;margin-left:13px;font-size:11px}.lsbb{background:#eee;border:solid 1px;border-color:#ccc #999 #999 #ccc;height:30px}.lsbb{display:block}.ftl,#fll a{display:inline-block;margin:0 12px}.lsb{background:url(/images/nav_logo229.png) 0 -261px repeat-x;border:none;color:#000;cursor:pointer;height:30px;margin:0;outline:0;font:15px arial,sans-serif;vertical-align:top}.lsb:active{background:#ccc}.lst:focus{outline:none}</style><script nonce="1/dmvtu0z5ENPmniAgA6iw=="></script></head><body bgcolor="#fff"><script nonce="1/dmvtu0z5ENPmniAgA6iw==">(function(){var src='/images/nav_logo229.png';var iesg=false;document.body.onload = function(){window.n && window.n();if (document.images){new Image().src=src;}
if (!iesg){document.f&&document.f.q.focus();document.gbqf&&document.gbqf.q.focus();}
}
})();</script><div id="mngb"> <div id=gbar><nobr><b class=gb1>Search</b> <a class=gb1 href="http://www.google.co.in/imghp?hl=en&tab=wi">Images</a> <a class=gb1 href="http://maps.google.co.in/maps?hl=en&tab=wl">Maps</a> <a class=gb1 href="https://play.google.com/?hl=en&tab=w8">Play</a> <a class=gb1 href="http://www.youtube.com/?gl=IN&tab=w1">YouTube</a> <a class=gb1 href="http://news.google.co.in/nwshp?hl=en&tab=wn">News</a> <a class=gb1 href="https://mail.google.com/mail/?tab=wm">Gmail</a> <a class=gb1 href="https://drive.google.com/?tab=wo">Drive</a> <a class=gb1 style="text-decoration:none" href="https://www.google.co.in/intl/en/about/products?tab=wh"><u>More</u> &raquo;</a></nobr></div><div id=guser width=100%><nobr><span id=gbn class=gbi></span><span id=gbf class=gbf></span><span id=gbe></span><a href="http://www.google.co.in/history/optout?hl=en" class=gb4>Web History</a> | <a  href="/preferences?hl=en" class=gb4>Settings</a> | <a target=_top id=gb_70 href="https://accounts.google.com/ServiceLogin?hl=en&passive=true&continue=http://www.google.com/" class=gb4>Sign in</a></nobr></div><div class=gbh style=left:0></div><div class=gbh style=right:0></div> </div><center><br clear="all" id="lgpd"><div id="lga"><img alt="Google" height="92" src="/images/branding/googlelogo/1x/googlelogo_white_background_color_272x92dp.png" style="padding:28px 0 14px" width="272" id="hplogo"><br><br></div><form action="/search" name="f"><table cellpadding="0" cellspacing="0"><tr valign="top"><td width="25%">&nbsp;</td><td align="center" nowrap=""><input name="ie" value="ISO-8859-1" type="hidden"><input value="en-IN" name="hl" type="hidden"><input name="source" type="hidden" value="hp"><input name="biw" type="hidden"><input name="bih" type="hidden"><div class="ds" style="height:32px;margin:4px 0"><input class="lst" style="color:#000;margin:0;padding:5px 8px 0 6px;vertical-align:top" autocomplete="off" value="" title="Google Search" maxlength="2048" name="q" size="57"></div><br style="line-height:0"><span class="ds"><span class="lsbb"><input class="lsb" value="Google Search" name="btnG" type="submit"></span></span><span class="ds"><span class="lsbb"><input class="lsb" id="tsuid1" value="I'm Feeling Lucky" name="btnI" type="submit"><script nonce="1/dmvtu0z5ENPmniAgA6iw==">(function(){var id='tsuid1';document.getElementById(id).onclick = function(){if (this.form.q.value){this.checked = 1;if (this.form.iflsig)this.form.iflsig.disabled = false;}
else top.location='/doodles/';};})();</script><input value="AAP1E1EAAAAAXhIFbC7uaT5ByAUG1uPNOfeRfoxo7tZa" name="iflsig" type="hidden"></span></span></td><td class="fl sblc" align="left" nowrap="" width="25%"><a href="/advanced_search?hl=en-IN&amp;authuser=0">Advanced search</a><a href="/language_tools?hl=en-IN&amp;authuser=0">Language tools</a></td></tr></table><input id="gbv" name="gbv" type="hidden" value="1"><script nonce="1/dmvtu0z5ENPmniAgA6iw==">(function(){var a,b="1";if(document&&document.getElementById)if("undefined"!=typeof XMLHttpRequest)b="2";else if("undefined"!=typeof ActiveXObject){var c,d,e=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"];for(c=0;d=e[c++];)try{new ActiveXObject(d),b="2"}catch(h){}}a=b;if("2"==a&&-1==location.search.indexOf("&gbv=2")){var f=google.gbvu,g=document.getElementById("gbv");g&&(g.value=a);f&&window.setTimeout(function(){location.href=f},0)};}).call(this);</script></form><div id="gac_scont"></div><div style="font-size:83%;min-height:3.5em"><br><div id="gws-output-pages-elements-homepage_additional_languages__als"><style>#gws-output-pages-elements-homepage_additional_languages__als{font-size:small;margin-bottom:24px}#SIvCob{display:inline-block;line-height:28px;}#SIvCob a{padding:0 3px;}.H6sW5{display:inline-block;margin:0 2px;white-space:nowrap}.z4hgWe{display:inline-block;margin:0 2px}</style><div id="SIvCob">Google offered in:  <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=hi&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAU">&#2361;&#2367;&#2344;&#2381;&#2342;&#2368;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=bn&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAY">&#2476;&#2494;&#2434;&#2482;&#2494;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=te&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAc">&#3108;&#3142;&#3122;&#3137;&#3095;&#3137;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=mr&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAg">&#2350;&#2352;&#2366;&#2336;&#2368;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=ta&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAk">&#2980;&#2990;&#3007;&#2996;&#3021;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=gu&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAo">&#2711;&#2753;&#2716;&#2736;&#2750;&#2724;&#2752;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=kn&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAs">&#3221;&#3240;&#3277;&#3240;&#3233;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=ml&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCAw">&#3374;&#3378;&#3375;&#3390;&#3379;&#3330;</a>    <a href="http://www.google.com/setprefs?sig=0_lcpPhlIBk2utjDtMpoD22-cetNk%3D&amp;hl=pa&amp;source=homepage&amp;sa=X&amp;ved=0ahUKEwje2M2l2uzmAhWiyzgGHUUQAvMQ2ZgBCA0">&#2602;&#2672;&#2588;&#2622;&#2604;&#2624;</a>  </div></div></div><span id="footer"><div style="font-size:10pt"><div style="margin:19px auto;text-align:center" id="fll"><a href="/intl/en/ads/">Advertising‚Ä†Programs</a><a href="http://www.google.co.in/services/">Business Solutions</a><a href="/intl/en/about.html">About Google</a><a href="http://www.google.com/setprefdomain?prefdom=IN&amp;prev=http://www.google.co.in/&amp;sig=K_jSuH5voAxBixKZJHHsehHZTgtEk%3D">Google.co.in</a></div></div><p style="color:#767676;font-size:8pt">&copy; 2020 - <a href="/intl/en/policies/privacy/">Privacy</a> - <a href="/intl/en/policies/terms/">Terms</a></p></span></center><script nonce="1/dmvtu0z5ENPmniAgA6iw==">(function(){window.google.cdo={height:0,width:0};(function(){var a=window.innerWidth,b=window.innerHeight;if(!a||!b){var c=window.document,d="CSS1Compat"==c.compatMode?c.documentElement:c.body;a=d.clientWidth;b=d.clientHeight}a&&b&&(a!=google.cdo.width||b!=google.cdo.height)&&google.log("","","/client_204?&atyp=i&biw="+a+"&bih="+b+"&ei="+google.kEI);}).call(this);})();(function(){var u='/xjs/_/js/k\x3dxjs.hp.en.3mkxARIkkN0.O/m\x3dsb_he,d/am\x3dAAMCbAQ/d\x3d1/rs\x3dACT90oH0ZgFCL-q_Qh6y8ytgGBhQJ9zvUw';
setTimeout(function(){var b=document;var a="SCRIPT";"application/xhtml+xml"===b.contentType&&(a=a.toLowerCase());a=b.createElement(a);a.src=u;google.timers&&google.timers.load&&google.tick&&google.tick("load","xjsls");document.body.appendChild(a)},0);})();(function(){window.google.xjsu='/xjs/_/js/k\x3dxjs.hp.en.3mkxARIkkN0.O/m\x3dsb_he,d/am\x3dAAMCbAQ/d\x3d1/rs\x3dACT90oH0ZgFCL-q_Qh6y8ytgGBhQJ9zvUw';})();function _DumpException(e){throw e;}
function _F_installCss(c){}
(function(){google.spjs=false;google.snet=true;google.em=[];google.emw=false;})();(function(){var pmc='{\x22d\x22:{},\x22sb_he\x22:{\x22agen\x22:false,\x22cgen\x22:false,\x22client\x22:\x22heirloom-hp\x22,\x22dh\x22:true,\x22dhqt\x22:true,\x22ds\x22:\x22\x22,\x22ffql\x22:\x22en\x22,\x22fl\x22:true,\x22host\x22:\x22google.com\x22,\x22isbh\x22:28,\x22jsonp\x22:true,\x22msgs\x22:{\x22cibl\x22:\x22Clear Search\x22,\x22dym\x22:\x22Did you mean:\x22,\x22lcky\x22:\x22I\\u0026#39;m Feeling Lucky\x22,\x22lml\x22:\x22Learn more\x22,\x22oskt\x22:\x22Input tools\x22,\x22psrc\x22:\x22This search was removed from your \\u003Ca href\x3d\\\x22/history\\\x22\\u003EWeb History\\u003C/a\\u003E\x22,\x22psrl\x22:\x22Remove\x22,\x22sbit\x22:\x22Search by image\x22,\x22srch\x22:\x22Google Search\x22},\x22ovr\x22:{},\x22pq\x22:\x22\x22,\x22refpd\x22:true,\x22rfs\x22:[],\x22sbpl\x22:24,\x22sbpr\x22:24,\x22scd\x22:10,\x22sce\x22:5,\x22stok\x22:\x22zQYMIc9Qnf56aActhNrvnBqPeMA\x22,\x22uhde\x22:false}}';google.pmc=JSON.parse(pmc);})();</script>        </body></html>
```

Okay, that's google.com content üòÖ That happened because I have a route
for `/` and that matches and goes to google üòÖ

```
$ curl localhost:8001/routes

{"next":null,"data":[{"id":"5766e5ec-a5e7-4792-8ce4-cc7bcca07db6","path_handling":"v0","paths":null,"destinations":null,"headers":null,"protocols":["http","https"],"methods":null,"snis":null,"service":null,"name":"kafka-upstream","strip_path":true,"preserve_host":false,"regex_priority":0,"updated_at":1578235500,"sources":null,"hosts":["kafka-upstream.dev"],"https_redirect_status_code":426,"tags":null,"created_at":1578235500},{"id":"cb0da6f3-ff2f-4dfe-a2bc-bffaa598f929","path_handling":"v0","paths":["\/"],"destinations":null,"headers":null,"protocols":["http"],"methods":null,"snis":null,"service":{"id":"ec680ec6-ef4e-4bdc-bcfc-fe978253943f"},"name":"google","strip_path":true,"preserve_host":false,"regex_priority":0,"updated_at":1578073787,"sources":null,"hosts":null,"https_redirect_status_code":426,"tags":null,"created_at":1578073787}]}
```

Okay, I'm going to put some body, so that I can see some messages :P

Let's see if I can set a `map[string]interface{}` and if kong processes
the body and also sets the `Content-Type: application/json` header :D

Changing the `Access` method to

```
func (conf *PluginConfig) Access (kong *pdk.PDK) {
	err := kong.Response.Exit(200, map[string]interface{}{"message": "you are da best! :D"}, nil)
	if err != nil {
		_ = kong.Log.Err(err.Error())
	}
}
```

And now let's build it and copy into the Kong container! Okay, I can
see some errors! üôà

```
$ go build -v -buildmode=plugin . -o kafka-upstream-golang
can't load package: package -o: malformed module path "-o": leading dash
can't load package: package kafka-upstream-golang: malformed module path "kafka-upstream-golang": missing dot in first path element
$ go build -v -buildmode=plugin . -o kafka-upstream-golang.so
can't load package: package -o: malformed module path "-o": leading dash
can't load package: package kafka-upstream-golang.so: cannot find module providing package kafka-upstream-golang.so
```

Looks like since I mentioned `.`, it took up the `.so` too. Let me try
something else

Okay, I tried lots of stuff. I just realized I made the same mistake
again üòÖ üôà 

It tried to load the package, cuz the options actually come earlier.
I just made that mistake! üôà

```
$ go build -v -buildmode=plugin -o kafka-upstream-golang .
github.com/karuppiah7890/kong-plugin-kafka-upstream
```

Done! Yay! I think I should sometimes open my eyes and see errors more
clearly :P

Anyways, now. Copy to kong container!

Okay, wait, we need `.so` files, so, here after, let's use

```
$ go build -v -buildmode=plugin -o kafka-upstream-golang.so .
```

Now

```
$ docker cp kafka-upstream-golang.so kong:/root/golang-plugins
```

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -i
HTTP/1.1 200 OK
Date: Sun, 05 Jan 2020 15:04:51 GMT
Connection: keep-alive
Content-Length: 0
X-Kong-Response-Latency: 47
Server: kong/2.0.0rc1
```

I think I need to restart the go-pluginserver ? The logs I see is

```
$ go-pluginserver -socket go_pluginserver.sock
2020/01/05 14:47:32 Started instance "kafka-upstream-golang":0
2020/01/05 14:47:35 Started instance "kafka-upstream-golang":1
2020/01/05 15:04:51 Started instance "kafka-upstream-golang":2
```

I think somehow the old version is loaded and used? Let me restart!

```
$ go-pluginserver -socket go_pluginserver.sock
```

```
$ docker exec -it kong bash
$ cd /usr/local/kong/
$ chmod 777 go_pluginserver.sock
$ ls -al go_pluginserver.sock
srwxrwxrwx 1 root root 0 Jan  5 15:05 go_pluginserver.sock
```

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -i
HTTP/1.1 503 Service Temporarily Unavailable
Date: Sun, 05 Jan 2020 15:07:01 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Content-Length: 48
X-Kong-Response-Latency: 2
Server: kong/2.0.0rc1

{"message":"no Service found with those values"} 
```

Oops. Something went wrong

```
172.17.0.1 - - [05/Jan/2020:15:07:01 +0000] "GET / HTTP/1.1" 503 48 "-" "curl/7.64.1"
172.17.0.1 - - [05/Jan/2020:15:07:19 +0000] "GET / HTTP/1.1" 503 48 "-" "curl/7.64.1"
```

And no logs in `go-pluginserver` ü§î

Let me try to reload Kong may be.


```
$ kong reload
```

```
$ curl http://localhost:8000 --header 'Host: kafka-upstream.dev' -i
HTTP/1.1 200 OK
Date: Sun, 05 Jan 2020 15:09:14 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Content-Length: 33
X-Kong-Response-Latency: 88
Server: kong/2.0.0rc1

{"message":"you are da best! :D"}
```

`go-pluginserver` logs

```
2020/01/05 15:09:14 Started instance "kafka-upstream-golang":0
```

WOW! Yay! I'm da best :P haha :P

Now. That was weird. To reload Kong. Anyways. I'll figure out what went
wrong there later, hmm

Now that we have something working for our Kafka plugin, next thing
to check is how to connect to Kafka, how to run a Kafka. I have done
some of these, it's just that I don't remember much now. But we can
manage :) Our job is to be creative and not to remember stuff :P A
computer can remember stuff, human brains can do better :D

Okay then, I'll continue more tomorrow! Gotta have dinner and sleep!

I just added a Makefile to make my life easier :P

```
build:
	go build -v -buildmode=plugin -o kafka-upstream-golang.so .
```

Now I won't be doing that mistake again. Let the `make` take care
of the building when I'm chilling :P

# Idea stuff 1

So, while building this plugin, I realized what plugins we use in our
project. And then recalled a plugin we wanted to use but couldn't as
we were using an older version - `0.14.x`. The plugin was `prometheus`

I thought I could create that plugin for older versions which has old
concepts. Not too much worth it, but might be helpful for people still
using `0.14.x` like my project üòÖ 

I can see some projects here

https://github.com/search?utf8=%E2%9C%93&q=kong%20prometheus

like

https://github.com/yciabaud/kong-plugin-prometheus

May be if they support old versions, I'll not reinvent the wheel and
instead just try it out :) and may be even contribute back to it!

Okay then, that's it for the day! Till tomorrow! üëã