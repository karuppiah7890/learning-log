# August 16th 2020

Today I wanted to checkout about Jenkins pipeline,
to use it in my current project

Now, I already checked about the Docker image for
Jenkins

https://hub.docker.com/_/jenkins - This says it's
an official image but there's a deprecation notice
saying that it has been deprecated in favor of

https://hub.docker.com/r/jenkins/jenkins and this
is maintained by the Jenkins community! :)

Another deprecated image is https://hub.docker.com/r/jenkinsci/jenkins

Now, the docs for this https://hub.docker.com/r/jenkins/jenkins
is here

https://github.com/jenkinsci/docker/blob/master/README.md

I'll be using the LTS version I guess. I usually go with
latest stable release, but it's okay.

They have a weekly release - https://www.jenkins.io/download/weekly/
and LTS - https://www.jenkins.io/download/lts/

As of today, latest weekly release version is 2.252 https://www.jenkins.io/changelog/
and latest LTS release version is 2.235.4 https://www.jenkins.io/changelog-stable/

They also have a voting system for telling if there are no issues,
major issues requiring rollback etc. But it doesn't take one vote
from one person. I clicked twice with first time not knowing what that
thing does. It looked like some weather report icon - sunny etc :P Only
after hovering I found out what it was and there was a legend on the
top right too :P

Okay, so, for docker, I need to run

```bash
$ docker run -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
```

Before which I need to create a docker volume, which is recommended
than using host machine directories

I created a volume by just typing this

```bash
$ docker volume create
09025e273661676647a64501533f4e15f9848aa72bba50fce28f2d961e21bee7
```

And listed it with

```bash
$ docker volume ls
```

I was expecting a help command for create. Anyways.

```bash
$ docker volume create jenkins_volume
jenkins_volume
$ docker volume ls
DRIVER              VOLUME NAME
local               jenkins_volume
```

```bash
$ docker run -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
```

Oops. I should have run it in detached / daemon mode!

```bash
$ docker run -d -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
```

Done!

That's a big image I think

```bash
$ docker images jenkins/jenkins
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
jenkins/jenkins     lts                 dfe79e0504a8        3 days ago          677MB
```

Anyways, now that it's running, I wanted to see the docs,
which is what I was reading a bit this morning.

https://www.jenkins.io
https://www.jenkins.io/doc/

Clearly the next thing to checkout was the Guided tour.
But, I noticed a mention of something called Blue Ocean and saw
a bit of that

https://www.jenkins.io/doc/book/blueocean/

It's weird that they have multiple UIs for the same thing. I mean,
if blue ocean is better and gives a better experience, why not that
by default, I don't know. Gotta dig and understand. Apparently there's
a classic UI and then there's blue ocean ðŸ¤·â€â™‚ï¸

I also got a bit lost a bit more of it :P

Saw the youtube video
https://www.youtube.com/watch?v=k_fVlU1FwP4

Went a bit here
https://www.jenkins.io/projects/blueocean/

And here

https://www.cloudbees.com/
https://www.cloudbees.com/jenkins/what-is-jenkins

Saw the name Kohsuke Kawaguchi

https://kohsuke.org/
https://en.wikipedia.org/wiki/Kohsuke_Kawaguchi

His latest product is 

https://www.launchableinc.com/ (paid product) - Seems like an interesting 
concept - ordering tests in such a way that if it's going to fail, it will
fail faster

And Blue Ocean seems nice. I might try it out using these
docs 
https://www.jenkins.io/doc/book/blueocean/getting-started/

Now, back to our work! The guided tour!!

https://www.jenkins.io/doc/pipeline/tour/getting-started/

I have docker container running instead of war/jar, so next is

https://www.jenkins.io/doc/pipeline/tour/hello-world/

Now, I need an example project!

I created the sample project and realized I need to make a small
contribution :P To

https://github.com/spring-io/initializr

I wanted to upgrade the default gradle version to the latest - 6.6
as of now.

They use a bit old one
https://github.com/spring-io/initializr/blob/c783cefb5f489ba92fbe7a3e4ddf451329f70daf/initializr-generator-spring/src/main/resources/gradle/6/wrapper/gradle/wrapper/gradle-wrapper.properties

No issues or PRs related to this. Gotta change it sometime

I was reading this
https://github.com/spring-io/initializr/blob/master/CONTRIBUTING.adoc
And was gonna sign this
https://cla.pivotal.io/sign/spring

I'll do it later I guess! :) Let me finish this Jenkins thingy!

I went to http://localhost:8080 to setup the Jenkins pipeline

I had to get the admin token / password from the app container logs

```bash
$ docker ps
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                              NAMES
925225e75331        jenkins/jenkins:lts   "/sbin/tini -- /usr/â€¦"   34 minutes ago      Up 34 minutes       0.0.0.0:8080->8080/tcp, 0.0.0.0:50000->50000/tcp   fervent_buck
$ docker logs -f 9
Running from: /usr/share/jenkins/jenkins.war
webroot: EnvVars.masterEnvVars.get("JENKINS_HOME")
2020-08-16 06:17:08.097+0000 [id=1]     INFO    org.eclipse.jetty.util.log.Log#initialized: Logging initialized @570ms to org.eclipse.jetty.util.log.JavaUtilLog
2020-08-16 06:17:08.229+0000 [id=1]     INFO    winstone.Logger#logInternal: Beginning extraction from war file
2020-08-16 06:17:09.517+0000 [id=1]     WARNING o.e.j.s.handler.ContextHandler#setContextPath: Empty contextPath
2020-08-16 06:17:09.587+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: jetty-9.4.27.v20200227; built: 2020-02-27T18:37:21.340Z; git: a304fd9f351f337e7c0e2a7c28878dd536149c6c; jvm 1.8.0_242-b08
2020-08-16 06:17:09.905+0000 [id=1]     INFO    o.e.j.w.StandardDescriptorProcessor#visitServlet: NO JSP Support for /, did not find org.eclipse.jetty.jsp.JettyJspServlet
2020-08-16 06:17:09.950+0000 [id=1]     INFO    o.e.j.s.s.DefaultSessionIdManager#doStart: DefaultSessionIdManager workerName=node0
2020-08-16 06:17:09.951+0000 [id=1]     INFO    o.e.j.s.s.DefaultSessionIdManager#doStart: No SessionScavenger set, using defaults
2020-08-16 06:17:09.956+0000 [id=1]     INFO    o.e.j.server.session.HouseKeeper#startScavenging: node0 Scavenging every 660000ms
2020-08-16 06:17:10.318+0000 [id=1]     INFO    hudson.WebAppMain#contextInitialized: Jenkins home directory: /var/jenkins_home found at: EnvVars.masterEnvVars.get("JENKINS_HOME")
2020-08-16 06:17:10.451+0000 [id=1]     INFO    o.e.j.s.handler.ContextHandler#doStart: Started w.@9573b3b{Jenkins v2.235.4,/,file:///var/jenkins_home/war/,AVAILABLE}{/var/jenkins_home/war}
2020-08-16 06:17:10.468+0000 [id=1]     INFO    o.e.j.server.AbstractConnector#doStart: Started ServerConnector@4d14b6c2{HTTP/1.1, (http/1.1)}{0.0.0.0:8080}
2020-08-16 06:17:10.469+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: Started @2942ms
2020-08-16 06:17:10.469+0000 [id=20]    INFO    winstone.Logger#logInternal: Winstone Servlet Engine running: controlPort=disabled
2020-08-16 06:17:12.255+0000 [id=27]    INFO    jenkins.InitReactorRunner$1#onAttained: Started initialization
2020-08-16 06:17:12.306+0000 [id=27]    INFO    jenkins.InitReactorRunner$1#onAttained: Listed all plugins
2020-08-16 06:17:13.983+0000 [id=28]    INFO    jenkins.InitReactorRunner$1#onAttained: Prepared all plugins
2020-08-16 06:17:13.990+0000 [id=27]    INFO    jenkins.InitReactorRunner$1#onAttained: Started all plugins
2020-08-16 06:17:14.007+0000 [id=27]    INFO    jenkins.InitReactorRunner$1#onAttained: Augmented all extensions
2020-08-16 06:17:14.671+0000 [id=28]    INFO    jenkins.InitReactorRunner$1#onAttained: System config loaded
2020-08-16 06:17:14.672+0000 [id=28]    INFO    jenkins.InitReactorRunner$1#onAttained: System config adapted
2020-08-16 06:17:14.672+0000 [id=28]    INFO    jenkins.InitReactorRunner$1#onAttained: Loaded all jobs
2020-08-16 06:17:14.673+0000 [id=27]    INFO    jenkins.InitReactorRunner$1#onAttained: Configuration for all jobs updated
2020-08-16 06:17:14.730+0000 [id=41]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Started Download metadata
2020-08-16 06:17:14.748+0000 [id=41]    INFO    hudson.util.Retrier#start: Attempt #1 to do the action check updates server
2020-08-16 06:17:15.672+0000 [id=26]    INFO    o.s.c.s.AbstractApplicationContext#prepareRefresh: Refreshing org.springframework.web.context.support.StaticWebApplicationContext@3ed3c06e: display name [Root WebApplicationContext]; startup date [Sun Aug 16 06:17:15 UTC 2020]; root of context hierarchy
2020-08-16 06:17:15.672+0000 [id=26]    INFO    o.s.c.s.AbstractApplicationContext#obtainFreshBeanFactory: Bean factory for application context [org.springframework.web.context.support.StaticWebApplicationContext@3ed3c06e]: org.springframework.beans.factory.support.DefaultListableBeanFactory@66864701
2020-08-16 06:17:15.684+0000 [id=26]    INFO    o.s.b.f.s.DefaultListableBeanFactory#preInstantiateSingletons: Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@66864701: defining beans [authenticationManager]; root of factory hierarchy
2020-08-16 06:17:15.963+0000 [id=26]    INFO    o.s.c.s.AbstractApplicationContext#prepareRefresh: Refreshing org.springframework.web.context.support.StaticWebApplicationContext@e3eeb8d: display name [Root WebApplicationContext]; startup date [Sun Aug 16 06:17:15 UTC 2020]; root of context hierarchy
2020-08-16 06:17:15.963+0000 [id=26]    INFO    o.s.c.s.AbstractApplicationContext#obtainFreshBeanFactory: Bean factory for application context [org.springframework.web.context.support.StaticWebApplicationContext@e3eeb8d]: org.springframework.beans.factory.support.DefaultListableBeanFactory@2c4090a
2020-08-16 06:17:15.965+0000 [id=26]    INFO    o.s.b.f.s.DefaultListableBeanFactory#preInstantiateSingletons: Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@2c4090a: defining beans [filter,legacy]; root of factory hierarchy
2020-08-16 06:17:16.329+0000 [id=26]    INFO    jenkins.install.SetupWizard#init:

*************************************************************
*************************************************************
*************************************************************

Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

0a004da94fb242cb83455fd12f0c721e

This may also be found at: /var/jenkins_home/secrets/initialAdminPassword

*************************************************************
*************************************************************
*************************************************************

2020-08-16 06:17:31.290+0000 [id=26]    INFO    jenkins.InitReactorRunner$1#onAttained: Completed initialization
2020-08-16 06:17:31.299+0000 [id=19]    INFO    hudson.WebAppMain$3#run: Jenkins is fully up and running
2020-08-16 06:17:32.234+0000 [id=41]    INFO    h.m.DownloadService$Downloadable#load: Obtained the updated data file for hudson.tasks.Maven.MavenInstaller
2020-08-16 06:17:32.235+0000 [id=41]    INFO    hudson.util.Retrier#start: Performed the action check updates server successfully at the attempt #1
2020-08-16 06:17:32.238+0000 [id=41]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Finished Download metadata. 17,503 ms
2020-08-16 06:23:08.016+0000 [id=63]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Started Fingerprint cleanup
2020-08-16 06:23:08.023+0000 [id=63]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Finished Fingerprint cleanup. 4 ms
2020-08-16 06:27:36.019+0000 [id=64]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Started Periodic background build discarder
2020-08-16 06:27:36.022+0000 [id=64]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Finished Periodic background build discarder. 1 ms
2020-08-16 06:37:13.520+0000 [id=65]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Started telemetry collection
2020-08-16 06:37:13.536+0000 [id=65]    INFO    hudson.model.AsyncPeriodicWork#lambda$doRun$0: Finished telemetry collection. 14 ms

```

The token was `0a004da94fb242cb83455fd12f0c721e`

Now I'm installing the plugins that's most useful according to the
community

I have created a repo where there are going to be multiple projects.
My example project for the pipeline is here

https://github.com/karuppiah7890/spring-stuff/tree/master/example-project

Let's see if Jenkins can take it up. Like, work with config file
being inside one of the directories and not in the root of the project,
hmm

Now I have to create my first admin user! :)

I also created a new item with "multi branch pipeline" option
following the tutorial.

For source - I chose GitHub.
I didn't provide any credentials, I just added my username
and it scanned and showed me my public repos and I chose the
spring-stuff repo! :)

Now I need to add the Jenkins file. Also, I mentioned the path
for the Jenkins file is at `example-project/Jenkinsfile`

Now I gotta create a jenkins file based on the example -

```
pipeline {
    agent { docker { image 'maven:3.3.3' } }
    stages {
        stage('build') {
            steps {
                sh 'mvn --version'
            }
        }
    }
}
```

I need gradle, so I went and checked this

https://hub.docker.com/_/gradle

For me it will be

```
pipeline {
    agent { docker { image 'gradle' } }
    stages {
        stage('build') {
            steps {
                sh 'gradle build'
            }
        }
    }
}
```

Right. I have no idea how to trigger a build now. It says something about
Scan, but that didn't really do much. Found it!! Found the build button!
Damn thing :P

http://localhost:8080/job/example-project/

Had to go to the master branch and then do it

http://localhost:8080/job/example-project/job/master/

Okay, there's an error now. Hmm

```bash
Started by user Karuppiah Natarajan
07:16:10 Connecting to https://api.github.com with no credentials, anonymous access
07:16:10 Jenkins-Imposed API Limiter: Current quota for Github API usage has 45 remaining (0 under budget). Next quota of 60 in 46 min
Obtained example-project/Jenkinsfile from 2df41951fa9ca30393d1a0f603cb9aeaaac54974
Running in Durability level: MAX_SURVIVABILITY
org.codehaus.groovy.control.MultipleCompilationErrorsException: startup failed:
WorkflowScript: 2: Invalid agent type "docker" specified. Must be one of [any, label, none] @ line 2, column 13.
       agent { docker { image 'gradle' } }
               ^

1 error

	at org.codehaus.groovy.control.ErrorCollector.failIfErrors(ErrorCollector.java:310)
	at org.codehaus.groovy.control.CompilationUnit.applyToPrimaryClassNodes(CompilationUnit.java:1085)
	at org.codehaus.groovy.control.CompilationUnit.doPhaseOperation(CompilationUnit.java:603)
	at org.codehaus.groovy.control.CompilationUnit.processPhaseOperations(CompilationUnit.java:581)
	at org.codehaus.groovy.control.CompilationUnit.compile(CompilationUnit.java:558)
	at groovy.lang.GroovyClassLoader.doParseClass(GroovyClassLoader.java:298)
	at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:268)
	at groovy.lang.GroovyShell.parseClass(GroovyShell.java:688)
	at groovy.lang.GroovyShell.parse(GroovyShell.java:700)
	at org.jenkinsci.plugins.workflow.cps.CpsGroovyShell.doParse(CpsGroovyShell.java:142)
	at org.jenkinsci.plugins.workflow.cps.CpsGroovyShell.reparse(CpsGroovyShell.java:127)
	at org.jenkinsci.plugins.workflow.cps.CpsFlowExecution.parseScript(CpsFlowExecution.java:561)
	at org.jenkinsci.plugins.workflow.cps.CpsFlowExecution.start(CpsFlowExecution.java:522)
	at org.jenkinsci.plugins.workflow.job.WorkflowRun.run(WorkflowRun.java:337)
	at hudson.model.ResourceController.execute(ResourceController.java:97)
	at hudson.model.Executor.run(Executor.java:428)
Finished: FAILURE
```

I think it's my fault, because I need to add docker agents! :)

This doesn't help. Hmm
http://localhost:8080/manage

I need to see how to add docker based builds

https://www.jenkins.io/doc/book/pipeline/docker/

Damn crazy folks. Nowhere I could properly find in the docs on
how to use a Docker agent

My error was this

```bash
Invalid agent type "docker" specified. Must be one of [any, label, none]
```

Finally got the answer here

https://stackoverflow.com/questions/62253474/jenkins-invalid-agent-type-docker-specified-must-be-one-of-any-label-none

I did see these pages

https://plugins.jenkins.io/docker-workflow/

https://plugins.jenkins.io/docker-plugin/

Damn. I think the docker plugin makes sense a bit. But still, some
Jenkinsfile to show that it is related to the "Jenkins agent" would
have helped

None of the docs here helped much with it

https://docs.cloudbees.com/docs/admin-resources/latest/plugins/docker-workflow

https://github.com/jenkinsci/docker-workflow-plugin/blob/master/demo/README.md
https://github.com/jenkinsci/docker-workflow-plugin/

This one looks okay

https://www.jenkins.io/doc/pipeline/steps/docker-plugin/

Actually, I don't even need the Docker Pipeline plugin as I won't
be using the features of that. It's more like writing code with
docker images and stuff. I just needed a Docker container provisioned,
to be used.

Also, for gradle, I could just use https://plugins.jenkins.io/gradle/
I think and it's already installed

http://localhost:8080/pluginManager/
http://localhost:8080/pluginManager/installed

For Docker plugin I need to do some setup

https://github.com/jenkinsci/docker-plugin
https://github.com/jenkinsci/docker-plugin#setup

And install the plugin first! And then add it as a cloud
or something

http://localhost:8080/computer/
http://localhost:8080/configureClouds/

http://localhost:8080/pluginManager/available?filter=Cloud+Providers

I have installed Docker plugin without restart! I don't
know what's the advantage of restarting the server though!

I like that Jenkins has quite some features and plugins, but the
UI is a bit crazy. I guess it's just the way it is. Hmm. The search
doesn't even help :/

I need to provide the docker daemon connection details, like URL,
port etc

https://duckduckgo.com/?q=connecting+to+docker+daemon+from+inside+docker+container&t=ffab&ia=web&iax=qa

https://stackoverflow.com/questions/46916796/connect-to-docker-daemon-from-inside-docker-container#46918825

https://duckduckgo.com/?q=docker+daemon+port&t=ffab&ia=web&iax=qa

https://stackoverflow.com/questions/26561963/how-to-detect-a-docker-daemon-port#26567627

I think I need to use `unix:///var/run/docker.sock` , but the thing
is, I didn't mount it. So I gotta kill my container. I was thinking that
I would lose data, but realized I have mounted the volume! :D So, I deleted
it and I'm going to run it again! :D

Initially I was planning to mount a volume to the running container

https://duckduckgo.com/?t=ffab&q=mount+volumes+in+running+container&ia=web

Apparently it's possible :P Anyways

```bash
$ ls /var/run/docker.sock
/var/run/docker.sock
$ docker run -d -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock  jenkins/jenkins:lts
```


Now I got this error

```bash
connect(..) failed: Permission denied: /var/run/docker.sock

java.net.ConnectException: connect(..) failed: Permission denied
Caused: io.netty.channel.AbstractChannel$AnnotatedConnectException: connect(..) failed: Permission denied: /var/run/docker.sock
	at io.netty.channel.unix.Errors.throwConnectException(Errors.java:112)
	at io.netty.channel.unix.Socket.connect(Socket.java:257)
	at io.netty.channel.epoll.AbstractEpollChannel.doConnect0(AbstractEpollChannel.java:728)
	at io.netty.channel.epoll.AbstractEpollChannel.doConnect(AbstractEpollChannel.java:713)
	at io.netty.channel.epoll.EpollDomainSocketChannel.doConnect(EpollDomainSocketChannel.java:87)
	at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.connect(AbstractEpollChannel.java:555)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.connect(DefaultChannelPipeline.java:1366)
	at io.netty.channel.AbstractChannelHandlerContext.invokeConnect(AbstractChannelHandlerContext.java:545)
	at io.netty.channel.AbstractChannelHandlerContext.connect(AbstractChannelHandlerContext.java:530)
	at io.netty.channel.ChannelDuplexHandler.connect(ChannelDuplexHandler.java:50)
	at io.netty.channel.AbstractChannelHandlerContext.invokeConnect(AbstractChannelHandlerContext.java:545)
	at io.netty.channel.AbstractChannelHandlerContext.connect(AbstractChannelHandlerContext.java:530)
	at io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.connect(CombinedChannelDuplexHandler.java:497)
	at io.netty.channel.ChannelOutboundHandlerAdapter.connect(ChannelOutboundHandlerAdapter.java:47)
	at io.netty.channel.CombinedChannelDuplexHandler.connect(CombinedChannelDuplexHandler.java:298)
	at io.netty.channel.AbstractChannelHandlerContext.invokeConnect(AbstractChannelHandlerContext.java:545)
	at io.netty.channel.AbstractChannelHandlerContext.connect(AbstractChannelHandlerContext.java:530)
	at io.netty.channel.AbstractChannelHandlerContext.connect(AbstractChannelHandlerContext.java:512)
	at io.netty.channel.DefaultChannelPipeline.connect(DefaultChannelPipeline.java:1024)
	at io.netty.channel.AbstractChannel.connect(AbstractChannel.java:259)
	at io.netty.bootstrap.Bootstrap$3.run(Bootstrap.java:252)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:404)
	at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:335)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:897)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:748)
```

The user inside the container is not root. It's `jenkins`

```sh
$ ls -al /var/run/docker.sock
srw-rw---- 1 root root 0 Aug 16 06:13 /var/run/docker.sock
$ whoami
jenkins
```

I went and configured a bit of Gradle here - http://localhost:8080/configureTools/
but it seems like it doesn't get saved no matter what :P

Oh. I just noticed that there are two options - Save and Apply. I tried
both and it didn't work. It does show my old selection / config when I try
to add again from first. Hmm. Bugs I guess. UI or backend. Idk

Went back to fixing permission issues for Docker Daemon.
I ran the container as root user using `--user root`

And the docker daemon connection test worked too!
I tried to build. But. Still same error

```bash
Obtained example-project/Jenkinsfile from 2df41951fa9ca30393d1a0f603cb9aeaaac54974
Running in Durability level: MAX_SURVIVABILITY
org.codehaus.groovy.control.MultipleCompilationErrorsException: startup failed:
WorkflowScript: 2: Invalid agent type "docker" specified. Must be one of [any, label, none] @ line 2, column 13.
       agent { docker { image 'gradle' } }
               ^

1 error

	at org.codehaus.groovy.control.ErrorCollector.failIfErrors(ErrorCollector.java:310)
	at org.codehaus.groovy.control.CompilationUnit.applyToPrimaryClassNodes(CompilationUnit.java:1085)
	at org.codehaus.groovy.control.CompilationUnit.doPhaseOperation(CompilationUnit.java:603)
	at org.codehaus.groovy.control.CompilationUnit.processPhaseOperations(CompilationUnit.java:581)
	at org.codehaus.groovy.control.CompilationUnit.compile(CompilationUnit.java:558)
	at groovy.lang.GroovyClassLoader.doParseClass(GroovyClassLoader.java:298)
	at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:268)
	at groovy.lang.GroovyShell.parseClass(GroovyShell.java:688)
	at groovy.lang.GroovyShell.parse(GroovyShell.java:700)
	at org.jenkinsci.plugins.workflow.cps.CpsGroovyShell.doParse(CpsGroovyShell.java:142)
	at org.jenkinsci.plugins.workflow.cps.CpsGroovyShell.reparse(CpsGroovyShell.java:127)
	at org.jenkinsci.plugins.workflow.cps.CpsFlowExecution.parseScript(CpsFlowExecution.java:561)
	at org.jenkinsci.plugins.workflow.cps.CpsFlowExecution.start(CpsFlowExecution.java:522)
	at org.jenkinsci.plugins.workflow.job.WorkflowRun.run(WorkflowRun.java:337)
	at hudson.model.ResourceController.execute(ResourceController.java:97)
	at hudson.model.Executor.run(Executor.java:428)
Finished: FAILURE
```

Okay, so I had to enable the Docker Pipeline plugin too, and then it
worked!

Now, a different error


```bash
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/example-project_master
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Declarative: Checkout SCM)
[Pipeline] checkout
No credentials specified
Cloning the remote Git repository
Cloning with configured refspecs honoured and without tags
Cloning repository https://github.com/karuppiah7890/spring-stuff.git
 > git init /var/jenkins_home/workspace/example-project_master # timeout=10
Fetching upstream changes from https://github.com/karuppiah7890/spring-stuff.git
 > git --version # timeout=10
 > git --version # 'git version 2.11.0'
 > git fetch --no-tags --progress -- https://github.com/karuppiah7890/spring-stuff.git +refs/heads/master:refs/remotes/origin/master # timeout=10
 > git config remote.origin.url https://github.com/karuppiah7890/spring-stuff.git # timeout=10
 > git config --add remote.origin.fetch +refs/heads/master:refs/remotes/origin/master # timeout=10
 > git config remote.origin.url https://github.com/karuppiah7890/spring-stuff.git # timeout=10
Fetching without tags
Fetching upstream changes from https://github.com/karuppiah7890/spring-stuff.git
 > git fetch --no-tags --progress -- https://github.com/karuppiah7890/spring-stuff.git +refs/heads/master:refs/remotes/origin/master # timeout=10
Checking out Revision 2df41951fa9ca30393d1a0f603cb9aeaaac54974 (master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 2df41951fa9ca30393d1a0f603cb9aeaaac54974 # timeout=10

Commit message: "add jenkins config file"
First time build. Skipping changelog.
[Pipeline] }
[Pipeline] // stage
[Pipeline] withEnv
[Pipeline] {

[Pipeline] isUnix
[Pipeline] sh
+ docker inspect -f . gradle
/var/jenkins_home/workspace/example-project_master@tmp/durable-d1e1c258/script.sh: 1: /var/jenkins_home/workspace/example-project_master@tmp/durable-d1e1c258/script.sh: docker: not found
[Pipeline] isUnix
[Pipeline] sh

+ docker pull gradle
/var/jenkins_home/workspace/example-project_master@tmp/durable-1864354c/script.sh: 1: /var/jenkins_home/workspace/example-project_master@tmp/durable-1864354c/script.sh: docker: not found
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
ERROR: script returned exit code 127
Finished: FAILURE
```

It's trying to use the docker command line client to connect to
the docker daemon. But the docker client is not installed in the jenkins
master (docker container with jenkins/jenkins image)

I could install docker inside the container. I'm going to try that.
The other thing I want to try is - use another docker container as an agent
which in turn talks to docker daemon to create docker containers. And the
agent will have docker client installed as I'll be using the docker image
containing docker client

```bash
$ apt update
$ apt install docker
```

Oops. Apparently `docker` is some other application. I removed it

```bash
$ apt remove docker
```

There's quite some docs for docker installation here

https://docs.docker.com/engine/install/ubuntu/

Apparently I used debian and not ubuntu! Damn

https://docs.docker.com/engine/install/debian/

Found it through

```bash
$ lsb_release -a
```

Followed the docs and just installed `docker-ce-cli` package

```bash
$ apt update
$ apt install docker-ce-cli
$ docker --version
$ docker ps
```

There was another error because I didn't run the build inside
the example project and instead ran it in the root directory

```bash
Started by user Karuppiah Natarajan
Connecting to https://api.github.com with no credentials, anonymous access
Jenkins-Imposed API Limiter: Current quota for Github API usage has 59 remaining (6 under budget). Next quota of 60 in 59 min
Obtained example-project/Jenkinsfile from 2df41951fa9ca30393d1a0f603cb9aeaaac54974
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/example-project_master
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Declarative: Checkout SCM)
[Pipeline] checkout
No credentials specified
 > git rev-parse --is-inside-work-tree # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/karuppiah7890/spring-stuff.git # timeout=10
Fetching without tags
Fetching upstream changes from https://github.com/karuppiah7890/spring-stuff.git
 > git --version # timeout=10
 > git --version # 'git version 2.11.0'
 > git fetch --no-tags --progress -- https://github.com/karuppiah7890/spring-stuff.git +refs/heads/master:refs/remotes/origin/master # timeout=10
Checking out Revision 2df41951fa9ca30393d1a0f603cb9aeaaac54974 (master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 2df41951fa9ca30393d1a0f603cb9aeaaac54974 # timeout=10
Commit message: "add jenkins config file"
 > git rev-list --no-walk 2df41951fa9ca30393d1a0f603cb9aeaaac54974 # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] withEnv
[Pipeline] {
[Pipeline] isUnix
[Pipeline] sh
+ docker inspect -f . gradle

Error: No such object: gradle
[Pipeline] isUnix
[Pipeline] sh
+ docker pull gradle
Using default tag: latest
latest: Pulling from library/gradle
7595c8c21622: Already exists
d13af8ca898f: Already exists
70799171ddba: Already exists
b6c12202c5ef: Already exists
c54d424eaa66: Pulling fs layer
41534844af48: Pulling fs layer
29d2bc40c7ae: Pulling fs layer
5c6e01006f25: Pulling fs layer
9d2e7c11a655: Pulling fs layer
5c6e01006f25: Waiting
9d2e7c11a655: Waiting
29d2bc40c7ae: Download complete
c54d424eaa66: Verifying Checksum
c54d424eaa66: Download complete
c54d424eaa66: Pull complete
5c6e01006f25: Verifying Checksum
5c6e01006f25: Download complete
9d2e7c11a655: Verifying Checksum
9d2e7c11a655: Download complete
41534844af48: Verifying Checksum
41534844af48: Download complete
41534844af48: Pull complete
29d2bc40c7ae: Pull complete
5c6e01006f25: Pull complete
9d2e7c11a655: Pull complete
Digest: sha256:fac9bb7b8947cb8845850f302189989bf6c8ea1c324cd99dac19af531fc097c5
Status: Downloaded newer image for gradle:latest
docker.io/library/gradle:latest
[Pipeline] withDockerContainer
Jenkins seems to be running inside container bc02873662e74494d1188d92097c69d961b2b2e2808b3b7b504912c28f809ac1
$ docker run -t -d -u 0:0 -w /var/jenkins_home/workspace/example-project_master --volumes-from bc02873662e74494d1188d92097c69d961b2b2e2808b3b7b504912c28f809ac1 -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** gradle cat
$ docker top 250d8086c194be939bff6ec8f4585a97b3f3b59df620b5a9df98714aeb6a965e -eo pid,comm
[Pipeline] {
[Pipeline] stage
[Pipeline] { (build)
[Pipeline] sh
+ gradle build

Welcome to Gradle 6.6!

Here are the highlights of this release:
 - Experimental build configuration caching
 - Built-in conventions for handling credentials
 - Java compilation supports --release flag

For more details see https://docs.gradle.org/6.6/release-notes.html

Starting a Gradle Daemon (subsequent builds will be faster)

> Task :buildEnvironment

------------------------------------------------------------
Root project
------------------------------------------------------------

classpath
No dependencies

A web-based, searchable dependency report is available by adding the --scan option.

Deprecated Gradle features were used in this build, making it incompatible with Gradle 7.0.
Use '--warning-mode all' to show the individual deprecation warnings.
See https://docs.gradle.org/6.6/userguide/command_line_interface.html#sec:command_line_warnings

BUILD SUCCESSFUL in 15s
1 actionable task: 1 executed
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
$ docker stop --time=1 250d8086c194be939bff6ec8f4585a97b3f3b59df620b5a9df98714aeb6a965e
$ docker rm -f 250d8086c194be939bff6ec8f4585a97b3f3b59df620b5a9df98714aeb6a965e
[Pipeline] // withDockerContainer
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
```

Another error because I used the wrong gradle image. The one
I used had JDK 8. I need JDK 14 :P

```bash
Started by user Karuppiah Natarajan
Connecting to https://api.github.com with no credentials, anonymous access
Jenkins-Imposed API Limiter: Current quota for Github API usage has 59 remaining (8 under budget). Next quota of 60 in 56 min
Obtained example-project/Jenkinsfile from e27fc4fb5e1840576fb60db621a1f83256f3103a
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/example-project_master
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Declarative: Checkout SCM)
[Pipeline] checkout
No credentials specified
 > git rev-parse --is-inside-work-tree # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/karuppiah7890/spring-stuff.git # timeout=10
Fetching without tags
Fetching upstream changes from https://github.com/karuppiah7890/spring-stuff.git
 > git --version # timeout=10
 > git --version # 'git version 2.11.0'
 > git fetch --no-tags --progress -- https://github.com/karuppiah7890/spring-stuff.git +refs/heads/master:refs/remotes/origin/master # timeout=10
Checking out Revision e27fc4fb5e1840576fb60db621a1f83256f3103a (master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f e27fc4fb5e1840576fb60db621a1f83256f3103a # timeout=10
Commit message: "fix to run gradle build inside example project"
 > git rev-list --no-walk 2df41951fa9ca30393d1a0f603cb9aeaaac54974 # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] withEnv
[Pipeline] {
[Pipeline] isUnix
[Pipeline] sh
+ docker inspect -f . gradle
.
[Pipeline] withDockerContainer
Jenkins seems to be running inside container bc02873662e74494d1188d92097c69d961b2b2e2808b3b7b504912c28f809ac1
$ docker run -t -d -u 0:0 -w /var/jenkins_home/workspace/example-project_master --volumes-from bc02873662e74494d1188d92097c69d961b2b2e2808b3b7b504912c28f809ac1 -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** gradle cat
$ docker top d9ef7c3d3f0dd6eff02c5b9f3edd38f5992e7cecc1bc16bffe4f9b4b3dafbf4e -eo pid,comm
[Pipeline] {
[Pipeline] stage
[Pipeline] { (build)
[Pipeline] sh
+ cd example-project
+ gradle build

Welcome to Gradle 6.6!

Here are the highlights of this release:
 - Experimental build configuration caching
 - Built-in conventions for handling credentials
 - Java compilation supports --release flag

For more details see https://docs.gradle.org/6.6/release-notes.html

Starting a Gradle Daemon (subsequent builds will be faster)
> Task :compileJava
> Task :compileJava FAILED

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':compileJava'.
> Could not target platform: 'Java SE 14' using tool chain: 'JDK 8 (1.8)'.

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 1m 40s
1 actionable task: 1 executed
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
$ docker stop --time=1 d9ef7c3d3f0dd6eff02c5b9f3edd38f5992e7cecc1bc16bffe4f9b4b3dafbf4e
$ docker rm -f d9ef7c3d3f0dd6eff02c5b9f3edd38f5992e7cecc1bc16bffe4f9b4b3dafbf4e
[Pipeline] // withDockerContainer
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
ERROR: script returned exit code 1
Finished: FAILURE
```

Finally, after changing the gradle image to `gradle:6.6.0-jdk14`,
it worked! :)



Now, I wanted to create an agent, that already has docker CLI installed in it,
and I wanted the agent to be a docker container! Hmm. Hard huh

I tried checking out the Docker agent -

https://github.com/jenkinsci/docker-agent
https://hub.docker.com/r/jenkins/agent/

They call it the base docker image for Jenkins agents. Hmm. So I guess
I need to create my own docker image for my own agent for docker

I had to create a node and mention a launch method and tell it launch
agent via execution of a command

https://github.com/jenkinsci/docker-agent#usage

And give the `docker run` command, for which `docker` CLI has to be
present on the master. RIGHT.

Anyways, if people want to run in some place other than their master server,
I think this is pretty good! :)

```bash
$ docker run -i --rm --name agent --init jenkins/agent java -jar /usr/share/jenkins/agent.jar
```

I found some docs here

https://wiki.jenkins.io/display/JENKINS/Distributed+builds

It's about master/agent architecture I think

https://duckduckgo.com/?q=jenkins+docker+agents&t=ffab&ia=web

There's also another type of docker agent, which can run externally,
and then connect to jenkins master. I think that's cool! Hmm. I mean,
I could run it from my host machine and if it has docker, cool right? :D

https://github.com/jenkinsci/docker-inbound-agent
https://hub.docker.com/r/jenkins/inbound-agent/

I don't know about the volume mount though. Like, do I need to mount the
docker docket in the docker agent too. I think I need to, since it will
run docker CLI, and the config in master talks about using this socket
file but if the agent does not have it, it's not gonna work. Hmm

I also saw something about "Remoting"

https://github.com/jenkinsci/remoting
https://www.jenkins.io/projects/remoting/

It helps with communications between master and agent, also master and CLI

Didn't know there was a CLI in the first place!

Something to note is, I read about this thing called Remote Work
Directory

https://github.com/jenkinsci/remoting/blob/master/docs/workDir.md

Not sure what that is, but I realized that for an efficient pipeline -
a pipeline that can run faster by using lesser resources - network (internet),
and processing etc, ideally caches would help. Surely I need to learn
how to do caching of gradle cache files / directory and also learn how to
create artifacts that can be downloaded. Ideally I would have to upload the
cache to some remote place like docker hub, docker image registry etc for docker
images, and similar repositories for different artifacts. Artifactory is a famous
repository for different kinds of artifacts

I'm trying to run docker external agent now :P And try to connect it to
master from outside

It said something about giving secret. I don't know what secret. I don't
think it's admin secret. So, I'm going to try with no secret and see how it
goes!

I'm going to try to use environment variables to set the jenkins master URL
and port and the agent name too

https://docs.docker.com/engine/reference/commandline/run/#set-environment-variables--e---env---env-file

Okay, it didn't work out

```bash
$ docker run --init --env JENKINS_URL=http://localhost:50000 --env JENKINS_AGENT_NAME=docker-agent-2 jenkins/inbound-agent
Unable to find image 'jenkins/inbound-agent:latest' locally
latest: Pulling from jenkins/inbound-agent
d6ff36c9ec48: Already exists
c958d65b3090: Already exists
edaf0a6b092f: Already exists
80931cf68816: Already exists
bf04b6bbed0c: Already exists
41dc8052672f: Already exists
dbbc65a7534c: Already exists
68e9348843b8: Pull complete
d2b32f40d1c6: Pull complete
6099b4da0df9: Pull complete
513daa4e80a6: Pull complete
c36c06fdde7a: Pull complete
ba5e24a4c22b: Pull complete
ad455270f9aa: Pull complete
Digest: sha256:9392c06eaef92cebe60deae0581541e8ef19197533cd628d792374c4a32199c9
Status: Downloaded newer image for jenkins/inbound-agent:latest
two arguments required, but got [docker-agent-2]
java -jar agent.jar [options...] <secret key> <agent name>
 -agentLog FILE                        : Local agent error log destination
                                         (overrides workDir)
 -cert VAL                             : Specify additional X.509 encoded PEM
                                         certificates to trust when connecting
                                         to Jenkins root URLs. If starting with
                                         @ then the remainder is assumed to be
                                         the name of the certificate file to
                                         read.
 -credentials USER:PASSWORD            : HTTP BASIC AUTH header to pass in for
                                         making HTTP requests.
 -direct (-directConnection) HOST:PORT : Connect directly to this TCP agent
                                         port, skipping the HTTP(S) connection
                                         parameter download. For example,
                                         "myjenkins:50000".
 -disableHttpsCertValidation           : Ignore SSL validation errors - use as
                                         a last resort only. (default: false)
 -failIfWorkDirIsMissing               : Fails the initialization if the
                                         requested workDir or internalDir are
                                         missing ('false' by default) (default:
                                         false)
 -headless                             : Run agent in headless mode, without
                                         GUI (default: false)
 -help                                 : Show this help message (default: false)
 -instanceIdentity VAL                 : The base64 encoded InstanceIdentity
                                         byte array of the Jenkins master. When
                                         this is set, the agent skips
                                         connecting to an HTTP(S) port for
                                         connection info.
 -internalDir VAL                      : Specifies a name of the internal files
                                         within a working directory ('remoting'
                                         by default) (default: remoting)
 -jar-cache DIR                        : Cache directory that stores jar files
                                         sent from the master
 -loggingConfig FILE                   : Path to the property file with
                                         java.util.logging settings
 -noKeepAlive                          : Disable TCP socket keep alive on
                                         connection to the master. (default:
                                         false)
 -noreconnect                          : If the connection ends, don't retry
                                         and just exit. (default: false)
 -protocols VAL                        : Specify the remoting protocols to
                                         attempt when instanceIdentity is
                                         provided.
 -proxyCredentials USER:PASSWORD       : HTTP BASIC AUTH header to pass in for
                                         making HTTP authenticated proxy
                                         requests.
 -tunnel HOST:PORT                     : Connect to the specified host and
                                         port, instead of connecting directly
                                         to Jenkins. Useful when connection to
                                         Jenkins needs to be tunneled. Can be
                                         also HOST: or :PORT, in which case the
                                         missing portion will be auto-configured
                                         like the default behavior
 -url URL                              : Specify the Jenkins root URLs to
                                         connect to.
 -version                              : Shows the version of the remoting jar
                                         and then exits (default: false)
 -webSocket                            : Make a WebSocket connection to Jenkins
                                         rather than using the TCP port.
                                         (default: false)
 -workDir FILE                         : Declares the working directory of the
                                         remoting instance (stores cache and
                                         logs by default)
```

Oops. I found the secret key. It was on the node page. I just didn't notice
it. Damn me

The answer was also here with respect to the jnlp file

https://duckduckgo.com/?q=find+jenkins+agent+sectet&t=ffab&ia=web

https://stackoverflow.com/questions/53103996/where-does-the-jnlp-secret-come-from

https://support.cloudbees.com/hc/en-us/articles/222520647-How-to-find-JNLP-Node-s-secret-key-remotely-

There were even answers around how to connect without secret :P

This is what I tried

```bash
$ docker run --init --env JENKINS_URL=http://localhost:50000 --env JENKINS_AGENT_NAME=docker-agent-2 --env JENKINS_SECRET=9f68cf1f344febdad12b57d1d62eaf0afadb0dfa11379869a0ce2dc6edfb0a36 jenkins/inbound-agent

Aug 16, 2020 1:19:01 PM hudson.remoting.jnlp.Main createEngine
INFO: Setting up agent: docker-agent-2
Aug 16, 2020 1:19:01 PM hudson.remoting.jnlp.Main$CuiListener <init>
INFO: Jenkins agent is running in headless mode.
Aug 16, 2020 1:19:01 PM hudson.remoting.Engine startEngine
INFO: Using Remoting version: 4.3
Aug 16, 2020 1:19:01 PM hudson.remoting.Engine startEngine
WARNING: No Working Directory. Using the legacy JAR Cache location: /home/jenkins/.jenkins/cache/jars
Aug 16, 2020 1:19:01 PM hudson.remoting.jnlp.Main$CuiListener status
INFO: Locating server among [http://localhost:50000]
Aug 16, 2020 1:19:01 PM hudson.remoting.jnlp.Main$CuiListener error
SEVERE: Failed to connect to http://localhost:50000/tcpSlaveAgentListener/: Connection refused (Connection refused)
java.io.IOException: Failed to connect to http://localhost:50000/tcpSlaveAgentListener/: Connection refused (Connection refused)
        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:217)
        at hudson.remoting.Engine.innerRun(Engine.java:693)
        at hudson.remoting.Engine.run(Engine.java:518)
Caused by: java.net.ConnectException: Connection refused (Connection refused)
        at java.net.PlainSocketImpl.socketConnect(Native Method)
        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)
        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)
        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
        at java.net.Socket.connect(Socket.java:607)
        at sun.net.NetworkClient.doConnect(NetworkClient.java:175)
        at sun.net.www.http.HttpClient.openServer(HttpClient.java:463)
        at sun.net.www.http.HttpClient.openServer(HttpClient.java:558)
        at sun.net.www.http.HttpClient.<init>(HttpClient.java:242)
        at sun.net.www.http.HttpClient.New(HttpClient.java:339)
        at sun.net.www.http.HttpClient.New(HttpClient.java:357)
        at sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:1226)
        at sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1162)
        at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1056)
        at sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:990)
        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:214)
        ... 2 more
```

I was referring to the host machine in the wrong manner. I need to point
to host machine or the jenkins container, but I was pointing the container
to itself. Lol :P

Then I tried these

```bash
$ docker run --init --env JENKINS_URL=http://host.internal.docker:50000 --env JENKINS_AGENT_NAME=docker-agent-2 --env JENKINS_SECRET=9f68cf1f344febdad12b57d1d62eaf0afadb0dfa11379869a0ce2dc6edfb0a36 jenk
ins/inbound-agent
Aug 16, 2020 1:19:41 PM hudson.remoting.jnlp.Main createEngine
INFO: Setting up agent: docker-agent-2
Aug 16, 2020 1:19:41 PM hudson.remoting.jnlp.Main$CuiListener <init>
INFO: Jenkins agent is running in headless mode.
Aug 16, 2020 1:19:41 PM hudson.remoting.Engine startEngine
INFO: Using Remoting version: 4.3
Aug 16, 2020 1:19:41 PM hudson.remoting.Engine startEngine
WARNING: No Working Directory. Using the legacy JAR Cache location: /home/jenkins/.jenkins/cache/jars
Aug 16, 2020 1:19:41 PM hudson.remoting.jnlp.Main$CuiListener status
INFO: Locating server among [http://host.internal.docker:50000]
Aug 16, 2020 1:19:41 PM hudson.remoting.jnlp.Main$CuiListener error
SEVERE: Failed to connect to http://host.internal.docker:50000/tcpSlaveAgentListener/: host.internal.docker
java.io.IOException: Failed to connect to http://host.internal.docker:50000/tcpSlaveAgentListener/: host.internal.docker

        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:217)
        at hudson.remoting.Engine.innerRun(Engine.java:693)
        at hudson.remoting.Engine.run(Engine.java:518)
Caused by: java.net.UnknownHostException: host.internal.docker
        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:184)
        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
        at java.net.Socket.connect(Socket.java:607)
        at sun.net.NetworkClient.doConnect(NetworkClient.java:175)
        at sun.net.www.http.HttpClient.openServer(HttpClient.java:463)
        at sun.net.www.http.HttpClient.openServer(HttpClient.java:558)
        at sun.net.www.http.HttpClient.<init>(HttpClient.java:242)
        at sun.net.www.http.HttpClient.New(HttpClient.java:339)
        at sun.net.www.http.HttpClient.New(HttpClient.java:357)
        at sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:1226)
        at sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1162)
        at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1056)
        at sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:990)
        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:214)
        ... 2 more
```

It was actually `host.docker.internal` it seems and not `host.internal.docker`.
Found it here

https://github.com/docker/for-linux/issues/264

I remember reading it somewhere :P

It's also here

https://dev.to/natterstefan/docker-tip-how-to-get-host-s-ip-address-inside-a-docker-container-5anh

Official docs

https://docs.docker.com/search/?q=host.docker.internal

For windows
https://docs.docker.com/docker-for-windows/networking/#use-cases-and-workarounds

For mac
https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds

Docker for Mac release notes for one of the releases
https://docs.docker.com/docker-for-mac/release-notes/#docker-community-edition-18030-ce-mac59-2018-03-26

```bash
$ docker run --init --env JENKINS_URL=http://host.docker.internal:50000 --env JENKIN
S_AGENT_NAME=docker-agent-2 --env JENKINS_SECRET=9f68cf1f344febdad12b57d1d62eaf0afadb0dfa11379869a0ce2dc6edfb0a36 j
enkins/inbound-agent
Aug 16, 2020 1:20:23 PM hudson.remoting.jnlp.Main createEngine
INFO: Setting up agent: docker-agent-2
Aug 16, 2020 1:20:23 PM hudson.remoting.jnlp.Main$CuiListener <init>
INFO: Jenkins agent is running in headless mode.
Aug 16, 2020 1:20:24 PM hudson.remoting.Engine startEngine
INFO: Using Remoting version: 4.3
Aug 16, 2020 1:20:24 PM hudson.remoting.Engine startEngine
WARNING: No Working Directory. Using the legacy JAR Cache location: /home/jenkins/.jenkins/cache/jars
Aug 16, 2020 1:20:24 PM hudson.remoting.jnlp.Main$CuiListener status
INFO: Locating server among [http://host.docker.internal:50000]
Aug 16, 2020 1:20:24 PM hudson.remoting.jnlp.Main$CuiListener error
SEVERE: http://host.docker.internal:50000/tcpSlaveAgentListener/ is invalid: 404 Not Found
java.io.IOException: http://host.docker.internal:50000/tcpSlaveAgentListener/ is invalid: 404 Not Found
        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:222)
        at hudson.remoting.Engine.innerRun(Engine.java:693)
        at hudson.remoting.Engine.run(Engine.java:518)
```

Found the issue with this question's answer

https://stackoverflow.com/questions/44180595/tcpslaveagentlistener-not-found-on-jenkins-server

https://stackoverflow.com/a/58023105/4772008

Going to http://localhost:50000/ gave some details but 

http://localhost:50000/tcpSlaveAgentListener gave 404

Apparently the port to use in the url was 8080 only. It later detected
that agent port is 50000

Awesome! So I have tried both inbound and invoke as command agents! :D
I think inbound would be the usual. As invoking as command would mean that
it's still running on master, is what I believe. There's one more - something
about SSH. That's cool too I guess, to use more nodes! :)

Ideally, these days, people are using Kubernetes or some form of container
orchestration and creating and running containers whenever necessary and then
killing it off, since these are just one time jobs and not long running services
:)

I think lambdas are also possible in this case, to run jobs

And they have plugins for that too!

https://duckduckgo.com/?t=ffab&q=jenkins+aws+lambda&ia=web

https://www.jenkins.io/doc/pipeline/steps/aws-lambda/

https://plugins.jenkins.io/aws-lambda/


