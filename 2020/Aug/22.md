# August 22nd 2020

A team mate shared this nice link about responses and latency

https://github.com/Tendrl/documentation/wiki/Best-Practices-for-Response-Times-and-Latency

---

Today I was checking out how the Spring Boot OCI image building happens with the
gradle task `bootBuildImage` and I found this nice article

https://medium.com/@TimvanBaarsen/first-look-at-cloud-native-buildpacks-support-in-spring-boot-2-3-milestone-1-ece8e72ed93f

I do remember the docs

https://docs.spring.io/spring-boot/docs/2.3.2.RELEASE/gradle-plugin/reference/html/#build-image

mentioning about Cloud Native Buildpacks - https://buildpacks.io/, but the
article was still quite useful to also find out about https://paketo.io 

I was however going to find out how the image building happens using buildpacks
in Spring Boot. This is a good start! :)

I have a sample project here https://github.com/karuppiah7890/spring-stuff/tree/master/example-project

I tried to build image without running docker daemon / engine and this happened

```bash
$ ./gradlew bootBuildImage
Starting a Gradle Daemon (subsequent builds will be faster)

> Task :bootBuildImage FAILED
Building image 'docker.io/library/example-project:0.0.1-SNAPSHOT'

 > Pulling builder image 'gcr.io/paketo-buildpacks/builder:base-platform-api-0.3' ..................................................

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':bootBuildImage'.
> Docker API call to 'localhost/v1.24/images/create?fromImage=gcr.io%2Fpaketo-buildpacks%2Fbuilder%3Abase-platform-api-0.3' failed with status code 500 "Internal Server Error"

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 10s
4 actionable tasks: 1 executed, 3 up-to-date
```

After starting docker daemon, I ran it again

```bash
$ ./gradlew bootBuildImage
> Task :compileJava UP-TO-DATE
> Task :processResources UP-TO-DATE
> Task :classes UP-TO-DATE
> Task :bootJar UP-TO-DATE

> Task :bootBuildImage
Building image 'docker.io/library/example-project:0.0.1-SNAPSHOT'

 > Pulling builder image 'gcr.io/paketo-buildpacks/builder:base-platform-api-0.3' ..................................................
 > Pulled builder image 'gcr.io/paketo-buildpacks/builder@sha256:5e0a48bf0960e0f3c169a90058e5b7c4b76bc8b2cfabb9d2d4e296262145523c'
 > Pulling run image 'docker.io/paketobuildpacks/run:base-cnb' ..................................................
 > Pulled run image 'paketobuildpacks/run@sha256:61a5832385b8cba83779eeb307d9014090702a23abd5e0b441c5590923c6e6ee'
 > Executing lifecycle version v0.9.1
 > Using build cache volume 'pack-cache-70b329ef63cf.build'

 > Running creator
    [creator]     ===> DETECTING
    [creator]     5 of 16 buildpacks participating
    [creator]     paketo-buildpacks/bellsoft-liberica 2.13.0
    [creator]     paketo-buildpacks/executable-jar    2.1.1
    [creator]     paketo-buildpacks/apache-tomcat     1.5.0
    [creator]     paketo-buildpacks/dist-zip          1.4.0
    [creator]     paketo-buildpacks/spring-boot       2.5.0
    [creator]     ===> ANALYZING
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:memory-calculator" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:openssl-certificate-loader" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:security-providers-configurer" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:class-counter" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:java-security-properties" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:jre" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:jvmkill" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/bellsoft-liberica:link-local-dns" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/executable-jar:class-path" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/spring-boot:spring-cloud-bindings" from app image
    [creator]     Restoring metadata for "paketo-buildpacks/spring-boot:web-application-type" from app image
    [creator]     ===> RESTORING
    [creator]     ===> BUILDING
    [creator]     
    [creator]     Paketo BellSoft Liberica Buildpack 2.13.0
    [creator]       https://github.com/paketo-buildpacks/bellsoft-liberica
    [creator]       Build Configuration:
    [creator]         $BP_JVM_VERSION              14.*            the Java version
    [creator]       Launch Configuration:
    [creator]         $BPL_JVM_HEAD_ROOM           0               the headroom in memory calculation
    [creator]         $BPL_JVM_LOADED_CLASS_COUNT  35% of classes  the number of loaded classes in memory calculation
    [creator]         $BPL_JVM_THREAD_COUNT        250             the number of threads in memory calculation
    [creator]         $JAVA_OPTS                                   the flags that influence JVM memory configuration at launch
    [creator]       BellSoft Liberica JRE 14.0.2: Reusing cached layer
    [creator]       Memory Calculator 4.1.0: Reusing cached layer
    [creator]       Class Counter: Reusing cached layer
    [creator]       JVMKill Agent 1.16.0: Reusing cached layer
    [creator]       Link-Local DNS: Reusing cached layer
    [creator]       Java Security Properties: Reusing cached layer
    [creator]       Security Providers Configurer: Reusing cached layer
    [creator]       OpenSSL Certificate Loader: Reusing cached layer
    [creator]     
    [creator]     Paketo Executable JAR Buildpack 2.1.1
    [creator]       https://github.com/paketo-buildpacks/executable-jar
    [creator]       Launch Configuration:
    [creator]         $JAVA_OPTS  the flags passed to the JVM process at launch
    [creator]       Process types:
    [creator]         executable-jar: java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
    [creator]         task:           java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
    [creator]         web:            java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
    [creator]     
    [creator]     Paketo Spring Boot Buildpack 2.5.0
    [creator]       https://github.com/paketo-buildpacks/spring-boot
    [creator]       Build Configuration:
    [creator]         $BP_BOOT_NATIVE_IMAGE                  the build to create a native image (requires GraalVM)
    [creator]         $BP_BOOT_NATIVE_IMAGE_BUILD_ARGUMENTS  the arguments to pass to the native-image command
    [creator]       Launch Configuration:
    [creator]         $BPL_SPRING_CLOUD_BINDINGS_ENABLED     whether to auto-configure Spring Boot environment properties from bindings
    [creator]       Web Application Type: Reusing cached layer
    [creator]       Spring Cloud Bindings 1.4.0: Reusing cached layer
    [creator]       Image labels:
    [creator]         org.springframework.boot.spring-configuration-metadata.json
    [creator]         org.springframework.boot.version
    [creator]     ===> EXPORTING
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:class-counter'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:java-security-properties'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:jre'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:jvmkill'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:link-local-dns'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:memory-calculator'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:openssl-certificate-loader'
    [creator]     Reusing layer 'paketo-buildpacks/bellsoft-liberica:security-providers-configurer'
    [creator]     Reusing layer 'paketo-buildpacks/executable-jar:class-path'
    [creator]     Reusing layer 'paketo-buildpacks/spring-boot:spring-cloud-bindings'
    [creator]     Reusing layer 'paketo-buildpacks/spring-boot:web-application-type'
    [creator]     Reusing 1/1 app layer(s)
    [creator]     Adding layer 'launcher'
    [creator]     Reusing layer 'config'
    [creator]     Adding label 'io.buildpacks.lifecycle.metadata'
    [creator]     Adding label 'io.buildpacks.build.metadata'
    [creator]     Adding label 'io.buildpacks.project.metadata'
    [creator]     Adding label 'org.springframework.boot.spring-configuration-metadata.json'
    [creator]     Adding label 'org.springframework.boot.version'
    [creator]     *** Images (8dc384a5cd29):
    [creator]           docker.io/library/example-project:0.0.1-SNAPSHOT

Successfully built image 'docker.io/library/example-project:0.0.1-SNAPSHOT'


BUILD SUCCESSFUL in 1m 8s
4 actionable tasks: 1 executed, 3 up-to-date
```

You can see how it mentions that 5 build packs out of 16 are "participating".
The 5 being -

```
paketo-buildpacks/bellsoft-liberica 2.13.0
paketo-buildpacks/executable-jar    2.1.1
paketo-buildpacks/apache-tomcat     1.5.0
paketo-buildpacks/dist-zip          1.4.0
paketo-buildpacks/spring-boot       2.5.0
```

There are also github links to some of these repos, which is also present in
https://paketo.io

https://github.com/paketo-buildpacks/bellsoft-liberica

Bellsoft Liberica seems to be a Java JDK. They say they are based on OpenJDK
https://bell-sw.com/

https://github.com/bell-sw/Liberica

There's also a list here - https://en.wikipedia.org/wiki/List_of_Java_virtual_machines
But Bellsoft Liberica is not mentioned. Probably needs updation

The whole list of paketo buildpacks are here

https://github.com/paketo-buildpacks

I think the best way to completely understand this whole thing would be to try
out https://buildpacks.io/

https://buildpacks.io/docs/

https://buildpacks.io/docs/install-pack

I'm installing `pack` using this

```bash
brew install buildpacks/tap/pack
```

The codebase is present here - https://github.com/buildpacks/pack

https://github.com/buildpacks

Apparently, `pack` is just ONE implementation of the specificiation - 
https://github.com/buildpacks/spec/blob/main/platform.md

There's also some reference implementation here -
https://github.com/buildpacks/lifecycle . Not sure reference for what exactly.
Need to check the spec to understand better!

Okay, so, now, back to the getting started tutorial.

I'm gonna try out the `pack build` command for this repo
https://github.com/buildpacks/samples

```bash
$ git clone https://github.com/buildpacks/samples
$ cd samples/apps/java-maven
$ pack build myapp --builder cnbs/sample-builder:bionic
$ pack build myapp --builder cnbs/sample-builder:bionic
bionic: Pulling from cnbs/sample-builder
f08d8e2a3ba1: Pulling fs layer
3baa9cb2483b: Pulling fs layer
94e5ff4c0b15: Pulling fs layer
1860925334f9: Pulling fs layer
38e986b63556: Pulling fs layer
e833c10cbd65: Pulling fs layer
7edaacf9294a: Pulling fs layer
7f50219ab52a: Pull complete
fff13c0c6e58: Pull complete
357fefdf9bc9: Pull complete
8a1df4ac84fa: Pull complete
5c2e4179bee1: Pull complete
c4e3bdcbb8c3: Pull complete
a9e3bebbec9b: Pull complete
c238db6a02a5: Pull complete
cd9f965d8b4c: Pull complete
c73d7aed05e0: Pull complete
a302059dbdba: Pull complete
db1bbcc47135: Pull complete
4f4fb700ef54: Pull complete
Digest: sha256:354bf4fde98f7ceb861428072646c6115dc7c86b6cb741669f0cc16ceea5e595
Status: Downloaded newer image for cnbs/sample-builder:bionic
bionic: Pulling from cnbs/sample-stack-run
f08d8e2a3ba1: Already exists
3baa9cb2483b: Already exists
94e5ff4c0b15: Already exists
1860925334f9: Already exists
38e986b63556: Already exists
e833c10cbd65: Already exists
Digest: sha256:01579e323fa8dfcd6ad524ec6f0b07e63397afb06c48bc764d78c77cabf6fa05
Status: Downloaded newer image for cnbs/sample-stack-run:bionic
0.9.1: Pulling from buildpacksio/lifecycle
4000adbbc3eb: Pull complete
474f7dcb012d: Pull complete
Digest: sha256:53bf0e18a734e0c4071aa39b950ed8841f82936e53fb2a0df56c6aa07f9c5023
Status: Downloaded newer image for buildpacksio/lifecycle:0.9.1
===> DETECTING
[detector] samples/java-maven 0.0.1
===> ANALYZING
[analyzer] Previous image with name "index.docker.io/library/myapp:latest" not found
===> RESTORING
===> BUILDING
[builder] ---> Java buildpack
[builder] ---> Installing JDK
[builder] ---> Running Maven Wrapper
[builder] [INFO] Scanning for projects...
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/maven-metadata.xml
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/maven-metadata.xml (4.5 kB at 3.2 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/2.1.16.RELEASE/spring-boot-starter-parent-2.1.16.RELEASE.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/2.1.16.RELEASE/spring-boot-starter-parent-2.1.16.RELEASE.pom (9.5 kB at 18 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-dependencies/2.1.16.RELEASE/spring-boot-dependencies-2.1.16.RELEASE.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-dependencies/2.1.16.RELEASE/spring-boot-dependencies-2.1.16.RELEASE.pom (118 kB at 120 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-bom/2.9.10.20200621/jackson-bom-2.9.10.20200621.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-bom/2.9.10.20200621/jackson-bom-2.9.10.20200621.pom (13 kB at 22 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-parent/2.9.1.2/jackson-parent-2.9.1.2.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-parent/2.9.1.2/jackson-parent-2.9.1.2.pom (7.9 kB at 15 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/com/fasterxml/oss-parent/34/oss-parent-34.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/com/fasterxml/oss-parent/34/oss-parent-34.pom (23 kB at 47 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/io/netty/netty-bom/4.1.51.Final/netty-bom-4.1.51.Final.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/io/netty/netty-bom/4.1.51.Final/netty-bom-4.1.51.Final.pom (8.8 kB at 15 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/sonatype/oss/oss-parent/7/oss-parent-7.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/sonatype/oss/oss-parent/7/oss-parent-7.pom (4.8 kB at 8.1 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/io/projectreactor/reactor-bom/Californium-SR20/reactor-bom-Californium-SR20.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/io/projectreactor/reactor-bom/Californium-SR20/reactor-bom-Californium-SR20.pom (3.7 kB at 6.4 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/logging/log4j/log4j-bom/2.11.2/log4j-bom-2.11.2.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/apache/logging/log4j/log4j-bom/2.11.2/log4j-bom-2.11.2.pom (6.5 kB at 11 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/logging/logging-parent/1/logging-parent-1.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/apache/logging/logging-parent/1/logging-parent-1.pom (3.2 kB at 6.0 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/apache/18/apache-18.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/apache/apache/18/apache-18.pom (16 kB at 30 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/codehaus/groovy/groovy-bom/2.5.13/groovy-bom-2.5.13.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/codehaus/groovy/groovy-bom/2.5.13/groovy-bom-2.5.13.pom (26 kB at 44 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/eclipse/jetty/jetty-bom/9.4.30.v20200611/jetty-bom-9.4.30.v20200611.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/eclipse/jetty/jetty-bom/9.4.30.v20200611/jetty-bom-9.4.30.v20200611.pom (17 kB at 30 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/glassfish/jersey/jersey-bom/2.27/jersey-bom-2.27.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/glassfish/jersey/jersey-bom/2.27/jersey-bom-2.27.pom (22 kB at 38 kB/s)
....

```

It's a lot of logs actually! 😅

Oops. There was an error at the end

```bash
...
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/codehaus/plexus/plexus-utils/3.0.15/plexus-utils-3.0.15.jar (239 kB at 442 kB/s)
[builder] [INFO] Installing /workspace/target/sample-0.0.1-SNAPSHOT.jar to /home/cnb/.m2/repository/io/buildpacks/example/sample/0.0.1-SNAPSHOT/sample-0.0.1-SNAPSHOT.jar
[builder] [INFO] Installing /workspace/pom.xml to /home/cnb/.m2/repository/io/buildpacks/example/sample/0.0.1-SNAPSHOT/sample-0.0.1-SNAPSHOT.pom
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] BUILD SUCCESS
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] Total time:  04:09 min
[builder] [INFO] Finished at: 2020-08-22T07:10:20Z
[builder] [INFO] ------------------------------------------------------------------------
===> EXPORTING
[exporter] Adding layer 'samples/java-maven:jdk'
[exporter] ERROR: failed to export: caching layer (sha256:a940b3489712c1f762caef8b37675f15364a65f10fb7d3f2299109f7a637afef): write /launch-cache/staging/sha256:a940b3489712c1f762caef8b37675f15364a65f10fb7d3f2299109f7a637afef.tar: no space left on device
ERROR: failed to build: executing lifecycle. This may be the result of using an untrusted builder: failed with status code: 246
```

And it goes on again!

```bash
 $ pack build myapp --builder cnbs/sample-builder:bionic
bionic: Pulling from cnbs/sample-builder
Digest: sha256:354bf4fde98f7ceb861428072646c6115dc7c86b6cb741669f0cc16ceea5e595
Status: Image is up to date for cnbs/sample-builder:bionic
bionic: Pulling from cnbs/sample-stack-run
Digest: sha256:01579e323fa8dfcd6ad524ec6f0b07e63397afb06c48bc764d78c77cabf6fa05
Status: Image is up to date for cnbs/sample-stack-run:bionic
0.9.1: Pulling from buildpacksio/lifecycle
Digest: sha256:53bf0e18a734e0c4071aa39b950ed8841f82936e53fb2a0df56c6aa07f9c5023
Status: Image is up to date for buildpacksio/lifecycle:0.9.1
===> DETECTING
[detector] samples/java-maven 0.0.1
===> ANALYZING
[analyzer] Previous image with name "index.docker.io/library/myapp:latest" not found
===> RESTORING
===> BUILDING
[builder] ---> Java buildpack
[builder] ---> Installing JDK
[builder] ---> Running Maven Wrapper
[builder] [INFO] Scanning for projects...
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/maven-metadata.xml
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/maven-metadata.xml (4.5 kB at 3.0 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/2.1.16.RELEASE/spring-boot-starter-parent-2.1.16.RELEASE.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/2.1.16.RELEASE/spring-boot-starter-parent-2.1.16.RELEASE.pom (9.5 kB at 20 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-dependencies/2.1.16.RELEASE/spring-boot-dependencies-2.1.16.RELEASE.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-dependencies/2.1.16.RELEASE/spring-boot-dependencies-2.1.16.RELEASE.pom (118 kB at 117 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-bom/2.9.10.20200621/jackson-bom-2.9.10.20200621.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-bom/2.9.10.20200621/jackson-bom-2.9.10.20200621.pom (13 kB at 19 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-parent/2.9.1.2/jackson-parent-2.9.1.2.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/com/fasterxml/jackson/jackson-parent/2.9.1.2/jackson-parent-2.9.1.2.pom (7.9 kB at 13 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/com/fasterxml/oss-parent/34/oss-parent-34.pom
[builder] [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/com/fasterxml/oss-parent/34/oss-parent-34.pom (23 kB at 38 kB/s)
[builder] [INFO] Downloading from central: https://repo.maven.apache.org/maven2/io/netty/netty-bom/4.1.51.Final/netty-bom-4.1.51.Final.pom
...
...
builder] [INFO] Installing /workspace/target/sample-0.0.1-SNAPSHOT.jar to /home/cnb/.m2/repository/io/buildpacks/example/sample/0.0.1-SNAPSHOT/sample-0.0.1-SNAPSHOT.jar
[builder] [INFO] Installing /workspace/pom.xml to /home/cnb/.m2/repository/io/buildpacks/example/sample/0.0.1-SNAPSHOT/sample-0.0.1-SNAPSHOT.pom
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] BUILD SUCCESS
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] Total time:  04:00 min
[builder] [INFO] Finished at: 2020-08-22T07:15:58Z
[builder] [INFO] ------------------------------------------------------------------------
===> EXPORTING
[exporter] Adding layer 'samples/java-maven:jdk'
[exporter] ERROR: failed to export: caching layer (sha256:a940b3489712c1f762caef8b37675f15364a65f10fb7d3f2299109f7a637afef): write /launch-cache/staging/sha256:a940b3489712c1f762caef8b37675f15364a65f10fb7d3f2299109f7a637afef.tar: no space left on device
ERROR: failed to build: executing lifecycle. This may be the result of using an untrusted builder: failed with status code: 246
```

Again same error. I just noticed the error properly. Damn me. It says "no space
left on device". Weird. I mean, I do have very less space, like 11GB in my
machine. But I thought that would be enough. Hmm

I tried some stuff to get rid of things to get more space. But I forgot that
the docker daemon is using a VM of it's own and has some space allocated for the
VM and I think that's where the issue is. The VM doesn't have enough space.

Tried some stuff

https://stackoverflow.com/questions/30604846/docker-error-no-space-left-on-device#37287054

Didn't remove some volumes alone though

Some more links

https://net2.com/how-to-fix-docker-error-no-space-left-on-device/

https://forums.docker.com/t/no-space-left-on-device-error/10894/43

https://stackoverflow.com/questions/30604846/docker-error-no-space-left-on-device/36584376#36584376

I still faced issues after removing some stuff. Now I removed everything! Let's
see how that works!

This time again a failure, but it said something about no layers being found.
Maybe it's because I deleted stuff while it was running. I don't know. Now
I have run it again. Let's see

Since this is taking a lot of time. I'm going to checkout the next tutorial
on how to create a buildpack

https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/

https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/setup-local-environment/

```bash
$ mkdir buildpack-demo
$ cd buildpack-demo/
$ git init
$ mkdir ruby-sample-app
$ cd ruby-sample-app
```

```bash
$ cat > app.rb
require 'sinatra'

set :bind, '0.0.0.0'
set :port, 8080

get '/' do
  'Hello World!'
end
$ ls
app.rb
```

```bash
$ cat > Gemfile
source "https://rubygems.org"

git_source(:github) {|repo_name| "https://github.com/#{repo_name}" }

gem "sinatra"
$ ls
Gemfile app.rb
```

```bash
$ cd ..
$ ls
ruby-sample-app
$ mkdir ruby-cloud-native-buildpack
$ cd ruby-cloud-native-buildpack/
$ docker version
Client: Docker Engine - Community
 Version:           19.03.12
 API version:       1.40
 Go version:        go1.13.10
 Git commit:        48a66213fe
 Built:             Mon Jun 22 15:41:33 2020
 OS/Arch:           darwin/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.12
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.13.10
  Git commit:       48a66213fe
  Built:            Mon Jun 22 15:49:27 2020
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          v1.2.13
  GitCommit:        7ad184331fa3e55e52b890ea95e65ba581ae3429
 runc:
  Version:          1.0.0-rc10
  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683
```

Next

https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/building-blocks-cnb/

https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/building-blocks-cnb/#buildpacktoml

```bash
$ cd ruby-cloud-native-buildpack/
$ cat > buildpack.toml
# Buildpack API version
api = "0.2"

# Buildpack ID and metadata
[buildpack]
id = "com.examples.buildpacks.ruby"
version = "0.0.1"
name = "Ruby Buildpack"

# Stacks that the buildpack will work with
[[stacks]]
id = "heroku-18"

[[stacks]]
id = "org.cloudfoundry.stacks.cflinuxfs3"
```

---

On a parallel note, the build for the java app worked finally! :)

```bash
...
...
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] BUILD SUCCESS
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] Total time:  03:55 min
[builder] [INFO] Finished at: 2020-08-22T08:21:03Z
[builder] [INFO] ------------------------------------------------------------------------
===> EXPORTING
[exporter] Adding layer 'samples/java-maven:jdk'
[exporter] Adding 1/1 app layer(s)
[exporter] Adding layer 'launcher'
[exporter] Adding layer 'config'
[exporter] Adding layer 'process-types'
[exporter] Adding label 'io.buildpacks.lifecycle.metadata'
[exporter] Adding label 'io.buildpacks.build.metadata'
[exporter] Adding label 'io.buildpacks.project.metadata'
[exporter] Setting default process type 'web'
[exporter] *** Images (c04a65731fa6):
[exporter]       index.docker.io/library/myapp:latest
[exporter] Adding cache layer 'samples/java-maven:jdk'
[exporter] Adding cache layer 'samples/java-maven:maven_m2'
Successfully built image myapp
```

```bash
$ docker images myapp
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
myapp               latest              c04a65731fa6        40 years ago        301MB
```

```bash
$ docker run --rm -p 8080:8080 myapp
    |'-_ _-'|       ____          _  _      _                      _             _
    |   |   |      |  _ \        (_)| |    | |                    | |           (_)
     '-_|_-'       | |_) | _   _  _ | |  __| | _ __    __ _   ___ | | __ ___     _   ___
|'-_ _-'|'-_ _-'|  |  _ < | | | || || | / _` || '_ \  / _` | / __|| |/ // __|   | | / _ \
|   |   |   |   |  | |_) || |_| || || || (_| || |_) || (_| || (__ |   < \__ \ _ | || (_) |
 '-_|_-' '-_|_-'   |____/  \__,_||_||_| \__,_|| .__/  \__,_| \___||_|\_\|___/(_)|_| \___/
                                              | |
                                              |_|

:: Built with Spring Boot :: 2.1.16.RELEASE

2020-08-22 08:27:00.512  INFO 1 --- [           main] i.b.example.sample.SampleApplication     : Starting SampleApplication v0.0.1-SNAPSHOT on 78dba6c40e33 with PID 1 (/workspace/target/sample-0.0.1-SNAPSHOT.jar started by cnb in /workspace)
2020-08-22 08:27:00.521  INFO 1 --- [           main] i.b.example.sample.SampleApplication     : No active profile set, falling back to default profiles: default
2020-08-22 08:27:04.732  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2020-08-22 08:27:04.825  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2020-08-22 08:27:04.826  INFO 1 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.37]
2020-08-22 08:27:05.061  INFO 1 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2020-08-22 08:27:05.062  INFO 1 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 4363 ms
2020-08-22 08:27:05.770  INFO 1 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'
2020-08-22 08:27:05.974  INFO 1 --- [           main] o.s.b.a.w.s.WelcomePageHandlerMapping    : Adding welcome page template: index
2020-08-22 08:27:06.385  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2020-08-22 08:27:06.392  INFO 1 --- [           main] i.b.example.sample.SampleApplication     : Started SampleApplication in 7.445 seconds (JVM running for 8.501)
2020-08-22 08:27:17.291  INFO 1 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2020-08-22 08:27:17.292  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2020-08-22 08:27:17.307  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 14 ms
```

```bash
$ curl localhost:8080
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Buildpacks.io Java Sample</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        html, body {
            font-family: sans-serif;
            margin: 0;
            height: 100%;
        }
        .content-centered {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="content-centered" style="margin: 0 auto; flex-direction: column; width: 67%; height: 100%;">
        <div class="content-centered">
            <a href="https://buildpacks.io"><img src="/buildpacks-logo.svg" alt="Buildpacks.io Logo" style="width:50vw;"></a>
        </div>
        <h1>Hello, Buildpacker!</h1>
    </div>
</body>
</html>
```

---

Continuing on creating a buildpack for ruby app! :)

Some trivia about buildpacks - Heroku and Pivotal worked on Buildpacks together.
There's some docs on buildpacks with respect to Cloud Foundry - 
https://docs.cloudfoundry.org/buildpacks/ . I'm able to see some similarity with
that and the docs of buildpacks.io

https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/building-blocks-cnb/#detect-and-build

```bash
$ mkdir bin
$ cd bin
$ cat > detect
#!/usr/bin/env bash
set -eo pipefail

exit 1
$ cat > build
#!/usr/bin/env bash
set -eo pipefail

echo "---> Ruby Buildpack"
exit 1
$ chmod +x detect build
```

It's asking me to set a default builder but I don't want to. Hmm. I'm going to
just move on and see how to pass the builder

```bash
$ pack build test-ruby-app --path ruby-sample-app --buildpack ruby-cloud-native-build
pack/
Please select a default builder with:

        pack set-default-builder <builder-image>

Suggested builders:
        Google:                gcr.io/buildpacks/builder:v1      Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python
        Heroku:                heroku/buildpacks:18              heroku-18 base image with buildpacks for Ruby, Java, Node.js, Python, Golang, & PHP
        Paketo Buildpacks:     paketobuildpacks/builder:base     Ubuntu bionic base image with buildpacks for Java, NodeJS and Golang
        Paketo Buildpacks:     paketobuildpacks/builder:full     Ubuntu bionic base image with buildpacks for Java, NodeJS and Golang
        Paketo Buildpacks:     paketobuildpacks/builder:tiny     Tiny base image (bionic build image, distroless run image) with buildpacks for Golang

Tip: Learn more about a specific builder with:
        pack inspect-builder <builder-image>
```

Okay, so I must set a default builder huh. I'm thinking if I can explicitly
mention one

```bash
$ pack build --help
Generate app image from source code

Usage:
  pack build <image-name> [flags]

Flags:
  -B, --builder string           Builder image
  -b, --buildpack strings        Buildpack reference in the form of '<buildpack>@<version>',
                                   path to a buildpack directory (not supported on Windows),
                                   path/URL to a buildpack .tar or .tgz file, or
                                   the name of a packaged buildpack image
                                 Repeat for each buildpack in order,
                                   or supply once by comma-separated list
      --clear-cache              Clear image's associated cache before building
  -D, --default-process string   Set the default process type. (default "web")
  -d, --descriptor string        Path to the project descriptor file
  -e, --env stringArray          Build-time environment variable, in the form 'VAR=VALUE' or 'VAR'.
                                 When using latter value-less form, value will be taken from current
                                   environment at the time this command is executed.
                                 This flag may be specified multiple times and will override
                                   individual values defined by --env-file.
      --env-file stringArray     Build-time environment variables file
                                 One variable per line, of the form 'VAR=VALUE' or 'VAR'
                                 When using latter value-less form, value will be taken from current
                                   environment at the time this command is executed
  -h, --help                     Help for 'build'
      --network string           Connect detect and build containers to network
  -p, --path string              Path to app dir or zip-formatted file (defaults to current working directory)
      --publish                  Publish to registry
      --pull-policy string       Pull policy to use. Accepted values are always, never, and if-not-present. (default "always")
      --run-image string         Run image (defaults to default stack's run image)
      --trust-builder            Trust the provided builder
                                 All lifecycle phases will be run in a single container (if supported by the lifecycle).
      --volume stringArray       Mount host volume into the build container, in the form '<host path>:<target path>[:<mode>]'.
                                 Repeat for each volume in order,
                                   or supply once by comma-separated list

Global Flags:
      --no-color     Disable color output
  -q, --quiet        Show less output
      --timestamps   Enable timestamps in output
  -v, --verbose      Show more output
```

This worked

```bash
$ pack build test-ruby-app --path ruby-sample-app --buildpack ruby-cloud-native-buildpack/ --builder heroku/buildpacks:18
```

So I didn't have to run

```bash
$ pack set-default-builder heroku/buildpacks:18
```

or

```bash
$ pack set-default-builder cloudfoundry/cnb:cflinuxfs3
```

But I got an error for the build

```bash
$ pack build test-ruby-app --path ruby-sample-app --buildpack ruby-cloud-native-buildpack/ --builder heroku/buildpacks:18
18: Pulling from heroku/buildpacks
7595c8c21622: Pulling fs layer
d13af8ca898f: Pulling fs layer
70799171ddba: Pulling fs layer
b6c12202c5ef: Pull complete
4286420d201d: Pull complete
a6546328019a: Pull complete
b754011f7f0b: Pull complete
97aaf381a2df: Pull complete
c065d5ea6037: Pull complete
6790852fabc4: Pull complete
a9b5a20ed466: Pull complete
94af31a6b19c: Pull complete
357fefdf9bc9: Pull complete
d77ba4498082: Pull complete
215f170a7d54: Pull complete
0accb52f759b: Pull complete
96a819df452e: Pull complete
c6c977203e6f: Pull complete
ca5bfa5fd6c4: Pull complete
1970a12846d3: Pull complete
cb232a1459f4: Pull complete
716e9fa5ee2f: Pull complete
58a8b8b0d71b: Pull complete
7ea492a7564a: Pull complete
5a31d8431a18: Pull complete
fa58053c8642: Pull complete
e80fe5117c2a: Pull complete
4f4fb700ef54: Pull complete
Digest: sha256:727ead7351cefc3e4bd7886466fa42aff53a4d027986153d422da499b9a7e125
Status: Downloaded newer image for heroku/buildpacks:18
18: Pulling from heroku/pack
7595c8c21622: Already exists
d13af8ca898f: Already exists
70799171ddba: Already exists
b6c12202c5ef: Already exists
4286420d201d: Already exists
a6546328019a: Already exists
bb699b54908f: Pull complete
98e4d2eab805: Pull complete
Digest: sha256:6b50474e50f35f52afa9bba47067438cd666d5018f1105ab815d8b222ae1b0f8
Status: Downloaded newer image for heroku/pack:18
===> DETECTING
ERROR: No buildpack groups passed detection.
ERROR: Please check that you are running against the correct path.
ERROR: failed to detect: failed to detect: no buildpacks participating
ERROR: failed to build: failed with status code: 1
```

Btw, the `heroku/buildpacks` is an image for the builder. It's here
https://hub.docker.com/r/heroku/buildpacks

All tags - https://hub.docker.com/r/heroku/buildpacks/tags , including `18`

https://hub.docker.com/layers/heroku/buildpacks/18/images/sha256-727ead7351cefc3e4bd7886466fa42aff53a4d027986153d422da499b9a7e125?context=explore

https://hub.docker.com/u/heroku

Apparently, the `build` is supposed to fail. Oh yeah. I just realized that the
scripts I created for `detect` and `build` are exiting with status code / exit
code 1 which means unsuccessful!

Next
https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/detection/


